# מדריך מקוצר לדשבורד ה‑RL (בפשטות)

המסך המרכזי כולל כמה כרטיסיות (Cards). כל כרטיס מייצג פעולה בתהליך: הכנת נתונים, סימולציה, אימון PPO, הערכה, Walk‑Forward, ותצוגת Live/Paper. להלן הסבר קצר וברור על כל חלק, מה עושים בו ובאיזה סדר מומלץ לעבוד.

---

## 1) Data Ensure — הורדת נתונים והכנתם
מטרה: לוודא שלכל הסמלים יש נתוני מחירים נקיים ומעודכנים (OHLCV), ושמורים תחת `stock_data/<SYMBOL>/`.

איך משתמשים:
- Symbols: רשימת סמלים מופרדים בפסיק, למשל: `QQQ,MBLY,TNA`.
- Start/End: טווח התאריכים להורדת הנתונים (אופציונלי; אפשר להשאיר ריק כדי למשוך את כל הזמינות).
- Advanced indicator params: פרמטרים אופציונליים לחישוב אינדיקטורים (RSI/MACD/ATR/BB/SMA/EMA/ADX וכו'). אם לא בטוחים — השאירו ריק, יש ברירות מחדל סבירות.
- לחצו Ensure. תראו סטטוס ולוגים. בסיום, יהיו קבצי CSV לכל סמל עם עמודת Close תקינה ואינדיקטורים.

למה זה חשוב: כל שלב אחר (סימולציה/אימון/הערכה) נשען על נתונים מקומיים אלו. אם חסר — יהיו שגיאות.

---

## 2) Quick Simulation — סימולציה מהירה (לנייר יחיד)
מטרה: לראות במהירות איך אסטרטגיה פשוטה מתנהגת על נייר ספציפי.

איך משתמשים:
- Symbol: נייר אחד (למשל AAPL).
- Days או Start/End: לבחור טווח. אם מילאתם Start/End זה גובר על Days.
- Window: גודל חלון התצפית (ימים) לאינדיקטורים וגרף.
- Policy: אסטרטגיה פשוטה לבחירה:
  - buy_and_hold — קנה והחזק
  - half_long — מחזיק חצי פוזיציה קבועה
  - follow_trend — כלל מגמה פשוט (למשל לפי ממוצעים נעים)
- אפשר לבחור סוג גרף (Line/Candlestick) ולהדליק אינדיקטורים (SMA/EMA/MACD/Volume).
- התוצאה: גרף מחיר + Equity, טבלת החלטות אחרונות, ומדדים: Final Equity, Total Return, Max Drawdown, Sharpe (בערך), Coverage.

מתי להשתמש: לבדוק מהר איכות נתונים או התנהגות כללית לפני אימון RL.

---

## 3) Train PPO (SB3) — אימון סוכן תיק (Multi-Asset)
מטרה: לאמן מודל PPO של Stable‑Baselines3 שמחלק משקולות בין כמה סמלים.

איך משתמשים:
- Symbols: לפחות שני סמלים (למשל `QQQ,MBLY,TNA`).
- Window: ברירת מחדל 60 — חשוב לשמור עקביות גם בשלב ההערכה.
- Start/End: טווח לאימון (למשל 2020‑01‑01 עד 2023‑12‑31).
- Timesteps: כמה צעדי אימון (למשל 200,000). יותר צעדים = יותר זמן.
- Plan: ממלא אוטומטית טווחים וחלון על בסיס הנתונים המקומיים.
- Train PPO: מפעיל אימון ברקע. הלוגים יוצגו בכרטיס, ובסוף ייווצר קובץ מודל ב‑`rl/models/ppo_portfolio/`.

טיפים חשובים:
- עקביות סמלים: המודל מסומן בשם עם רשימת הסמלים. בהערכה נטען מודל שמתאים בדיוק לאותה רשימת סמלים.
- חדשות (אופציונלי): אם השתמשתם בפיצ'רי חדשות בזמן אימון, דאגו להעביר אותם גם בהערכה (המערכת תנסה להתאים אוטומטית אם יש קובץ `ml/data/news_features.csv`).

---

## 4) Portfolio — Evaluate (דוח ביצועים לטווח קבוע)
מטרה: להריץ דוח ביצועים מפורט לשנה מסוימת (למשל 2024) מול קווי בסיס.

איך משתמשים:
- Symbols: חייבים להתאים למודל שאומן (אותה רשימה בדיוק).
- Eval Start/Eval End: טווח ההערכה.
- Run Report: מריץ ברקע ויוצר תיקייה עם קבצים תחת `reports/rl/...`:
  - summary.csv — סיכום מספרי לכל סדרה (PPO, EW, QQQ BH וכו').
  - equity_*.csv / equity_*.png — עקומות equity לכל סדרה.

מה בפנים:
- PPO Portfolio — תוצאת המודל כפי שהוא.
- Equal‑Weight (יומי/שבועי) — קווי בסיס להשוואה.
- QQQ Buy‑and‑Hold — קו בסיס נוסף.
- Sharpe יחושב גם מול ריבית חסרת סיכון אם קיימת בספרייה (`^IRX`).

פתרון בעיות נפוצות:
- “Observation shape mismatch” — סימן שתצורת הפיצ'רים (למשל חדשות/חלון) לא תואמת את האימון. המערכת תנסה ליישר לבד; אם לא מצליח, התאימו את ההגדרות/אימנו מחדש.
- “No model found matching symbols” — צריך לאמן מודל בדיוק לאותה רשימת סמלים.

---

## 5) Walk‑forward Evaluation — בדיקה חוצה חלונות זמן
מטרה: לפצל את טווח הזמן לכמה חלונות משנה (Segments), ולהעריך בכל חלון בנפרד. כך רואים יציבות לאורך זמן.

איך משתמשים:
- Symbols, Start, End — טווח כולל.
- Segments — כמה חלונות לחלק (למשל 4).
- Band & Min Days (אופציונלי) — רצועת No‑Trade בזמן הערכה כדי להפחית מסחר קטן ותדירות עסקאות.
- Run Walk‑forward: ירוץ ברקע וייצר תיקייה עם summary.csv וקבצי equity לכל חלון.

איך מפרשים:
- הסתכלו על התוצאות לכל חלון: תשואה, MDD, Sharpe, CAGR. יציבות בין החלונות היא סימן טוב.

---

## 6) Live (Paper) — Preview
מטרה: לראות את משקולות התיק כיום לפי המודל האחרון (או לפי נתיב שתבחרו), לפני מעבר ל‑Paper.

איך משתמשים:
- Symbols: רשימת סמלים כמו באימון.
- Model: ניתן ללחוץ "Use Latest" כדי לבחור את המודל האחרון שנשמר.
- Band & Min Days: רצועת No‑Trade ומינימום ימים בין התאמות.
- Preview: מציג תאריך ומשקולות Raw ולפי Band.

---

## 7) Live (Paper) — מצב ריצה מדומה יומית
מטרה: להריץ הקצאות יומיות אוטומטיות (ללא מסחר אמיתי), לשמור מצב ולהציג סטטוס, פוזיציות ולוגים.

איך משתמשים:
- Symbols + Model (או Use Latest).
- Start Cash: הון התחלתי (למשל 10,000).
- TC bps / Slip bps: עלויות מסחר/החלקה פשוטות (ברירת מחדל 5/5 = 0.05% כל אחד).
- Window: חשוב ליישר לרוחב חלון האימון (למשל 60).
- Max Turnover %, Max DD %: מגבלות ניהול סיכונים בתצוגת paper.
- Resume: להמשיך מהריצה האחרונה.
- Time + TZ: שעה ואזור זמן להרצה יומית.
- Start Paper / Stop: הפעלה/עצירה, תראו סטטוס, פוזיציות, PnL ולוגים בכרטיס.

הערות:
- מודל, סמלים וחלון חייבים להיות עקביים כדי למנוע שגיאות.

---

## 8) News Export (T−1)
מטרה: לייצא פיצ'רי חדשות צפויות לשימוש באימון/הערכה, תוך הקפדה שאין דליפת מידע (Strict T−1).

איך משתמשים:
- Symbols, Start, End — טווח איסוף חדשות.
- Refresh — לאלץ רענון.
- Export — יווצר קובץ `ml/data/news_features.csv` עם עמודות מהסוג: `news_count,llm_relevant_count,avg_score,fda_count,china_count,geopolitics_count,sentiment_avg`.
- בזמן אימון/הערכה, המערכת יכולה לצרף פיצ'רים אלו לתצפית.

טיפ: אם המודל אומן עם חדשות — דאגו להעביר אותן גם בהערכה, אחרת ייתכן פער בממדי התצפית.

---

## סדר עבודה מומלץ (צעד‑אחר‑צעד)
1. Data Ensure — ודאו שיש נתונים לכל הסמלים בטווח הרלוונטי.
2. News Export (אופציונלי) — אם רוצים לשלב חדשות T−1.
3. Train PPO — אימון על טווח היסטורי. מומלץ להתחיל עם Window=60 ו‑Timesteps בינוני (100k–300k).
4. Portfolio Evaluate — בדיקה על 2024 (או כל שנה). ודאו שהמודל שנבחר תואם סמלים ופיצ'רים.
5. Walk‑forward — פיצול לטווחים לראות יציבות לאורך זמן.
6. Live (Paper) Preview — בדיקת משקולות עדכניות.
7. Live (Paper) Mode — הרצה יומית מדומה עם הגנות בסיסיות.

---

## שאלות נפוצות (FAQ)
- למה ההערכה נכשלת עם "Observation shape mismatch"?
  - כי המודל מצפה לפיצ'רים (למשל חדשות) או חלון שונה. ודאו שההערכה משתמשת באותם `window`, `news_cols`, `news_window` כמו באימון. המערכת מנסה לתקן אוטומטית בעזרת ברירות מחדל, אבל לפעמים צריך להתאים ידנית.

- איך לבחור מודל תואם?
  - בהערכה נטען מודל ששם הקובץ שלו מכיל את רשימת הסמלים המדויקת (למשל `ppo_portfolio_QQQ-MBLY-TNA_...zip`). אם אין — אימנו מודל חדש.

- איפה נמצאים הדוחות?
  - תחת `reports/rl/...` תמצאו `summary.csv` ו‑`equity_*.csv/png`.

- עלויות ברוקר (IBKR) ו‑VIX
  - המנוע תומך בקומיסיות IBKR ובפיצ'ר VIX כקלט חיצוני באימון/הערכה (מוגדרים בסקריפטים). בממשק הדשבורד נשמרנו על פשטות ולכן מוצג מודל עלויות בסיסי (bps) בלבד.

---

## טיפים אחרונים
- עקביות היא הכול: סמלים, חלון, ופיצ'רים (חדשות/VIX) צריכים להיות זהים בין אימון להערכה/Live.
- אם יש שגיאה — הסתכלו בלוגים בכרטיס המתאים; נכתב מלל ברור שמסביר מה חסר.
- התחילו קטן (מספר סמלים קטן, Timesteps בינוני), בדקו שהכול עובד, ואז הרחיבו.
