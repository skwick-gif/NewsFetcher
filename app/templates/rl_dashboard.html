<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RL Dashboard</title>
  <style>
    body { background:#0b1220; color:#e2e8f0; font-family: Inter, system-ui; margin:0; }
    .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
    .card { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:16px; }
    .row > .card { flex:1; }
    .title { margin:0 0 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="title">RL Agent (Paper) — Preview</h2>
    <div class="card">
      <h3>Data Ensure</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Symbols</label>
        <input id="ens-syms" placeholder="e.g. QQQ,MBLY,TNA" style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Start</label>
        <input id="ens-start" type="date" value="2020-01-01" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>End</label>
        <input id="ens-end" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="ensureData()" style="background:#22c55e; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Ensure</button>
      </div>
      <details style="margin-top:8px;">
        <summary style="cursor:pointer; opacity:0.9;">Advanced indicator params (optional)</summary>
        <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:8px; margin-top:8px;">
          <label style="display:flex; flex-direction:column; gap:4px;">RSI Period<input id="ip-rsi" type="number" min="1" placeholder="14" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">MACD Fast<input id="ip-macd-fast" type="number" min="1" placeholder="12" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">MACD Slow<input id="ip-macd-slow" type="number" min="1" placeholder="26" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">MACD Signal<input id="ip-macd-signal" type="number" min="1" placeholder="9" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">ATR Period<input id="ip-atr" type="number" min="1" placeholder="14" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">BB Period<input id="ip-bb-p" type="number" min="1" placeholder="20" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">BB Std K<input id="ip-bb-k" type="number" step="0.1" min="0.1" placeholder="2.0" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">SMA Short<input id="ip-sma-short" type="number" min="1" placeholder="20" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">SMA Mid<input id="ip-sma-mid" type="number" min="1" placeholder="50" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">SMA Long<input id="ip-sma-long" type="number" min="1" placeholder="200" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">EMA Main<input id="ip-ema" type="number" min="1" placeholder="50" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">ROC Period<input id="ip-roc" type="number" min="1" placeholder="20" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">Vol Period<input id="ip-vol" type="number" min="1" placeholder="20" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">Volume MA<input id="ip-volma" type="number" min="1" placeholder="20" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">ADX Period<input id="ip-adx" type="number" min="1" placeholder="14" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">KAMA N<input id="ip-kama-n" type="number" min="1" placeholder="10" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">KAMA Fast<input id="ip-kama-fast" type="number" min="1" placeholder="2" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">KAMA Slow<input id="ip-kama-slow" type="number" min="1" placeholder="30" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">Stoch %K<input id="ip-stoch-k" type="number" min="1" placeholder="14" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
          <label style="display:flex; flex-direction:column; gap:4px;">Stoch %D<input id="ip-stoch-d" type="number" min="1" placeholder="3" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;"></label>
        </div>
      </details>
      <div id="ens-status" style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace;"></div>
      <pre id="ens-logs" style="max-height:180px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
    </div>
    <div class="card">
      <h3>Quick Simulation</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
  <label>Symbol</label>
  <input id="rl-sym" placeholder="ENTER SYMBOL" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
  <label>Days</label>
  <input id="rl-days" type="number" value="250" style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
  <label>Start</label>
  <input id="rl-start" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
  <label>End</label>
  <input id="rl-end" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
  <label>Window</label>
  <input id="rl-window" type="number" value="60" style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
  <label>Policy</label>
        <select id="rl-policy" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
          <option value="follow_trend">follow_trend</option>
          <option value="buy_and_hold">buy_and_hold</option>
          <option value="half_long">half_long</option>
        </select>
        <button onclick="planRLSim()" title="Auto-plan dates/window/days from local data" style="background:#059669; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Plan</button>
        <button onclick="planAndRunRLSim()" title="Plan then Run simulation" style="background:#16a34a; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Plan & Run</button>
        <button onclick="runRLSim()" style="background:#3b82f6; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Run</button>
      </div>
      <div id="rl-plan-status" style="margin-top:6px; font-size:12px; color:#cbd5e1; display:none;"></div>
      <div style="margin-top:8px;">
        <canvas id="rl-chart" width="980" height="300" style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:8px;"></canvas>
        <div id="rl-tip" style="position:absolute; display:none; pointer-events:none; background:rgba(17,24,39,0.95); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:8px 10px; border-radius:6px; font-size:12px; white-space:nowrap; z-index:10;"></div>
      </div>
      <div style="margin-top:6px; display:flex; gap:12px; align-items:center;">
  <span style="opacity:0.85;">Chart Type:</span>
  <label><input type="radio" name="rl-chart-type" id="rl-chart-type-line" value="line"> Line</label>
  <label><input type="radio" name="rl-chart-type" id="rl-chart-type-candle" value="candlestick" checked> Candlestick</label>
      </div>
      <div style="margin-top:6px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <span style="opacity:0.85;">Indicators:</span>
        <label><input type="checkbox" id="ind-sma20"> SMA 20</label>
        <label><input type="checkbox" id="ind-ema50"> EMA 50</label>
        <label><input type="checkbox" id="ind-vol"> Volume</label>
        <label><input type="checkbox" id="ind-macd"> MACD</label>
      </div>
      <div style="margin-top:6px;">
        <canvas id="rl-macd" width="980" height="120" style="display:none; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:8px;"></canvas>
      </div>
      <div style="margin-top:6px;">
        <canvas id="rl-vol" width="980" height="100" style="display:none; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:8px;"></canvas>
      </div>
      <div id="rl-metrics" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:10px; margin-top:10px;">
        <div class="card"><div>Final Equity</div><strong id="m-final">—</strong></div>
        <div class="card"><div>Total Return</div><strong id="m-ret">—</strong></div>
        <div class="card"><div>Max Drawdown</div><strong id="m-dd">—</strong></div>
        <div class="card"><div>Sharpe (approx)</div><strong id="m-sharpe">—</strong></div>
        <div class="card"><div>Coverage</div><strong id="m-cov">—</strong></div>
      </div>
      <div class="card" style="margin-top:10px;">
        <h4>Decisions</h4>
        <div style="margin-bottom:8px; display:flex; gap:12px; align-items:center;">
          <span style="opacity:0.8;">Show Horizons:</span>
          <label><input type="checkbox" id="h-1d" /> 1d</label>
          <label><input type="checkbox" id="h-7d" checked /> 7d</label>
          <label><input type="checkbox" id="h-30d" /> 30d</label>
        </div>
        <div id="rl-decisions-table" style="max-height:220px; overflow:auto; font-size:0.9em;"></div>
      </div>
    </div>
    <div class="row">
      <div class="card">
        <h3>Status</h3>
        <div id="rl-status">Idle</div>
      </div>
      <div class="card">
        <h3>Positions</h3>
        <div id="rl-positions">—</div>
      </div>
      <div class="card">
        <h3>PnL</h3>
        <div id="rl-pnl">—</div>
      </div>
    </div>
    <div class="card">
      <h3>Train PPO (SB3)</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Symbols</label>
        <input id="ppo-syms" placeholder="e.g. QQQ,MBLY,TNA or single like RGTI" style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Window</label>
        <input id="ppo-window" type="number" value="60" style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Start</label>
        <input id="ppo-start" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>End</label>
        <input id="ppo-end" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Timesteps</label>
        <input id="ppo-steps" type="number" value="100000" style="width:120px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="planPPO()" title="Auto-plan dates/window/steps from local data" style="background:#059669; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Plan</button>
        <button onclick="planAndTrainPPO()" title="Plan then Train" style="background:#0ea5e9; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Plan & Train</button>
        <button onclick="startPPO()" style="background:#8b5cf6; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Train PPO</button>
      </div>
      <div id="ppo-plan-card" style="display:none; margin-top:8px; background: rgba(255,255,255,0.03); border:1px dashed rgba(255,255,255,0.12); padding:8px; border-radius:6px; font-size:12px; color:#cbd5e1;"></div>
      <div id="ppo-status" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
      <pre id="ppo-logs" style="max-height:200px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
    </div>
    <div class="card">
      <h3>Portfolio — Evaluate (2024)</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Symbols</label>
        <input id="pf-syms" placeholder="QQQ,MBLY,TNA" value="QQQ,MBLY,TNA" style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Eval Start</label>
        <input id="pf-start" type="date" value="2024-01-01" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Eval End</label>
        <input id="pf-end" type="date" value="2024-12-31" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="startPortfolioEval()" style="background:#22c55e; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Run Report</button>
      </div>
      <div id="pf-status" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
      <pre id="pf-logs" style="max-height:200px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
      <div id="pf-summary" style="margin-top:10px;"></div>
    </div>
    <div class="card">
      <h3>Walk-forward Evaluation</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Symbols</label>
        <input id="wf-syms" placeholder="QQQ,MBLY,TNA" value="QQQ,MBLY,TNA" style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Start</label>
        <input id="wf-start" type="date" value="2021-01-01" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>End</label>
        <input id="wf-end" type="date" value="2024-12-31" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Segments</label>
        <input id="wf-seg" type="number" value="4" style="width:90px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Band</label>
        <input id="wf-band" type="number" step="0.01" value="0.05" style="width:90px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Min Days</label>
        <input id="wf-min-days" type="number" value="5" style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="startWalkForward()" style="background:#22c55e; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Run Walk-forward</button>
      </div>
      <div id="wf-status" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
      <pre id="wf-logs" style="max-height:200px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
      <div id="wf-summary" style="margin-top:10px;"></div>
    </div>
    <div class="card">
      <h3>Live (Paper) — Preview</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
   <label title="רשימת ניירות (מופרדים בפסיק) לתצוגה מקדימה של משקולות. משפיע על היקף התיק. מומלץ להשתמש באותם סמלים כמו באימון/Ensure.">Symbols</label>
   <input id="live-syms" placeholder="QQQ,MBLY,TNA or single like RGTI" value="QQQ,MBLY,TNA" title="דוגמה: QQQ,MBLY,TNA — סמלים שיהוו את התיק לתצוגה."
     style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="נתיב למודל PPO לשימוש בתצוגה. משפיע על האסטרטגיה והמשקולות. אם לא בטוחים — לחצו Use Latest.">Model</label>
   <input id="live-model" placeholder="path/to/model.zip (or Use Latest)" title="השאירו ריק ולחצו Use Latest כדי לקחת את המודל האחרון שנשמר."
     style="min-width:320px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="liveUseLatest()" style="background:#64748b; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Use Latest</button>
   <label title="No-Trade Band — רצועה שמונעת עסקאות קטנות ומייצבת את המשקולות. ערך מומלץ: 0.05 (5%).">Band</label>
   <input id="live-band" type="number" step="0.01" value="0.05" title="ערך מומלץ: 0.05 (5%). ערכים גבוהים יותר יקטינו תדירות מסחר."
     style="width:90px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="מספר ימי מינימום בין שינויים עקב ה-Band. מפחית תדירות עסקאות. מומלץ: 5.">Min Days</label>
   <input id="live-min-days" type="number" value="5" title="מומלץ: 5. העלאה תקטין תדירות התאמות."
     style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="livePreview()" style="background:#22c55e; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Preview</button>
      </div>
      <div id="live-out" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
    </div>
    <div class="card">
      <h3>Live (Paper) — Mode</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
   <label title="רשימת ניירות (מופרדים בפסיק) למסחר Paper. מומלץ להשתמש באותם סמלים שאומנו/Ensure.">Symbols</label>
   <input id="paper-syms" placeholder="QQQ,MBLY,TNA or single like RGTI" value="QQQ,MBLY,TNA" title="דוגמה: QQQ,MBLY,TNA — תמהיל התיק בפייפר."
     style="min-width:300px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="קובץ מודל PPO להפעלה. משפיע על החלטות הקצאה. אם לא בטוחים — השתמשו ב-Use Latest.">Model</label>
   <input id="paper-model" placeholder="path/to/model.zip (or Use Latest)" title="השאירו ריק ולחצו Use Latest כדי לבחור את המודל האחרון."
     style="min-width:320px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="paperUseLatest()" style="background:#64748b; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Use Latest</button>
   <label title="הון התחלתי לתיק בפייפר. משפיע על גודל פוזיציות ועל PnL בכסף. מומלץ: 10,000 (או בהתאם לגודל חשבון טיפוסי).">Start Cash</label>
   <input id="paper-cash" type="number" value="10000" title="מומלץ: 10,000."
     style="width:120px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="No-Trade Band — רצועה שמונעת עסקאות קטנות ומייצבת את המשקולות. ערך מומלץ: 0.05 (5%).">Band</label>
   <input id="paper-band" type="number" step="0.01" value="0.05" title="ערך מומלץ: 0.05 (5%). קחו בחשבון טריידאוף בין תגובתיות לבין יציבות."
     style="width:90px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="מספר ימי מינימום בין שינויי הקצאה (בהקשר ה-Band). מפחית תדירות עסקאות. מומלץ: 5.">Min Days</label>
   <input id="paper-min-days" type="number" value="5" title="מומלץ: 5. העלאה תקטין עוד את התדירות.">
   <label title="Transaction Cost בבסיס נקודות (bps = 0.01%). מפחית רווחיות נטו. מומלץ: 5 (0.05%).">TC bps</label>
   <input id="paper-tc" type="number" value="5" title="מומלץ: 5 (כלומר 0.05%)." style="width:70px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="Slippage בבסיס נקודות (bps). מדמה החלקה במחיר. מומלץ: 5 (0.05%).">Slip bps</label>
   <input id="paper-slip" type="number" value="5" title="מומלץ: 5 (כלומר 0.05%)." style="width:70px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="גודל חלון התצפית (ימים) המשמש את המודל. משפיע על הפיצ'רים והתנהגות. מומלץ: 60.">Window</label>
   <input id="paper-window" type="number" value="60" title="מומלץ: 60. חשוב ליישר עם חלון האימון."
     style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="תקרת היפוך יומי (Turnover) כאחוז מההון — שומר על גבולות מסחר. מומלץ: 50%–100% בהתאם למדיניות.">Max Turnover %</label>
   <input id="paper-turnover" type="number" value="100" title="מומלץ: 100% כברירת מחדל. הקטינו אם רוצים להגביל מסחר." style="width:90px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="עצירת מצב במקרה של Drawdown מצטבר מעל הסף. ניהול סיכונים. מומלץ: 20%–30% (ברירת מחדל 25%).">Max DD %</label>
   <input id="paper-dd" type="number" value="25" title="מומלץ: 25%. הורידו לערכים מחמירים יותר לניהול סיכון הדוק."
     style="width:80px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label style="display:flex; align-items:center; gap:4px;" title="המשך מריצת Paper מהמצב האחרון השמור (positions/equity). מומלץ להשאיר מסומן.">Resume<input id="paper-resume" type="checkbox" checked></label>
   <label title="שעת ההרצה היומית (לפי אזור הזמן). מומלץ: אחרי נעילה — 16:05 America/New_York.">Time</label>
   <input id="paper-time" type="time" value="16:05" title="מומלץ: 16:05 (אחרי נעילת שוק בניו-יורק)."
     style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
   <label title="אזור הזמן להפעלה. קובע מתי התזמון יתבצע. מומלץ: America/New_York.">TZ</label>
   <input id="paper-tz" placeholder="America/New_York" value="America/New_York" title="מומלץ: America/New_York."
     style="min-width:170px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <button onclick="paperStart()" style="background:#22c55e; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Start Paper</button>
        <button onclick="paperStop()" style="background:#ef4444; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Stop</button>
      </div>
      <div class="row">
        <div class="card">
          <h4>Status</h4>
          <div id="paper-status">—</div>
        </div>
        <div class="card">
          <h4>Positions</h4>
          <div id="paper-positions">—</div>
        </div>
        <div class="card">
          <h4>PnL</h4>
          <div id="paper-pnl">—</div>
        </div>
      </div>
      <pre id="paper-logs" style="max-height:200px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
    </div>
    <div class="card">
      <h3>Recent Decisions</h3>
      <div id="rl-decisions">—</div>
    </div>
    <div class="card">
      <h3>News Export (T−1)</h3>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Symbols</label>
        <input id="news-syms" placeholder="e.g. SPY,QQQ,MBLY,..." style="min-width:320px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>Start</label>
        <input id="news-start" type="date" value="2020-01-01" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label>End</label>
        <input id="news-end" type="date" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#e2e8f0; padding:6px 8px; border-radius:6px;">
        <label style="display:flex; align-items:center; gap:4px;">Refresh<input id="news-refresh" type="checkbox"></label>
        <button onclick="startNewsExport()" style="background:#0ea5e9; border:none; padding:8px 12px; border-radius:6px; color:white; cursor:pointer;">Export</button>
      </div>
      <div id="news-status" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
      <pre id="news-logs" style="max-height:200px; overflow:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius:6px; font-size:12px;"></pre>
    </div>
  </div>
  <script src="/static/js/rl.js"></script>
  <script>
    let _lastDecisions = [];
    let _lastIndicators = null;
    let _hoverIndex = null;
  async function runRLSim(){
      const sym = (document.getElementById('rl-sym').value || 'AAPL').toUpperCase();
    const days = parseInt(document.getElementById('rl-days').value || '250', 10);
    const policy = document.getElementById('rl-policy').value;
    const windowSize = parseInt(document.getElementById('rl-window').value || '60', 10);
    const sd = (document.getElementById('rl-start').value || '').trim();
    const ed = (document.getElementById('rl-end').value || '').trim();
    const params = new URLSearchParams({ symbol: sym, window: String(windowSize), policy });
    if (sd && ed) { params.set('start_date', sd); params.set('end_date', ed); }
    else { params.set('days', String(days)); }
    try {
      const r = await fetch(`/api/rl/simulate?${params.toString()}`);
      if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
      const j = await r.json();
      if(j.status !== 'success'){ alert(j.message || 'Simulation failed'); return; }
  window._lastSimData = j.data;
  _lastIndicators = computeIndicators(j.data);
  drawRL(j.data, _hoverIndex);
  const macdOn = document.getElementById('ind-macd')?.checked;
  const macEl = document.getElementById('rl-macd');
  if(macEl){ macEl.style.display = macdOn? 'block' : 'none'; }
  if(macdOn){ drawMACD(j.data, _hoverIndex); }
  const volOn = document.getElementById('ind-vol')?.checked;
  const volEl = document.getElementById('rl-vol');
  if(volEl){ volEl.style.display = volOn? 'block' : 'none'; }
  if(volOn){ drawVolume(j.data, _hoverIndex); }
      fillRLMetrics(j.data.metrics || {});
      _lastDecisions = j.data.decisions || [];
      renderRLDecisions(_lastDecisions);
    } catch(err){
      console.error('runRLSim failed', err);
      alert('Simulation failed. See console for details.');
    }
  }
    async function planRLSim(){
      const sym = (document.getElementById('rl-sym').value || 'AAPL').toUpperCase();
      try{
        const r = await fetch(`/api/rl/simulate/plan?symbol=${encodeURIComponent(sym)}`);
        const j = await r.json();
        if(j.status !== 'planned'){ alert(j.detail || 'Planning failed'); return; }
        const p = j.plan || {};
        if(p.start_date) document.getElementById('rl-start').value = p.start_date;
        if(p.end_date) document.getElementById('rl-end').value = p.end_date;
        if(Number.isFinite(p.window)) document.getElementById('rl-window').value = String(p.window);
        if(Number.isFinite(p.days)) document.getElementById('rl-days').value = String(p.days);
        const s = document.getElementById('rl-plan-status');
        if(s){
          s.style.display = 'block';
          s.textContent = `Planned ${sym}: ${p.start_date} → ${p.end_date} | window=${p.window}, days=${p.days} (rows=${p.total_rows})`;
        }
        return p;
      }catch(err){
        console.error('planRLSim failed', err);
        alert('Plan failed. See console for details.');
      }
    }
    async function planAndRunRLSim(){
      const p = await planRLSim();
      if(p){ await runRLSim(); }
    }
    
  function drawRLLine(data, hoverIndex){
      const c = document.getElementById('rl-chart');
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      const W=c.width,H=c.height, pad=30;
      // Normalize price and equity to [0,1] for simple overlay
      const prices = data.prices, equities = data.equities;
      const labels = Array.isArray(data.labels) ? data.labels : null;
      const minP = Math.min(...prices), maxP = Math.max(...prices);
      const minE = Math.min(...equities), maxE = Math.max(...equities);
      const n = prices.length;
      function x(i){ return pad + (W-2*pad) * (i/(Math.max(1,n-1))); }
      function y(norm){ return H - pad - (H-2*pad)*norm; }
      function norm(v, lo, hi){ return (hi<=lo)?0.5: (v-lo)/(hi-lo); }
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.strokeRect(pad, pad, W-2*pad, H-2*pad);

      // axes ticks and labels (X dates, Y prices)
      ctx.fillStyle = 'rgba(226,232,240,0.85)';
      ctx.font='11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
      // Y ticks (prices)
      const yTicks = 5;
      for(let k=0;k<=yTicks;k++){
        const frac = k/yTicks;
        const val = minP + (maxP-minP)*frac;
        const yy = y(frac);
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy); ctx.stroke();
        ctx.fillStyle = 'rgba(226,232,240,0.7)';
        const txt = `$${val.toFixed(2)}`;
        ctx.fillText(txt, 4, Math.max(pad+10, Math.min(H-pad-2, yy-2)));
      }
      // X ticks (dates)
      const xTicks = Math.min(8, Math.max(2, Math.floor(W/140)));
      const getLabelAt = (i)=>{
        if(labels && labels[i]) return labels[i];
        const o = (data.ohlc||[])[i];
        if(o && o.t){
          try{ const d = new Date(o.t); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }catch{return String(i);} }
        return String(i);
      };
      for(let k=0;k<xTicks;k++){
        const idx = Math.round((k/(xTicks-1))*(n-1));
        const xx = x(idx);
        ctx.strokeStyle = 'rgba(255,255,255,0.12)';
        ctx.beginPath(); ctx.moveTo(xx, H-pad); ctx.lineTo(xx, H-pad+4); ctx.stroke();
        const lab = getLabelAt(idx);
        ctx.fillStyle = 'rgba(226,232,240,0.7)';
        ctx.textAlign = 'center';
        ctx.fillText(lab, xx, H-6);
      }
      // price line (yellow)
      ctx.beginPath(); ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 1.5;
      for(let i=0;i<n;i++){
        const nx = x(i), ny = y(norm(prices[i],minP,maxP));
        if(i===0) ctx.moveTo(nx,ny); else ctx.lineTo(nx,ny);
      }
      ctx.stroke();
      // equity line (green)
      ctx.beginPath(); ctx.strokeStyle = '#10b981'; ctx.lineWidth = 1.5;
      for(let i=0;i<n;i++){
        const nx = x(i), ny = y(norm(equities[i],minE,maxE));
        if(i===0) ctx.moveTo(nx,ny); else ctx.lineTo(nx,ny);
      }
      ctx.stroke();
      // actions (markers)
      const acts = data.actions || [];
      for(let i=0;i<acts.length;i++){
        const a = acts[i];
        if(a===0||a===1||a===2){
          const nx = x(i), ny = y(norm(prices[i],minP,maxP));
          ctx.fillStyle = a===2? '#22c55e' : a===1? '#60a5fa' : '#ef4444';
          ctx.fillRect(nx-1, ny-1, 2, 2);
        }
      }
      // overlays (SMA/EMA on price scale)
      drawOverlays({ ctx, W, H, pad, n, x, yPrice:(v)=> H - pad - (H-2*pad)*((v-minP)/((maxP-minP)||1)), seriesType:'line' });
      // hover crosshair
      if(typeof hoverIndex === 'number' && hoverIndex>=0 && hoverIndex<n){
        const xi = x(hoverIndex);
        ctx.strokeStyle = 'rgba(148,163,184,0.6)';
        ctx.beginPath(); ctx.moveTo(xi, pad); ctx.lineTo(xi, H-pad); ctx.stroke();
      }
      // legend
      ctx.fillStyle = '#e2e8f0'; ctx.font='12px system-ui';
      ctx.fillText('Price', pad+6, pad+14);
      ctx.fillStyle = '#ffd700'; ctx.fillRect(pad-2, pad+6, 4, 4);
      ctx.fillStyle = '#e2e8f0'; ctx.fillText('Equity', pad+60, pad+14);
      ctx.fillStyle = '#10b981'; ctx.fillRect(pad+50, pad+6, 4, 4);
    }
  function drawRLCandles(data, hoverIndex){
      const c = document.getElementById('rl-chart');
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      const W=c.width,H=c.height, pad=30;
      const prices = data.prices || [];
      const equities = data.equities || [];
      const candles = data.ohlc || [];
      const labels = Array.isArray(data.labels) ? data.labels : null;
      const n = Math.max(prices.length, candles.length);
      if(n===0){ return; }
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.strokeRect(pad, pad, W-2*pad, H-2*pad);
      // ranges
      let minP=Infinity, maxP=-Infinity;
      for(let i=0;i<candles.length;i++){
        const cd = candles[i];
        if(cd && typeof cd.h==='number' && typeof cd.l==='number'){
          minP=Math.min(minP, cd.l); maxP=Math.max(maxP, cd.h);
        }
      }
      if(!isFinite(minP) || !isFinite(maxP)){
        // fallback to line if no ohlc
        return drawRLLine(data, hoverIndex);
      }
      const minE = Math.min(...equities), maxE = Math.max(...equities);
      function x(i){ return pad + (W-2*pad) * (i/(Math.max(1,n-1))); }
      function yv(v, lo, hi){ if(!(hi>lo)) return H/2; return H - pad - (H-2*pad)*((v-lo)/(hi-lo)); }

      // axes ticks and labels (Y price, X dates)
      ctx.fillStyle = 'rgba(226,232,240,0.85)';
      ctx.font='11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
      // Y ticks
      const yTicks2 = 5;
      for(let k=0;k<=yTicks2;k++){
        const frac = k/yTicks2;
        const val = minP + (maxP-minP)*frac;
        const yy = yv(val, minP, maxP);
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy); ctx.stroke();
        ctx.fillStyle = 'rgba(226,232,240,0.7)';
        ctx.fillText(`$${val.toFixed(2)}`, 4, Math.max(pad+10, Math.min(H-pad-2, yy-2)));
      }
      // X ticks
      const xTicks2 = Math.min(8, Math.max(2, Math.floor(W/140)));
      const getLabelAt2 = (i)=>{
        if(labels && labels[i]) return labels[i];
        const o = (data.ohlc||[])[i];
        if(o && o.t){
          try{ const d = new Date(o.t); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }catch{return String(i);} }
        return String(i);
      };
      for(let k=0;k<xTicks2;k++){
        const idx = Math.round((k/(xTicks2-1))*(n-1));
        const xx = x(idx);
        ctx.strokeStyle = 'rgba(255,255,255,0.12)';
        ctx.beginPath(); ctx.moveTo(xx, H-pad); ctx.lineTo(xx, H-pad+4); ctx.stroke();
        const lab = getLabelAt2(idx);
        ctx.fillStyle = 'rgba(226,232,240,0.7)';
        ctx.textAlign = 'center';
        ctx.fillText(lab, xx, H-6);
      }
      // draw candles
      const bodyW = Math.max(2, Math.floor((W-2*pad)/Math.max(20,n)) - 1);
      for(let i=0;i<candles.length;i++){
        const cd = candles[i]; if(!cd || typeof cd.o!=='number') continue;
        const nx = x(i);
        const yH = yv(cd.h, minP, maxP);
        const yL = yv(cd.l, minP, maxP);
        const yO = yv(cd.o, minP, maxP);
        const yC = yv(cd.c, minP, maxP);
        const up = cd.c >= cd.o;
        ctx.strokeStyle = 'rgba(226,232,240,0.8)';
        // wick
        ctx.beginPath(); ctx.moveTo(nx, yH); ctx.lineTo(nx, yL); ctx.stroke();
        // body
        const top = Math.min(yO,yC), h = Math.max(1, Math.abs(yO - yC));
        ctx.fillStyle = up ? '#10b981' : '#ef4444';
        ctx.fillRect(nx - bodyW/2, top, bodyW, h);
      }
      // overlays (SMA/EMA on closes)
      drawOverlays({ ctx, W, H, pad, n, x, yPrice:(v)=> yv(v, minP, maxP), seriesType:'candle' });
      // overlay equity
      if(equities.length>1 && isFinite(minE) && isFinite(maxE)){
        ctx.beginPath(); ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1;
        for(let i=0;i<equities.length;i++){
          const nx = x(i), ny = yv(equities[i], minE, maxE);
          if(i===0) ctx.moveTo(nx,ny); else ctx.lineTo(nx,ny);
        }
        ctx.stroke();
      }
      // hover crosshair
      if(typeof hoverIndex === 'number' && hoverIndex>=0 && hoverIndex<n){
        const xi = x(hoverIndex);
        ctx.strokeStyle = 'rgba(148,163,184,0.6)';
        ctx.beginPath(); ctx.moveTo(xi, pad); ctx.lineTo(xi, H-pad); ctx.stroke();
      }
      // legend
      ctx.fillStyle = '#e2e8f0'; ctx.font='12px system-ui';
      ctx.fillText('Candles', pad+6, pad+14);
      ctx.fillStyle = '#10b981'; ctx.fillRect(pad-2, pad+6, 4, 4);
      ctx.fillStyle = '#e2e8f0'; ctx.fillText('Equity', pad+70, pad+14);
      ctx.fillStyle = '#94a3b8'; ctx.fillRect(pad+60, pad+6, 4, 4);
    }
    function drawRL(data, hoverIndex){
      const tLine = document.getElementById('rl-chart-type-line');
      const type = (tLine && tLine.checked) ? 'line' : 'candlestick';
      if(type==='candlestick') return drawRLCandles(data, hoverIndex);
      return drawRLLine(data, hoverIndex);
    }
    // toggle events (attach immediately; DOM already loaded since script is at end)
    (function attachRlChartTypeListeners(){
      const l = document.getElementById('rl-chart-type-line');
      const c = document.getElementById('rl-chart-type-candle');
  const rerender = ()=>{ if(window._lastSimData) drawRL(window._lastSimData, _hoverIndex); };
      if(l && !l._rlBound){ l.addEventListener('change', rerender); l._rlBound = true; }
      if(c && !c._rlBound){ c.addEventListener('change', rerender); c._rlBound = true; }
      // fallback: if elements not yet present, try once DOM is ready
      if(!(l && c)){
        window.addEventListener('DOMContentLoaded', attachRlChartTypeListeners, { once: true });
      }
    })();
    function fillRLMetrics(m){
      const fe = (m.final_equity!==undefined)? `$${m.final_equity.toFixed(2)}` : '—';
      const tr = (m.total_return!==undefined)? `${(m.total_return*100).toFixed(2)}%` : '—';
      const dd = (m.max_drawdown!==undefined)? `${(m.max_drawdown*100).toFixed(2)}%` : '—';
      const sh = (m.sharpe!==undefined)? `${m.sharpe.toFixed(2)}` : '—';
      document.getElementById('m-final').textContent = fe;
      document.getElementById('m-ret').textContent = tr;
      document.getElementById('m-dd').textContent = dd;
  document.getElementById('m-sharpe').textContent = sh;
  const cov = (typeof m.coverage_ratio === 'number') ? `${(m.coverage_ratio*100).toFixed(0)}%` : '—';
  const covEl = document.getElementById('m-cov'); if (covEl) covEl.textContent = cov;
    }
    function _selectedHorizons(){
      return {
        h1: document.getElementById('h-1d')?.checked ?? false,
        h7: document.getElementById('h-7d')?.checked ?? true,
        h30: document.getElementById('h-30d')?.checked ?? false,
      };
    }
    function renderRLDecisions(rows){
      const el = document.getElementById('rl-decisions-table');
      if(!rows || !rows.length){ el.textContent = '—'; return; }
      const sel = _selectedHorizons();
      const hasAny = rows.some(r => (
        (sel.h1 && (r.prog_1d_er!==undefined || r.prog_1d_conf!==undefined || r.prog_1d_sig!==undefined || r.prog_1d_sl!==undefined || r.prog_1d_tp!==undefined)) ||
        (sel.h7 && (r.prog_7d_er!==undefined || r.prog_7d_conf!==undefined || r.prog_7d_sig!==undefined || r.prog_7d_sl!==undefined || r.prog_7d_tp!==undefined)) ||
        (sel.h30 && (r.prog_30d_er!==undefined || r.prog_30d_conf!==undefined || r.prog_30d_sig!==undefined || r.prog_30d_sl!==undefined || r.prog_30d_tp!==undefined))
      ));
      let html = '<table style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr style="text-align:left;">'
            + '<th style="padding:6px;">Time</th>'
            + '<th style="padding:6px;">Action</th>'
            + '<th style="padding:6px;">Price</th>'
            + '<th style="padding:6px;">Equity</th>'
            + '<th style="padding:6px;">Pos</th>'
            + (hasAny && sel.h1 ? '<th style="padding:6px;">Prog 1d ER</th><th style="padding:6px;">Prog 1d Conf</th><th style="padding:6px;">Prog 1d Sig</th><th style="padding:6px;">Prog 1d SL</th><th style="padding:6px;">Prog 1d TP</th>' : '')
            + (hasAny && sel.h7 ? '<th style="padding:6px;">Prog 7d ER</th><th style="padding:6px;">Prog 7d Conf</th><th style="padding:6px;">Prog 7d Sig</th><th style="padding:6px;">Prog 7d SL</th><th style="padding:6px;">Prog 7d TP</th>' : '')
            + (hasAny && sel.h30 ? '<th style="padding:6px;">Prog 30d ER</th><th style="padding:6px;">Prog 30d Conf</th><th style="padding:6px;">Prog 30d Sig</th><th style="padding:6px;">Prog 30d SL</th><th style="padding:6px;">Prog 30d TP</th>' : '')
            + '</tr></thead><tbody>';
      const label = (a)=> a===2? 'FULL LONG' : a===1? 'HALF LONG' : 'FLAT';
      rows.forEach(r=>{
        const er1 = (typeof r.prog_1d_er === 'number') ? (r.prog_1d_er*100).toFixed(2)+'%' : '';
        const cf1 = (typeof r.prog_1d_conf === 'number') ? (r.prog_1d_conf*100).toFixed(0)+'%' : '';
        const sg1 = (typeof r.prog_1d_sig === 'string') ? r.prog_1d_sig : '';
        const er7 = (typeof r.prog_7d_er === 'number') ? (r.prog_7d_er*100).toFixed(2)+'%' : '';
        const cf7 = (typeof r.prog_7d_conf === 'number') ? (r.prog_7d_conf*100).toFixed(0)+'%' : '';
        const sg7 = (typeof r.prog_7d_sig === 'string') ? r.prog_7d_sig : '';
        const er30 = (typeof r.prog_30d_er === 'number') ? (r.prog_30d_er*100).toFixed(2)+'%' : '';
        const cf30 = (typeof r.prog_30d_conf === 'number') ? (r.prog_30d_conf*100).toFixed(0)+'%' : '';
        const sg30 = (typeof r.prog_30d_sig === 'string') ? r.prog_30d_sig : '';
        html += `<tr>
          <td style="padding:6px; opacity:0.8;">${r.time}</td>
          <td style="padding:6px;">${label(r.action)}</td>
          <td style="padding:6px;">$${(r.price??0).toFixed(2)}</td>
          <td style="padding:6px;">$${(r.equity??0).toFixed(2)}</td>
          <td style="padding:6px;">${(((r.position_frac??0)*100).toFixed(0))}%</td>
          ${sel.h1 && hasAny ? `<td style=\"padding:6px;\">${er1}</td><td style=\"padding:6px;\">${cf1}</td><td style=\"padding:6px;\">${sg1}</td><td style=\"padding:6px;\">${(typeof r.prog_1d_sl==='number')?('$'+r.prog_1d_sl.toFixed(2)) : ''}</td><td style=\"padding:6px;\">${(typeof r.prog_1d_tp==='number')?('$'+r.prog_1d_tp.toFixed(2)) : ''}</td>` : ''}
          ${sel.h7 && hasAny ? `<td style=\"padding:6px;\">${er7}</td><td style=\"padding:6px;\">${cf7}</td><td style=\"padding:6px;\">${sg7}</td><td style=\"padding:6px;\">${(typeof r.prog_7d_sl==='number')?('$'+r.prog_7d_sl.toFixed(2)) : ''}</td><td style=\"padding:6px;\">${(typeof r.prog_7d_tp==='number')?('$'+r.prog_7d_tp.toFixed(2)) : ''}</td>` : ''}
          ${sel.h30 && hasAny ? `<td style=\"padding:6px;\">${er30}</td><td style=\"padding:6px;\">${cf30}</td><td style=\"padding:6px;\">${sg30}</td><td style=\"padding:6px;\">${(typeof r.prog_30d_sl==='number')?('$'+r.prog_30d_sl.toFixed(2)) : ''}</td><td style=\"padding:6px;\">${(typeof r.prog_30d_tp==='number')?('$'+r.prog_30d_tp.toFixed(2)) : ''}</td>` : ''}
        </tr>`;
      });
      html += '</tbody></table>';
      el.innerHTML = html;
    }
    // re-render on horizon toggle (attach immediately, with DOMContentLoaded fallback)
    (function attachRlHorizonListeners(){
      let bound = 0;
      ['h-1d','h-7d','h-30d'].forEach(id=>{
        const el = document.getElementById(id);
        if(el && !el._rlBound){ el.addEventListener('change', ()=> renderRLDecisions(_lastDecisions)); el._rlBound = true; bound++; }
      });
      if(bound === 0){
        window.addEventListener('DOMContentLoaded', attachRlHorizonListeners, { once: true });
      }
    })();

    // PPO train UI
    let _ppoPoll = null;
    async function startPPO(){
      const symsRaw = (document.getElementById('ppo-syms').value || '').toUpperCase();
      if(!symsRaw){ alert('Please enter symbol(s)'); return; }
      const windowSize = parseInt(document.getElementById('ppo-window').value || '60', 10);
      const steps = parseInt(document.getElementById('ppo-steps').value || '100000', 10);
      const sd = (document.getElementById('ppo-start').value || '').trim();
      const ed = (document.getElementById('ppo-end').value || '').trim();
      const params = new URLSearchParams({ symbols: symsRaw, window: String(windowSize), timesteps: String(steps) });
      if(sd) params.set('start_date', sd);
      if(ed) params.set('end_date', ed);
      const resp = await fetch(`/api/rl/ppo/train?${params.toString()}`, { method: 'POST' });
      const j = await resp.json();
      if(j.status !== 'started'){ alert(j.detail || 'Failed to start PPO'); return; }
      const jobId = j.job_id;
      document.getElementById('ppo-status').textContent = `Job ${jobId} — running...`;
      if(_ppoPoll) clearInterval(_ppoPoll);
      _ppoPoll = setInterval(()=> pollPPO(jobId), 2000);
      pollPPO(jobId);
    }

    async function planPPO(){
      const symsRaw = (document.getElementById('ppo-syms').value || '').toUpperCase();
      const parts = symsRaw.split(',').map(s=>s.trim()).filter(Boolean);
      if(parts.length===0){ alert('Please enter symbol(s)'); return; }
      const winVal = parseInt(document.getElementById('ppo-window').value || '0', 10);
      const params = new URLSearchParams({ symbols: parts.join(',') });
      if(winVal>0){ params.set('window', String(winVal)); }
      try{
        const r = await fetch(`/api/rl/ppo/plan?${params.toString()}`);
        const j = await r.json();
        if(j.status !== 'planned'){ alert(j.detail || 'Planning failed'); return; }
        const p = j.plan || {};
        // Fill UI
        if(p.train_start_date){ document.getElementById('ppo-start').value = p.train_start_date; }
        if(p.train_end_date){ document.getElementById('ppo-end').value = p.train_end_date; }
        if(Number.isFinite(p.window)){ document.getElementById('ppo-window').value = String(p.window); }
        if(Number.isFinite(p.timesteps)){ document.getElementById('ppo-steps').value = String(p.timesteps); }
        // Plan card
        const card = document.getElementById('ppo-plan-card');
        if(card){
          card.style.display = 'block';
          const label = (p.symbols && Array.isArray(p.symbols)) ? p.symbols.join(',') : parts[0];
          card.textContent = `Planned ${label}: ${p.train_start_date} → ${p.train_end_date} | window=${p.window}, steps=${p.timesteps} (days=${p.training_days})`;
        }
      }catch(err){
        console.error('planPPO failed', err);
        alert('Plan failed. See console for details.');
      }
    }
    async function planAndTrainPPO(){
      const symsRaw = (document.getElementById('ppo-syms').value || '').toUpperCase();
      const parts = symsRaw.split(',').map(s=>s.trim()).filter(Boolean);
      const sym = (parts[0] || '').toUpperCase();
      if(!sym){ alert('Please enter symbol(s)'); return; }
      await planPPO();
      await startPPO();
    }
    async function pollPPO(jobId){
      try{
        const r = await fetch(`/api/rl/ppo/train/status/${jobId}`);
        if(!r.ok){ throw new Error('Status not found'); }
        const j = await r.json();
        const st = j.status || 'unknown';
        let line1 = `Job ${jobId} — ${st}`;
        if(j.model_path){ line1 += ` — model: ${j.model_path}`; }
        document.getElementById('ppo-status').textContent = line1;
        const logs = (j.logs || []).join('\n');
        document.getElementById('ppo-logs').textContent = logs;
        if(st === 'completed' || st === 'failed'){
          if(_ppoPoll){ clearInterval(_ppoPoll); _ppoPoll = null; }
        }
      }catch(e){
        // stop polling on error
        if(_ppoPoll){ clearInterval(_ppoPoll); _ppoPoll = null; }
      }
    }
    // Indicator toggles
    (function attachIndicatorListeners(){
      const ids = ['ind-sma20','ind-ema50','ind-vol','ind-macd'];
      let bound = 0;
      const rerender = ()=>{
        const macdOn = document.getElementById('ind-macd')?.checked;
        const macEl = document.getElementById('rl-macd');
        if(macEl){ macEl.style.display = macdOn? 'block' : 'none'; }
        const volOn = document.getElementById('ind-vol')?.checked;
        const volEl = document.getElementById('rl-vol');
        if(volEl){ volEl.style.display = volOn? 'block' : 'none'; }
        if(window._lastSimData){
          drawRL(window._lastSimData, _hoverIndex);
          if(macdOn){ drawMACD(window._lastSimData, _hoverIndex); }
          if(volOn){ drawVolume(window._lastSimData, _hoverIndex); }
        }
      };
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el && !el._bound){ el.addEventListener('change', rerender); el._bound = true; bound++; }
      });
      if(bound===0){ window.addEventListener('DOMContentLoaded', attachIndicatorListeners, { once:true }); }
    })();

    // Canvas hover for tooltip and crosshair
    (function attachHover(){
      const canvas = document.getElementById('rl-chart');
      const tip = document.getElementById('rl-tip');
      if(!canvas) return;
      const handlerMove = (e)=>{
        if(!window._lastSimData) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const W = canvas.width, pad = 30;
        const data = window._lastSimData;
        const n = Math.max(data.prices?.length||0, data.ohlc?.length||0);
        const frac = (x - pad) / Math.max(1, (W - 2*pad));
        let idx = Math.round(frac * (n-1));
        idx = Math.max(0, Math.min(n-1, idx));
        _hoverIndex = idx;
        // render
        drawRL(data, _hoverIndex);
        if(document.getElementById('ind-macd')?.checked){ drawMACD(data, _hoverIndex); }
        if(document.getElementById('ind-vol')?.checked){ drawVolume(data, _hoverIndex); }
        // tooltip content
        const labels = Array.isArray(data.labels) ? data.labels : null;
        const datesArr = Array.isArray(data.dates) ? data.dates : null;
        const tRaw = (data.ohlc && data.ohlc[idx] && data.ohlc[idx].t) ? data.ohlc[idx].t : null;
        let dateStr = null;
        if(tRaw){
          try{ const d = new Date(tRaw); dateStr = d.toISOString().slice(0,10); }catch{ dateStr = String(tRaw); }
        } else if(datesArr && datesArr[idx]) {
          dateStr = String(datesArr[idx]);
        } else if(labels && labels[idx]) {
          dateStr = String(labels[idx]);
        } else {
          dateStr = `#${idx}`;
        }
        const equity = (data.equities && data.equities[idx]!=null) ? data.equities[idx] : null;
        let html = `<div style=\"opacity:0.8;\">${dateStr}</div>`;
        if(data.ohlc && data.ohlc[idx]){
          const cd = data.ohlc[idx];
          html += `<div>O: $${(cd.o??0).toFixed(2)} H: $${(cd.h??0).toFixed(2)} L: $${(cd.l??0).toFixed(2)} C: $${(cd.c??0).toFixed(2)}</div>`;
          if(typeof cd.v === 'number'){
            const vol = cd.v.toLocaleString();
            html += `<div>Vol: ${vol}</div>`;
          }
        }else if(data.prices && data.prices[idx]!=null){
          html += `<div>Price: $${data.prices[idx].toFixed(2)}</div>`;
        }
        if(equity!=null){ html += `<div>Equity: $${equity.toFixed(2)}</div>`; }
        tip.innerHTML = html;
        tip.style.display = 'block';
        const pageX = e.clientX + window.scrollX;
        const pageY = e.clientY + window.scrollY;
        tip.style.left = `${pageX + 12}px`;
        tip.style.top = `${pageY + 12}px`;
      };
      const handlerLeave = ()=>{
        _hoverIndex = null;
        if(window._lastSimData) drawRL(window._lastSimData, _hoverIndex);
        if(tip) tip.style.display = 'none';
        const macdOn = document.getElementById('ind-macd')?.checked;
        if(macdOn && window._lastSimData){ drawMACD(window._lastSimData, _hoverIndex); }
        const volOn = document.getElementById('ind-vol')?.checked;
        if(volOn && window._lastSimData){ drawVolume(window._lastSimData, _hoverIndex); }
      };
      if(!canvas._hoverBound){
        canvas.addEventListener('mousemove', handlerMove);
        canvas.addEventListener('mouseleave', handlerLeave);
        canvas._hoverBound = true;
      }
    })();

    // Compute indicators once per dataset
    function computeIndicators(data){
      const closes = (data.ohlc && data.ohlc.length) ? data.ohlc.map(d=> (d&&typeof d.c==='number')? d.c : NaN) : (data.prices||[]);
      const n = closes.length;
      const sma = (period)=>{
        const out = new Array(n).fill(null);
        let sum = 0, cnt = 0;
        for(let i=0;i<n;i++){
          const v = closes[i];
          if(Number.isFinite(v)) { sum += v; cnt++; }
          if(i>=period){ const vOld = closes[i-period]; if(Number.isFinite(vOld)){ sum -= vOld; cnt--; } }
          if(i>=period-1){ out[i] = (cnt>0)? (sum/cnt) : null; }
        }
        return out;
      };
      const emaFrom = (src, period)=>{
        const out = new Array(src.length).fill(null);
        const alpha = 2/(period+1);
        let prev = null;
        for(let i=0;i<src.length;i++){
          const v = src[i];
          if(!Number.isFinite(v)) { out[i] = prev; continue; }
          prev = (prev==null)? v : (alpha*v + (1-alpha)*prev);
          out[i] = prev;
        }
        return out;
      };
      const sma20 = sma(20);
      const ema50 = emaFrom(closes, 50);
      // MACD (12,26,9)
      const ema12 = emaFrom(closes, 12);
      const ema26 = emaFrom(closes, 26);
      const macd = ema12.map((e,i)=> (e!=null && ema26[i]!=null)? (e - ema26[i]) : null);
      const signal = emaFrom(macd, 9);
      const hist = macd.map((m,i)=> (m!=null && signal[i]!=null)? (m - signal[i]) : null);
      return { sma20, ema50, macd, signal, hist };
    }

    function drawOverlays({ ctx, W, H, pad, n, x, yPrice, seriesType }){
      const useSMA = document.getElementById('ind-sma20')?.checked;
      const useEMA = document.getElementById('ind-ema50')?.checked;
      if(!_lastIndicators) return;
      if(useSMA && _lastIndicators.sma20){
        ctx.beginPath(); ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 1.2;
        let moved=false;
        for(let i=0;i<n;i++){
          const v = _lastIndicators.sma20[i]; if(!Number.isFinite(v)) continue;
          const nx = x(i), ny = yPrice(v);
          if(!moved){ ctx.moveTo(nx, ny); moved=true; } else { ctx.lineTo(nx, ny); }
        }
        ctx.stroke();
      }
      if(useEMA && _lastIndicators.ema50){
        ctx.beginPath(); ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 1.2;
        let moved=false;
        for(let i=0;i<n;i++){
          const v = _lastIndicators.ema50[i]; if(!Number.isFinite(v)) continue;
          const nx = x(i), ny = yPrice(v);
          if(!moved){ ctx.moveTo(nx, ny); moved=true; } else { ctx.lineTo(nx, ny); }
        }
        ctx.stroke();
      }
    }

    function drawMACD(data, hoverIndex){
      const macdOn = document.getElementById('ind-macd')?.checked;
      const c = document.getElementById('rl-macd');
      if(!c) return;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      if(!macdOn || !_lastIndicators) return;
      const W=c.width,H=c.height,pad=26;
      const n = Math.max(data.prices?.length||0, data.ohlc?.length||0);
      const x = (i)=> pad + (W-2*pad) * (i/(Math.max(1,n-1)));
      const mac = _lastIndicators.macd || [];
      const sig = _lastIndicators.signal || [];
      const hist = _lastIndicators.hist || [];
      // y scale
      let minY=Infinity, maxY=-Infinity;
      for(let i=0;i<n;i++){
        const a = mac[i], b = sig[i], h = hist[i];
        if(Number.isFinite(a)){ minY=Math.min(minY,a); maxY=Math.max(maxY,a); }
        if(Number.isFinite(b)){ minY=Math.min(minY,b); maxY=Math.max(maxY,b); }
        if(Number.isFinite(h)){ minY=Math.min(minY,h); maxY=Math.max(maxY,h); }
      }
      if(!isFinite(minY) || !isFinite(maxY)){ minY=-1; maxY=1; }
      const span = (maxY-minY) || 1; minY -= 0.1*span; maxY += 0.1*span;
      const y = (v)=> H - pad - (H-2*pad)*((v-minY)/(maxY-minY));
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.strokeRect(pad, pad, W-2*pad, H-2*pad);
      // zero line
      const y0 = y(0);
      ctx.strokeStyle = 'rgba(148,163,184,0.5)'; ctx.setLineDash([4,4]);
      ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(W-pad, y0); ctx.stroke(); ctx.setLineDash([]);
      // histogram bars
      const barW = Math.max(1, Math.floor((W-2*pad)/Math.max(20,n)) - 1);
      for(let i=0;i<n;i++){
        const h = hist[i]; if(!Number.isFinite(h)) continue;
        const nx = x(i);
        const yH = y(h), yZ = y(0);
        ctx.fillStyle = h>=0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)';
        const top = Math.min(yH, yZ), hh = Math.abs(yH - yZ);
        ctx.fillRect(nx - barW/2, top, barW, Math.max(1, hh));
      }
      // MACD line
      ctx.beginPath(); ctx.strokeStyle = '#eab308'; ctx.lineWidth = 1.2;
      let moved=false;
      for(let i=0;i<n;i++){
        const v = mac[i]; if(!Number.isFinite(v)) continue;
        const nx = x(i), ny = y(v);
        if(!moved){ ctx.moveTo(nx,ny); moved=true; } else { ctx.lineTo(nx,ny); }
      }
      ctx.stroke();
      // Signal line
      ctx.beginPath(); ctx.strokeStyle = '#f97316'; ctx.lineWidth = 1.2;
      moved=false;
      for(let i=0;i<n;i++){
        const v = sig[i]; if(!Number.isFinite(v)) continue;
        const nx = x(i), ny = y(v);
        if(!moved){ ctx.moveTo(nx,ny); moved=true; } else { ctx.lineTo(nx,ny); }
      }
      ctx.stroke();
      // hover crosshair
      if(typeof hoverIndex === 'number' && hoverIndex>=0 && hoverIndex<n){
        const xi = x(hoverIndex);
        ctx.strokeStyle = 'rgba(148,163,184,0.6)';
        ctx.beginPath(); ctx.moveTo(xi, pad); ctx.lineTo(xi, H-pad); ctx.stroke();
      }
    }
    function drawVolume(data, hoverIndex){
      const volOn = document.getElementById('ind-vol')?.checked;
      const c = document.getElementById('rl-vol');
      if(!c) return;
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      if(!volOn) return;
      const W=c.width,H=c.height,pad=22;
      const n = Math.max(data.prices?.length||0, data.ohlc?.length||0);
      const x = (i)=> pad + (W-2*pad) * (i/(Math.max(1,n-1)));
      const candles = data.ohlc || [];
      // volume array
      const vols = candles.map(cd => (cd && typeof cd.v==='number') ? cd.v : null);
      if(!vols.length) return;
      // y scale
      let maxV = 0; for(let i=0;i<vols.length;i++){ const v=vols[i]; if(Number.isFinite(v)) maxV=Math.max(maxV,v); }
      if(!(maxV>0)) return;
      const y = (v)=> H - pad - (H-2*pad) * (v/maxV);
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.strokeRect(pad, pad, W-2*pad, H-2*pad);
      // bars colored by up/down
      const barW = Math.max(1, Math.floor((W-2*pad)/Math.max(20,n)) - 1);
      for(let i=0;i<vols.length;i++){
        const v = vols[i]; if(!Number.isFinite(v)) continue;
        const cd = candles[i]; if(!cd) continue;
        const up = (typeof cd.c==='number' && typeof cd.o==='number') ? (cd.c >= cd.o) : false;
        const nx = x(i);
        const yV = y(v);
        ctx.fillStyle = up ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)';
        ctx.fillRect(nx - barW/2, yV, barW, Math.max(1, (H - pad) - yV));
      }
      // hover crosshair
      if(typeof hoverIndex === 'number' && hoverIndex>=0 && hoverIndex<n){
        const xi = x(hoverIndex);
        ctx.strokeStyle = 'rgba(148,163,184,0.6)';
        ctx.beginPath(); ctx.moveTo(xi, pad); ctx.lineTo(xi, H-pad); ctx.stroke();
      }
    }
    // Portfolio evaluation
    let _pfPoll = null;
    async function startPortfolioEval(){
      const syms = (document.getElementById('pf-syms').value || '').trim();
      if(!syms){ alert('Please enter symbols (comma-separated)'); return; }
      const sd = (document.getElementById('pf-start').value || '2024-01-01').trim();
      const ed = (document.getElementById('pf-end').value || '2024-12-31').trim();
      const params = new URLSearchParams({ symbols: syms, eval_start: sd, eval_end: ed });
      const resp = await fetch(`/api/rl/portfolio/evaluate?${params.toString()}`, { method: 'POST' });
      const j = await resp.json();
      if(j.status !== 'started'){ alert(j.detail || 'Failed to start report'); return; }
      const jobId = j.job_id;
      document.getElementById('pf-status').textContent = `Job ${jobId} — running...`;
      document.getElementById('pf-logs').textContent = '';
      document.getElementById('pf-summary').innerHTML = '';
      if(_pfPoll) clearInterval(_pfPoll);
      _pfPoll = setInterval(()=> pollPortfolioEval(jobId), 2000);
      pollPortfolioEval(jobId);
    }
    async function pollPortfolioEval(jobId){
      try{
        const r = await fetch(`/api/rl/portfolio/evaluate/status/${jobId}`);
        if(!r.ok) throw new Error('status not found');
        const j = await r.json();
        const st = j.status || 'unknown';
        let line1 = `Job ${jobId} — ${st}`;
        if(j.out_dir){ line1 += ` — out: ${j.out_dir}`; }
        document.getElementById('pf-status').textContent = line1;
        const logs = (j.logs || []).join('\n');
        document.getElementById('pf-logs').textContent = logs;
        if(Array.isArray(j.summary)){
          const rows = j.summary;
          let html = '<table style="width:100%; border-collapse:collapse;">\n<thead><tr>'+
            '<th style="padding:6px; text-align:left;">Label</th>'+
            '<th style="padding:6px; text-align:right;">Return</th>'+
            '<th style="padding:6px; text-align:right;">MDD</th>'+
            '<th style="padding:6px; text-align:right;">Sharpe</th>'+
            '<th style="padding:6px; text-align:right;">CAGR</th>'+
            '<th style="padding:6px; text-align:right;">Pts</th>'+
          '</tr></thead><tbody>';
          rows.forEach(r=>{
            const tr = (parseFloat(r.total_return)||0)*100;
            const dd = (parseFloat(r.max_drawdown)||0)*100;
            const sh = parseFloat(r.sharpe)||0;
            const cg = (parseFloat(r.cagr)||0)*100;
            html += `<tr>`+
              `<td style="padding:6px;">${r.label}</td>`+
              `<td style="padding:6px; text-align:right;">${tr.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${dd.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${sh.toFixed(2)}</td>`+
              `<td style="padding:6px; text-align:right;">${cg.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${r.points}</td>`+
            `</tr>`;
          });
          html += '</tbody></table>';
          document.getElementById('pf-summary').innerHTML = html;
        }
        if(st === 'completed' || st === 'failed' || st === 'error'){
          if(_pfPoll){ clearInterval(_pfPoll); _pfPoll = null; }
        }
      }catch(e){ if(_pfPoll){ clearInterval(_pfPoll); _pfPoll = null; } }
    }

    // Ensure functions are available on window for inline onclick handlers
    window.runRLSim = runRLSim;
    window.planRLSim = planRLSim;
    window.planAndRunRLSim = planAndRunRLSim;
  window.startPPO = startPPO;
  window.planPPO = planPPO;
  window.planAndTrainPPO = planAndTrainPPO;
    window.startPortfolioEval = startPortfolioEval;
    // Walk-forward JS
    let _wfPoll = null;
    async function startWalkForward(){
      const syms = (document.getElementById('wf-syms').value || '').trim();
      const sd = (document.getElementById('wf-start').value || '').trim();
      const ed = (document.getElementById('wf-end').value || '').trim();
      const seg = parseInt(document.getElementById('wf-seg').value || '4', 10);
      const band = parseFloat(document.getElementById('wf-band').value || '0');
      const minDays = parseInt(document.getElementById('wf-min-days').value || '0', 10);
      if(!syms || !sd || !ed){ alert('Please fill symbols, start, end'); return; }
      const params = new URLSearchParams({ symbols: syms, start: sd, end: ed, segments: String(seg) });
      if(band>0){ params.set('no_trade_band', String(band)); params.set('band_min_days', String(minDays)); }
      const r = await fetch(`/api/rl/portfolio/walkforward?${params.toString()}`, { method: 'POST' });
      const j = await r.json();
      if(j.status !== 'started'){ alert(j.detail || 'Failed to start walk-forward'); return; }
      const jobId = j.job_id;
      document.getElementById('wf-status').textContent = `Job ${jobId} — running...`;
      document.getElementById('wf-logs').textContent = '';
      document.getElementById('wf-summary').innerHTML = '';
      if(_wfPoll) clearInterval(_wfPoll);
      _wfPoll = setInterval(()=> pollWalkForward(jobId), 2000);
      pollWalkForward(jobId);
    }
    async function pollWalkForward(jobId){
      try{
        const r = await fetch(`/api/rl/portfolio/walkforward/status/${jobId}`);
        if(!r.ok) throw new Error('status not found');
        const j = await r.json();
        const st = j.status || 'unknown';
        let line1 = `Job ${jobId} — ${st}`;
        if(j.out_dir){ line1 += ` — out: ${j.out_dir}`; }
        document.getElementById('wf-status').textContent = line1;
        document.getElementById('wf-logs').textContent = (j.logs||[]).join('\n');
        if(Array.isArray(j.summary)){
          const rows = j.summary;
          let html = '<table style="width:100%; border-collapse:collapse;">\n<thead><tr>'+
            '<th style="padding:6px; text-align:left;">Window</th>'+
            '<th style="padding:6px; text-align:left;">Kind</th>'+
            '<th style="padding:6px; text-align:right;">Return</th>'+
            '<th style="padding:6px; text-align:right;">MDD</th>'+
            '<th style="padding:6px; text-align:right;">Sharpe</th>'+
            '<th style="padding:6px; text-align:right;">CAGR</th>'+
            '<th style="padding:6px; text-align:right;">Pts</th>'+
          '</tr></thead><tbody>';
          rows.forEach(r=>{
            const tr = (parseFloat(r.total_return)||0)*100;
            const dd = (parseFloat(r.max_drawdown)||0)*100;
            const sh = parseFloat(r.sharpe)||0;
            const cg = (parseFloat(r.cagr)||0)*100;
            html += `<tr>`+
              `<td style="padding:6px;">${r.window||''}</td>`+
              `<td style="padding:6px;">${r.kind||''}</td>`+
              `<td style="padding:6px; text-align:right;">${tr.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${dd.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${sh.toFixed(2)}</td>`+
              `<td style="padding:6px; text-align:right;">${cg.toFixed(2)}%</td>`+
              `<td style="padding:6px; text-align:right;">${r.points||0}</td>`+
            `</tr>`;
          });
          html += '</tbody></table>';
          document.getElementById('wf-summary').innerHTML = html;
        }
        if(st === 'completed' || st === 'failed' || st === 'error'){
          if(_wfPoll){ clearInterval(_wfPoll); _wfPoll = null; }
        }
      }catch(e){ if(_wfPoll){ clearInterval(_wfPoll); _wfPoll = null; } }
    }
    window.startWalkForward = startWalkForward;
    // News Exporter JS
    let _newsPoll = null;
    async function startNewsExport(){
      const syms = (document.getElementById('news-syms').value || '').trim();
      const sd = (document.getElementById('news-start').value || '').trim();
      const ed = (document.getElementById('news-end').value || '').trim();
      const refresh = !!document.getElementById('news-refresh').checked;
      if(!syms || !sd || !ed){ alert('Please fill symbols, start, end'); return; }
      const body = { symbols: syms, start: sd, end: ed, refresh };
      const r = await fetch('/api/rl/news/export', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      const j = await r.json();
      if(j.status !== 'started'){ alert(j.detail || 'Failed to start news export'); return; }
      const jobId = j.job_id;
      document.getElementById('news-status').textContent = `Job ${jobId} — running...`;
      document.getElementById('news-logs').textContent = '';
      if(_newsPoll) clearInterval(_newsPoll);
      _newsPoll = setInterval(()=> pollNewsExport(jobId), 2000);
      pollNewsExport(jobId);
    }
    async function pollNewsExport(jobId){
      try{
        const r = await fetch(`/api/rl/news/export/status/${jobId}`);
        if(!r.ok) throw new Error('status not found');
        const j = await r.json();
        const st = j.status || 'unknown';
        document.getElementById('news-status').textContent = `Job ${jobId} — ${st}`;
        document.getElementById('news-logs').textContent = (j.logs||[]).join('\n');
        if(st === 'completed' || st === 'failed' || st === 'error'){
          if(_newsPoll){ clearInterval(_newsPoll); _newsPoll = null; }
        }
      }catch(e){ if(_newsPoll){ clearInterval(_newsPoll); _newsPoll = null; } }
    }
    window.startNewsExport = startNewsExport;

    // Live (Paper) preview JS
    async function liveUseLatest(){
      try{
        const r = await fetch('/api/rl/live/latest-model');
        const j = await r.json();
        if(j.status==='ok' && j.model_path){
          document.getElementById('live-model').value = j.model_path;
        } else {
          alert(j.detail || 'No model found');
        }
      }catch(e){ alert('Failed to fetch latest model'); }
    }
    async function livePreview(){
      const syms = (document.getElementById('live-syms').value || '').trim();
      if(!syms){ alert('Enter symbols'); return; }
      const model = (document.getElementById('live-model').value || '').trim();
      const band = parseFloat(document.getElementById('live-band').value || '0');
      const minDays = parseInt(document.getElementById('live-min-days').value || '0', 10);
      const body = { symbols: syms, model_path: model || undefined, no_trade_band: band, band_min_days: minDays };
      try{
        const r = await fetch('/api/rl/live/preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await r.json();
        const out = document.getElementById('live-out');
        if(j.status!=='ok'){ out.textContent = `Error: ${j.detail||'preview failed'}`; return; }
        const sy = j.symbols||[];
        const rw = j.raw_weights || {}; const bw = j.banded_weights || null;
        let html = '';
        html += `Date: ${j.date || '—'}\n`;
        html += 'Raw Weights:\n';
        sy.forEach(s=>{ html += `${s}: ${(rw[s]!=null?(rw[s]*100).toFixed(1)+'%':'—')}\n`; });
        if(bw){
          html += '\nBanded Weights:\n';
          sy.forEach(s=>{ html += `${s}: ${(bw[s]!=null?(bw[s]*100).toFixed(1)+'%':'—')}\n`; });
        }
        out.textContent = html;
      }catch(e){
        document.getElementById('live-out').textContent = 'Preview failed';
      }
    }

    // Paper mode JS
    async function paperUseLatest(){
      try{
        const r = await fetch('/api/rl/live/latest-model');
        const j = await r.json();
        if(j.status==='ok' && j.model_path){ document.getElementById('paper-model').value = j.model_path; }
        else { alert(j.detail || 'No model found'); }
      }catch(e){ alert('Failed to fetch latest model'); }
    }
    async function paperStart(){
      const syms = (document.getElementById('paper-syms').value || '').trim();
      if(!syms){ alert('Enter symbols'); return; }
      const body = {
        symbols: syms,
        model_path: (document.getElementById('paper-model').value || '').trim() || undefined,
        starting_cash: parseFloat(document.getElementById('paper-cash').value || '10000'),
        no_trade_band: parseFloat(document.getElementById('paper-band').value || '0.05'),
        band_min_days: parseInt(document.getElementById('paper-min-days').value || '5', 10),
        transaction_cost_bps: parseInt(document.getElementById('paper-tc').value || '5', 10),
        slippage_bps: parseInt(document.getElementById('paper-slip').value || '5', 10),
        window: parseInt(document.getElementById('paper-window').value || '60', 10),
        max_daily_turnover_ratio: Math.max(0, parseFloat(document.getElementById('paper-turnover').value || '100')/100),
        max_drawdown_stop: Math.max(0, parseFloat(document.getElementById('paper-dd').value || '25')/100),
        resume: !!document.getElementById('paper-resume').checked,
        schedule_time: (document.getElementById('paper-time').value || '16:05'),
        timezone: (document.getElementById('paper-tz').value || 'America/New_York').trim(),
      };
      const r = await fetch('/api/rl/live/paper/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const j = await r.json();
      if(j.status!=='started'){ alert(j.detail || 'Failed to start paper mode'); return; }
      pollPaperStatus();
      if(!window._paperPoll){ window._paperPoll = setInterval(pollPaperStatus, 5000); }
    }
    async function paperStop(){
      try{ await fetch('/api/rl/live/paper/stop', { method: 'POST' }); }catch{}
      if(window._paperPoll){ clearInterval(window._paperPoll); window._paperPoll = null; }
      pollPaperStatus();
    }
    async function pollPaperStatus(){
      try{
        const r = await fetch('/api/rl/live/paper/status');
        const j = await r.json();
        const st = document.getElementById('paper-status');
        const posEl = document.getElementById('paper-positions');
        const pnlEl = document.getElementById('paper-pnl');
        const logsEl = document.getElementById('paper-logs');
        const running = j.running ? 'RUNNING' : 'STOPPED';
        const lr = j.last_run_date || '—';
        st.textContent = `${running} — last run: ${lr}`;
        // positions table
        const pos = j.positions || {}; const cash = j.cash || 0; const eq = j.equity || 0;
        let html = `<div>Cash: $${(cash).toFixed(2)} | Equity: $${(eq).toFixed(2)}</div>`;
        const keys = Object.keys(pos);
        if(keys.length){
          html += '<table style="margin-top:6px; width:100%; border-collapse:collapse;">\n<thead><tr><th style="text-align:left; padding:4px;">Symbol</th><th style="text-align:right; padding:4px;">Shares</th></tr></thead><tbody>';
          keys.forEach(k=>{ html += `<tr><td style="padding:4px;">${k}</td><td style="padding:4px; text-align:right;">${(pos[k]).toFixed(4)}</td></tr>`; });
          html += '</tbody></table>';
        }
        posEl.innerHTML = html;
        // PnL
        const last = j.last_decision;
        if(last){
          const d = last.date || '—';
          const eb = last.equity_before || 0; const ea = last.equity_after || 0;
          const pnl = ea - eb; const pnlp = eb>0? (pnl/eb*100):0;
          pnlEl.textContent = `Last ${d}: PnL $${pnl.toFixed(2)} (${pnlp.toFixed(2)}%)`;
        } else {
          pnlEl.textContent = '—';
        }
        // logs
        logsEl.textContent = (j.logs||[]).join('\n');
      }catch(e){ /* ignore */ }
    }
    // Bind to window
    window.paperUseLatest = paperUseLatest;
    window.paperStart = paperStart;
    window.paperStop = paperStop;
    window.pollPaperStatus = pollPaperStatus;

    // Ensure data JS
    async function ensureData(){
      const syms = (document.getElementById('ens-syms').value || '').trim();
      if(!syms){ alert('Enter symbols'); return; }
      const sd = (document.getElementById('ens-start').value || '').trim();
      const ed = (document.getElementById('ens-end').value || '').trim();
      const body = { symbols: syms, start: sd || undefined, end: ed || undefined };
      // collect optional indicator params
      const grabInt = (id)=>{ const el = document.getElementById(id); if(!el) return undefined; const v = (el.value||'').trim(); if(!v) return undefined; const n = parseInt(v, 10); return Number.isFinite(n)? n : undefined; };
      const grabFloat = (id)=>{ const el = document.getElementById(id); if(!el) return undefined; const v = (el.value||'').trim(); if(!v) return undefined; const n = parseFloat(v); return Number.isFinite(n)? n : undefined; };
      const ip = {
        rsi_period: grabInt('ip-rsi'),
        macd_fast: grabInt('ip-macd-fast'),
        macd_slow: grabInt('ip-macd-slow'),
        macd_signal: grabInt('ip-macd-signal'),
        atr_period: grabInt('ip-atr'),
        bb_period: grabInt('ip-bb-p'),
        bb_std: grabFloat('ip-bb-k'),
        sma_short: grabInt('ip-sma-short'),
        sma_mid: grabInt('ip-sma-mid'),
        sma_long: grabInt('ip-sma-long'),
        ema_main: grabInt('ip-ema'),
        roc_period: grabInt('ip-roc'),
        vol_period: grabInt('ip-vol'),
        volume_ma_period: grabInt('ip-volma'),
        adx_period: grabInt('ip-adx'),
        kama_n: grabInt('ip-kama-n'),
        kama_fast: grabInt('ip-kama-fast'),
        kama_slow: grabInt('ip-kama-slow'),
        stoch_k: grabInt('ip-stoch-k'),
        stoch_d: grabInt('ip-stoch-d'),
      };
      // remove undefineds
      const cleaned = {}; Object.keys(ip).forEach(k=>{ if(ip[k] !== undefined) cleaned[k] = ip[k]; });
      if(Object.keys(cleaned).length){ body.indicator_params = cleaned; }
      const r = await fetch('/api/rl/data/ensure', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
      const j = await r.json();
      if(j.status !== 'started'){ alert(j.detail || 'Failed to start ensure'); return; }
      const jobId = j.job_id;
      document.getElementById('ens-status').textContent = `Ensure job ${jobId} — running...`;
      if(window._ensPoll){ clearInterval(window._ensPoll); }
      const poll = async ()=>{
        try{
          const rs = await fetch(`/api/rl/data/ensure/status/${jobId}`);
          const js = await rs.json();
          document.getElementById('ens-status').textContent = `Ensure job ${jobId} — ${js.status}`;
          document.getElementById('ens-logs').textContent = (js.logs||[]).join('\n');
          if(js.status==='completed' || js.status==='failed' || js.status==='error'){
            clearInterval(window._ensPoll); window._ensPoll = null;
          }
        }catch(e){ clearInterval(window._ensPoll); window._ensPoll = null; }
      };
      window._ensPoll = setInterval(poll, 2000); poll();
    }
    window.ensureData = ensureData;
  </script>
</body>
</html>
