<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPulse Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Load JavaScript modules with cache busting -->
    <script src="/static/js/modules/market-data.js?v=20251020" defer></script>
    <script src="/static/js/modules/chart-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/alerts-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/ml-scanner.js?v=20251020" defer></script>
    
    <script src="/static/js/modules/websocket-client.js?v=20251020" defer></script>
    <!-- DISABLED: Old main.js conflicts with new AI Analysis - use inline functions instead -->
    <!-- <script src="/static/js/main.js?v=20251020" defer></script> -->
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .header h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 4px;
        }
        .subtitle { font-size: 0.85em; opacity: 0.8; margin-bottom: 6px; }
        .live-status {
            display: inline-block;
            background: rgba(16, 185, 129, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #10b981;
        }
        .market-header {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .market-indices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 8px;
        }
        .index-item {
            text-align: center;
            background: rgba(255,255,255,0.04);
            padding: 10px;
            border-radius: 8px;
        }
        .index-name { font-size: 0.75em; opacity: 0.7; margin-bottom: 3px; }
        .index-value { font-size: 1.1em; font-weight: bold; margin-bottom: 3px; }
        .index-change {
            font-size: 0.8em;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 500;
        }
        .positive { color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .negative { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        .last-update { text-align: center; font-size: 0.75em; opacity: 0.6; }
        .sentiment-bar-container {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sentiment-label { font-size: 0.85em; font-weight: 600; white-space: nowrap; }
        .sentiment-bar {
            flex: 1;
            height: 8px;
            background: #2d3748;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .sentiment-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            width: 54%;
            border-radius: 5px;
        }
        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 12px;
            justify-content: center;
        }
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .tab.active { background: rgba(255,255,255,0.15); color: #ffd700; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .section h3 {
            color: #ffd700;
            border-bottom: 2px solid rgba(255,255,255,0.15);
            padding-bottom: 6px;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .ai-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .ai-grid .ai-card:last-child {
            grid-column: 1 / -1; /* Hot Stocks takes full width */
        }
        .ai-card {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .ai-card h4 { color: #ffd700; font-size: 0.95em; margin-bottom: 8px; }
        .loading-text { color: #10b981; font-size: 0.85em; font-style: italic; }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .status-item {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
        }
        .status-icon { font-size: 1.5em; margin-bottom: 4px; }
        .status-label { font-size: 0.75em; opacity: 0.8; }
        .status-name { font-size: 0.7em; opacity: 0.6; margin-top: 2px; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .metric-item {
            text-align: center;
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        .metric-value { font-size: 1.3em; font-weight: bold; color: #3b82f6; }
        .metric-label { font-size: 0.75em; opacity: 0.8; margin-top: 3px; }
        .btn-analyze {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-analyze:hover { background: #2563eb; }
        
        /* Settings Tab Styles */
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .settings-group {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .settings-group h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .setting-item {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .setting-item label {
            font-size: 0.85em;
            color: #cbd5e0;
            font-weight: 500;
        }
        .setting-item input[type="number"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .setting-item input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .checkbox-setting {
            flex-direction: row !important;
            align-items: center;
            gap: 8px;
        }
        .checkbox-setting input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
            cursor: pointer;
        }
        .checkbox-setting label {
            cursor: pointer;
            margin: 0;
        }
        .settings-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .save-btn, .reset-btn, .export-btn, .import-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .save-btn {
            background: #10b981;
            color: white;
        }
        .save-btn:hover { background: #059669; }
        .reset-btn {
            background: #f59e0b;
            color: white;
        }
        .reset-btn:hover { background: #d97706; }
        .export-btn, .import-btn {
            background: #3b82f6;
            color: white;
        }
        .export-btn:hover, .import-btn:hover { background: #2563eb; }
        
        /* AI Analysis Tab Styles */
        .ai-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .ai-selector-card, .ai-prediction-card, .ai-timeseries-card, .ai-risk-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .ai-selector-card h4, .ai-prediction-card h4, .ai-timeseries-card h4, .ai-risk-card h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .stock-selector select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .stock-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .prediction-item, .timeseries-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .prediction-label, .metric-name {
            font-size: 0.85em;
            color: #cbd5e0;
        }
        .prediction-value, .metric-value {
            font-weight: 600;
            font-size: 0.85em;
        }
        .prediction-value.bullish, .metric-value.bullish { color: #10b981; }
        .prediction-value.bearish, .metric-value.bearish { color: #ef4444; }
        .prediction-value.neutral, .metric-value.neutral { color: #f59e0b; }
        .risk-gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(to right, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 60px 60px 0 0;
        }
        .risk-indicator {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .risk-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 50px;
            background: #ffffff;
            transform-origin: bottom;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.5s ease;
        }
        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            margin-top: 5px;
        }
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        /* Hot Stocks Grid Styles */
        .hot-stocks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;  
            margin-top: 10px;
        }
        .hot-stock-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        .hot-stock-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .stock-symbol {
            font-weight: bold;
            color: #3b82f6;
            font-size: 0.9em;
        }
        .stock-price {
            font-size: 0.85em;
            color: #e2e8f0;
        }
        .stock-return {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .stock-return.change-positive {
            color: #10b981;
        }
        .stock-return.change-negative {
            color: #ef4444;
        }
        .stock-details {
            font-size: 0.8em;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        /* Responsive adjustments for hot stocks */
        @media (max-width: 1200px) {
            .hot-stocks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .hot-stocks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MarketPulse üìä</h1>
            <p class="subtitle">Real-Time Financial Intelligence Platform</p>
            <p>Live market data ‚Ä¢ AI-powered analysis ‚Ä¢ Smart alerts ‚Ä¢ Stock insights</p>
            <div class="live-status">üöÄ LIVE MARKET DATA</div>
        </div>

        <div class="market-header">
            <div class="market-indices">
                <div class="index-item" data-index="VIX">
                    <div class="index-name">VIX</div>
                    <div class="index-value" id="VIX-value">--</div>
                    <div class="index-change" id="VIX-change">Loading...</div>
                </div>
                <div class="index-item" data-index="RUSSELL2000">
                    <div class="index-name">RUSSELL 2000</div>
                    <div class="index-value" id="RUSSELL2000-value">--</div>
                    <div class="index-change" id="RUSSELL2000-change">Loading...</div>
                </div>
                <div class="index-item" data-index="DOW">
                    <div class="index-name">DOW JONES</div>
                    <div class="index-value" id="DOW-value">--</div>
                    <div class="index-change" id="DOW-change">Loading...</div>
                </div>
                <div class="index-item" data-index="NASDAQ">
                    <div class="index-name">NASDAQ</div>
                    <div class="index-value" id="NASDAQ-value">--</div>
                    <div class="index-change" id="NASDAQ-change">Loading...</div>
                </div>
                <div class="index-item" data-index="SP500">
                    <div class="index-name">S&P 500</div>
                    <div class="index-value" id="SP500-value">--</div>
                    <div class="index-change" id="SP500-change">Loading...</div>
                </div>
            </div>
            <div class="last-update" id="last-update">Connecting...</div>
        </div>

        <div class="sentiment-bar-container">
            <span class="sentiment-label" id="sentiment-label">Connecting...</span>
            <div class="sentiment-bar">
                <div class="sentiment-fill" id="sentiment-fill" style="width: 0%;"></div>
            </div>
            <span class="sentiment-label">Market Sentiment üìà</span>
        </div>

        <div class="tabs">
            <button class="tab" data-tab="settings-tab" onclick="showTabDirect('settings-tab')">Settings ‚öôÔ∏è</button>
            <button class="tab" data-tab="articles-tab" onclick="showTabDirect('articles-tab')">Articles üìÑ</button>
            <button class="tab" data-tab="ai-tab" onclick="showTabDirect('ai-tab')">AI Analysis ü§ñ</button>
            <button class="tab" data-tab="progressive-ml-tab" onclick="showTabDirect('progressive-ml-tab')">Progressive ML üöÄ</button>
            <button class="tab" data-tab="data-management-tab" onclick="showTabDirect('data-management-tab')">Data Management üìä</button>
            <button class="tab" data-tab="financial-tab" onclick="showTabDirect('financial-tab')">Finance üí∞</button>
            <button class="tab" data-tab="geopolitics-tab" onclick="showTabDirect('geopolitics-tab')">Geopolitics üåç</button>
            <button class="tab" data-tab="watchlist-tab" onclick="showTabDirect('watchlist-tab')">Watchlist ‚≠ê</button>
            <button class="tab active" data-tab="overview-tab" onclick="showTabDirect('overview-tab')">Overview üìä</button>
        </div>
        
        <!-- Tab Contents -->
        <div id="overview-tab" class="tab-content active">
            <!-- Overview content here -->
        
        <div class="section">
            <h3>MarketPulse AI Intelligence ü§ñ</h3>
            <div class="ai-grid">
                <div class="ai-card">
                    <h4>Market Intelligence Dashboard üß†</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Market Sentiment</strong>
                        <div class="loading-text" id="market-sentiment-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Overall Market</strong>
                        <div class="loading-text" id="overall-market-display">...Loading</div>
                    </div>
                </div>
                <div class="ai-card">
                    <h4>Risk Assessment ‚ö†Ô∏è</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #ef4444;">Market Risk (VIX)</strong>
                        <div class="loading-text" id="market-risk-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0; font-size: 0.75em; opacity: 0.7;">
                        <div id="risk-interpretation">Analyzing market volatility...</div>
                    </div>
                </div>
                <!-- Geopolitical Risks Card -->
                <div class="ai-card" id="geopolitical-card">
                    <h4>Geopolitical Risks üåç</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #f59e0b;">Current Events</strong>
                        <div class="loading-text" id="geopolitical-events">Loading geopolitical risks...</div>
                    </div>
                    <div style="margin-top:8px; font-size:0.85em; opacity:0.8;" id="geopolitical-summary"></div>
                </div>
                <!-- Hot Stocks Card -->
                <div class="ai-card">
                    <h4>AI Hot Stocks üî•</h4>
                    <div id="hot-alerts" style="margin: 8px 0;">
                        <p style="text-align: center; opacity: 0.6;">Scanning for hot opportunities...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Top Market Movers üìà</h3>
            <div id="top-movers" style="display: grid; gap: 10px;">
                <p style="text-align: center; opacity: 0.6;">Loading top market movers...</p>
            </div>
        </div>

        <div class="section">
            <h3>AI Models Status ü§ñ</h3>
            <div class="status-grid" id="ai-models-status">
                <div class="status-item">
                    <div class="status-icon">‚è≥</div>
                    <div class="status-label">Loading...</div>
                    <div class="status-name">Checking status</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>ML Intelligence Dashboard üß†</h3>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="market-sentiment-value">Loading...</div>
                    <div class="metric-label" id="market-sentiment-label">Market Sentiment</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="risk-level-value">Loading...</div>
                    <div class="metric-label" id="risk-level-label">Risk Level</div>
                </div>
            </div>
            <div id="ai-recommendations" style="margin-top: 15px;">
                <h4 style="color: #ffd700; margin-bottom: 10px;">AI Recommendations</h4>
                <p style="text-align: center; opacity: 0.6;">Analyzing market conditions...</p>
            </div>
        </div>

        </div>
        <!-- End Overview Tab -->
        
        <!-- AI Analysis Tab -->
        <div id="ai-tab" class="tab-content">
            <div class="section">
                <h3>ü§ñ AI Market Intelligence</h3>
                <div id="ai-intelligence-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading AI market intelligence...</p>
                </div>
                
                <div class="ai-analysis-grid">
                    <!-- Stock Input -->
                    <div class="ai-selector-card">
                        <h4>ü§ñ AI Stock Analysis</h4>
                        <div class="stock-selector">
                            <input type="text" id="ai-stock-input" placeholder="Enter stock symbol (e.g., AAPL)" 
                                   style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em; text-transform: uppercase;">
                            <div style="display: flex; gap: 5px; margin-top: 8px;">
                                <button onclick="analyzeStock()" style="flex: 1; background: #3b82f6; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    üîç Analyze Stock
                                </button>
                                <button onclick="debugPrompt()" style="flex: 1; background: #f59e0b; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    üêõ Debug Prompt
                                </button>
                            </div>
                        </div>
                        <div id="selected-stock-analysis" style="margin-top: 15px;">
                            <p style="text-align: center; opacity: 0.6;">Enter a stock symbol above for comprehensive AI analysis</p>
                        </div>
                    </div>

                    <!-- AI Comprehensive Analysis -->
                    <div class="ai-prediction-card">
                        <h4>üéØ AI Comprehensive Analysis</h4>
                        <div id="ai-comprehensive-results">
                            <div class="prediction-item">
                                <span class="prediction-label">Overall Prediction:</span>
                                <span class="prediction-value neutral">Waiting for analysis</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Confidence Level:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Target Price:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Technical Analysis -->
                    <div class="ai-timeseries-card">
                        <h4>üìä AI Technical Analysis</h4>
                        <div id="ai-technical-results">
                            <div class="timeseries-metric">
                                <span class="metric-name">Trend Direction:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Support Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Resistance Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">RSI Signal:</span>
                                <span class="metric-value">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Risk Assessment -->
                    <div class="ai-risk-card">
                        <h4>‚ö†Ô∏è AI Risk Assessment</h4>
                        <div id="ai-risk-assessment">
                            <div class="risk-gauge">
                                <div class="risk-indicator" id="ai-risk-indicator">
                                    <div class="risk-needle"></div>
                                </div>
                                <div class="risk-labels">
                                    <span class="risk-low">Low</span>
                                    <span class="risk-medium">Medium</span>
                                    <span class="risk-high">High</span>
                                </div>
                            </div>
                            <div id="ai-risk-factors">
                                <p style="text-align: center; opacity: 0.6;">Enter a stock symbol for AI risk analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Articles Tab -->
        <div id="articles-tab" class="tab-content">
            <div class="section">
                <h3>Active Alerts üö®</h3>
                <div id="alerts-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading active alerts...</p>
                </div>
                
                <h3>Recent Articles üìÑ</h3>
                <div id="articles-container">
                    <p style="text-align: center; opacity: 0.6;">Loading recent articles...</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section">
                <h3>‚öôÔ∏è System Settings</h3>
                <div class="settings-container">
                    <!-- Update Settings -->
                    <div class="settings-group">
                        <h4>üîÑ Update Settings</h4>
                        <div class="setting-item">
                            <label for="updateInterval">Auto-refresh interval (seconds):</label>
                            <input type="number" id="updateInterval" min="5" max="300" value="30">
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">Enable auto-refresh</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableWebSocket" checked>
                            <label for="enableWebSocket">Enable real-time updates</label>
                        </div>
                    </div>

                    <!-- Display Settings -->
                    <div class="settings-group">
                        <h4>üé® Display Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="darkMode" checked>
                            <label for="darkMode">Dark mode</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="compactView">
                            <label for="compactView">Compact view</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="showCharts" checked>
                            <label for="showCharts">Show charts</label>
                        </div>
                    </div>

                    <!-- AI & ML Settings -->
                    <div class="settings-group">
                        <h4>ü§ñ AI & ML Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableMLPredictions" checked>
                            <label for="enableMLPredictions">Enable ML predictions</label>
                        </div>
                        <div class="setting-item">
                            <label for="keywordThreshold">Keyword relevance threshold:</label>
                            <input type="number" id="keywordThreshold" min="0" max="1" step="0.1" value="0.3">
                        </div>
                        <div class="setting-item">
                            <label for="highScoreThreshold">High score threshold:</label>
                            <input type="number" id="highScoreThreshold" min="0" max="1" step="0.1" value="0.7">
                        </div>
                    </div>

                    <!-- Hot Stocks Scanner Settings -->
                    <div class="settings-group">
                        <h4>üî• Hot Stocks Scanner</h4>
                        <div class="setting-item">
                            <label for="hotStocksReturnThreshold">Minimum expected return (%):</label>
                            <input type="number" id="hotStocksReturnThreshold" min="0.1" max="10" step="0.1" value="1.0">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Stocks must exceed this % to be considered "hot"</small>
                        </div>
                        <div class="setting-item">
                            <label for="hotStocksConfidenceThreshold">Minimum confidence score:</label>
                            <input type="number" id="hotStocksConfidenceThreshold" min="0.1" max="1.0" step="0.05" value="0.55">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">ML model confidence (0.0 - 1.0)</small>
                        </div>
                        <div class="setting-item">
                            <label for="hotStocksLimit">Number of stocks to display:</label>
                            <input type="number" id="hotStocksLimit" min="1" max="25" value="5">
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="hotStocksAutoRefresh" checked>
                            <label for="hotStocksAutoRefresh">Auto-refresh hot stocks</label>
                        </div>
                    </div>

                    <!-- Progressive ML Training Settings -->
                    <div class="settings-group">
                        <h4>üöÄ Progressive ML Training</h4>
                        <div class="setting-item">
                            <label for="trainingEpochs">Training epochs:</label>
                            <input type="number" id="trainingEpochs" min="10" max="500" value="100">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">More epochs = better accuracy but longer training</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingBatchSize">Batch size:</label>
                            <input type="number" id="trainingBatchSize" min="8" max="128" step="8" value="32">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Larger batches use more memory</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingSequenceLength">Sequence length (days):</label>
                            <input type="number" id="trainingSequenceLength" min="30" max="120" value="60">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Historical data window for predictions</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingLearningRate">Learning rate:</label>
                            <input type="number" id="trainingLearningRate" min="0.0001" max="0.01" step="0.0001" value="0.001">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Model optimization speed (0.0001 - 0.01)</small>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="settings-group">
                        <h4>üîî Notifications</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableNotifications">
                            <label for="enableNotifications">Enable browser notifications</label>
                        </div>
                        <div class="setting-item">
                            <label for="maxArticles">Maximum articles to display:</label>
                            <input type="number" id="maxArticles" min="10" max="500" value="50">
                        </div>
                    </div>

                    <!-- Debug Settings -->
                    <div class="settings-group">
                        <h4>üêõ Debug</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="debugMode">
                            <label for="debugMode">Enable debug mode</label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-actions">
                        <button class="save-btn" onclick="window.settingsManager?.saveSettings()">üíæ Save Settings</button>
                        <button class="reset-btn" onclick="window.settingsManager?.resetSettings()">üîÑ Reset to Defaults</button>
                        <button class="export-btn" onclick="window.settingsManager?.exportSettings()">üì• Export Settings</button>
                        <input type="file" id="importSettings" accept=".json" style="display: none;" onchange="handleSettingsImport(this)">
                        <button class="import-btn" onclick="document.getElementById('importSettings').click()">üì§ Import Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progressive ML Tab -->
        <div id="progressive-ml-tab" class="tab-content">
            <div class="section">
                <h3>üöÄ Progressive ML Training System</h3>
                
                <!-- Row 1: Status Cards in Single Row -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>ü§ñ Progressive ML Status</h4>
                        <div id="progressive-ml-status-display">Loading Progressive ML status...</div>
                    </div>
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>üß† Available Models</h4>
                        <div id="progressive-models-display">Loading models info...</div>
                    </div>
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>üìä Training Status</h4>
                        <div id="progressive-training-status-display">Loading training status...</div>
                    </div>
                </div>

                <!-- Row 2: Advanced Backtesting (Full Width, Parameters in Row) -->
                <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">üî¨ Advanced Backtesting Training</h4>
                    <p style="font-size: 0.9em; opacity: 0.8; margin-bottom: 15px;">Train with expanding date windows and automatic accuracy improvement</p>
                    
                    <!-- Parameters Grid - All in Row including buttons -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Start Date:</label>
                            <input type="date" id="backtest-start-date" value="2024-01-01" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">End Date:</label>
                            <input type="date" id="backtest-end-date" value="2025-10-07" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Test Period:</label>
                            <input type="number" id="backtest-test-period" value="14" min="1" max="365" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Iterations:</label>
                            <input type="number" id="backtest-max-iterations" value="10" min="1" max="50" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Target: <span id="accuracy-display" style="font-weight: bold; color: #10b981;">85%</span></label>
                            <input type="range" id="backtest-target-accuracy" min="50" max="100" value="85" style="width: 100%;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.75em; color: #cbd5e0; display: flex; align-items: center; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <input type="checkbox" id="backtest-auto-stop" checked style="width: 16px; height: 16px; margin-left: 5px; accent-color: #3b82f6;">
                                Auto-stop
                            </label>
                        </div>
                        
                        <div>
                            <button onclick="startBacktesting()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em;">
                                üî¨ Start
                            </button>
                        </div>
                        
                        <div>
                            <button onclick="stopBacktesting()" style="width: 100%; background: #ef4444; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-size: 0.85em;">
                                ‚èπ Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Display -->
                    <div id="backtest-progress" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span id="backtest-status-text">Starting backtest...</span>
                                <span id="backtest-iteration-text">Iteration 0/10</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 10px; overflow: hidden;">
                                <div id="backtest-progress-fill" style="background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Table -->
                    <div id="backtest-results-container" style="margin-top: 20px; display: none;">
                        <h5 style="margin-bottom: 10px;">üìä Backtest Results</h5>
                        <div style="overflow-x: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;">
                            <table style="width: 100%; color: #e2e8f0; font-size: 0.9em;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="padding: 8px; text-align: left;">#</th>
                                        <th style="padding: 8px; text-align: left;">Train Until</th>
                                        <th style="padding: 8px; text-align: left;">Accuracy</th>
                                        <th style="padding: 8px; text-align: left;">Loss</th>
                                        <th style="padding: 8px; text-align: left;">Time</th>
                                        <th style="padding: 8px; text-align: left;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="backtest-results-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Chart -->
                    <div id="backtest-chart-container" style="margin-top: 20px; display: none;">
                        <canvas id="backtest-chart"></canvas>
                    </div>
                </div>

                <!-- Row 3: Progressive Training Interface (2 Boxes) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                        <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">üéØ Progressive Model Training</h4>
                        
                        <!-- All inputs in one row -->
                        <div style="display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 10px; margin-bottom: 10px; align-items: start;">
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Stock Symbol:</label>
                                <input type="text" id="progressive-symbol" placeholder="Enter symbol (e.g., TSLA, NVDA)" value="" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.9em;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Model Types:</label>
                                <select id="progressive-model-types" multiple style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px 8px; color: #e2e8f0; height: 60px; font-size: 0.85em;">
                                    <option value="lstm" selected>LSTM</option>
                                    <option value="gru">GRU</option>
                                    <option value="cnn_lstm">CNN-LSTM</option>
                                    <option value="transformer">Transformer</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Training Mode:</label>
                                <select id="progressive-mode" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                    <option value="progressive" selected>Progressive</option>
                                    <option value="unified">Unified</option>
                                </select>
                            </div>
                        </div>
                        
                        <small style="opacity: 0.7; font-size: 0.8em; display: block; margin-bottom: 10px;">üí° Enter any stock symbol from your stock_data folder</small>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="getProgressivePrediction()" style="flex: 1; background: #8b5cf6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                üîÆ Get Prediction
                            </button>
                            <button onclick="startProgressiveTraining()" style="flex: 1; background: #f59e0b; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                üöÄ Start Training
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                        <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">üèãÔ∏è Training Progress</h4>
                        <div id="progressive-training-results" style="min-height: 100px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center; font-size: 0.9em;">Training results will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results (Full Width) -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                    <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">üìà Progressive Prediction Results</h4>
                    <div id="progressive-prediction-results" style="min-height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="opacity: 0.6; text-align: center; font-size: 0.9em;">Select a symbol and click "Get Progressive Prediction" to see advanced ML predictions with multiple time horizons</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data-management-tab" class="tab-content">
            <div class="section">
                <h3>üìä Data Management & Download Status</h3>
                
                <!-- Status Overview -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <h4><i class="fas fa-download"></i> ◊î◊ï◊®◊ì◊ï◊™ ◊ô◊ï◊û◊ô◊ï◊™</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="daily-downloads-count">-</div>
                        <small>◊û◊î◊ô◊ï◊ù</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                        <h4><i class="fas fa-chart-bar"></i> ◊†◊™◊ï◊†◊ô ◊§◊†◊ì◊û◊†◊ò◊ú</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="fundamental-updates-count">-</div>
                        <small>◊î◊©◊ë◊ï◊¢</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h4><i class="fas fa-exclamation-triangle"></i> ◊©◊í◊ô◊ê◊ï◊™</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="errors-count">-</div>
                        <small>24 ◊©◊¢◊ï◊™</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white;">
                        <h4><i class="fas fa-clock"></i> ◊®◊ô◊¶◊î ◊ê◊ó◊®◊ï◊†◊î</h4>
                        <div style="font-size: 1.2em; font-weight: bold;" id="last-run-time">-</div>
                        <small>◊î◊ï◊®◊ì◊™ ◊†◊™◊ï◊†◊ô◊ù</small>
                    </div>
                </div>

                <!-- Jobs Schedule -->
                <div class="ai-card" style="background: rgba(255, 255, 255, 0.05); margin-bottom: 20px;">
                    <h4>‚è∞ ◊ú◊ï◊ó ◊ñ◊û◊†◊ô◊ù ◊ê◊ï◊ò◊ï◊û◊ò◊ô</h4>
                    <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 15px;">
                        <table style="width: 100%; color: #e2e8f0;">
                            <thead style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <tr>
                                    <th style="text-align: right; padding: 10px;">◊û◊©◊ô◊û◊î</th>
                                    <th style="text-align: right; padding: 10px;">◊™◊ì◊ô◊®◊ï◊™</th>
                                    <th style="text-align: right; padding: 10px;">◊®◊ô◊¶◊î ◊ê◊ó◊®◊ï◊†◊î</th>
                                    <th style="text-align: right; padding: 10px;">◊®◊ô◊¶◊î ◊î◊ë◊ê◊î</th>
                                    <th style="text-align: right; padding: 10px;">◊°◊ò◊ò◊ï◊°</th>
                                    <th style="text-align: right; padding: 10px;">◊§◊¢◊ï◊ú◊ï◊™</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-schedule-table">
                                <tr>
                                    <td style="padding: 10px;">
                                        <strong>◊î◊ï◊®◊ì◊™ ◊û◊ó◊ô◊®◊ô◊ù ◊ô◊ï◊û◊ô◊™</strong><br>
                                        <small style="opacity: 0.7;">daily_scan.py</small>
                                    </td>
                                    <td style="padding: 10px;">
                                        <span style="background: #3182ce; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊ô◊ï◊û◊ô 17:10</span>
                                    </td>
                                    <td style="padding: 10px;" id="daily-last-run">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;" id="daily-next-run">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;" id="daily-status">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;">
                                        <button onclick="runDataJob('daily')" style="background: #38a169; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; margin-right: 5px;">
                                            <i class="fas fa-play"></i> ◊î◊®◊• ◊¢◊õ◊©◊ô◊ï
                                        </button>
                                        <button onclick="viewDataLogs('daily')" style="background: #4a5568; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em;">
                                            <i class="fas fa-file-alt"></i> ◊ú◊ï◊í◊ô◊ù
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px;">
                                        <strong>◊¢◊ì◊õ◊ï◊ü ◊†◊™◊ï◊†◊ô ◊§◊†◊ì◊û◊†◊ò◊ú</strong><br>
                                        <small style="opacity: 0.7;">run_weekly_fundamentals.py</small>
                                    </td>
                                    <td style="padding: 10px;">
                                        <span style="background: #d69e2e; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊©◊ë◊ï◊¢◊ô ◊ê' 02:00</span>
                                    </td>
                                    <td style="padding: 10px;" id="weekly-last-run">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;" id="weekly-next-run">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;" id="weekly-status">◊ò◊ï◊¢◊ü...</td>
                                    <td style="padding: 10px;">
                                        <button onclick="runDataJob('weekly')" style="background: #38a169; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; margin-right: 5px;">
                                            <i class="fas fa-play"></i> ◊î◊®◊• ◊¢◊õ◊©◊ô◊ï
                                        </button>
                                        <button onclick="viewDataLogs('weekly')" style="background: #4a5568; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em;">
                                            <i class="fas fa-file-alt"></i> ◊ú◊ï◊í◊ô◊ù
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>üöÄ ◊§◊¢◊ï◊ú◊ï◊™ ◊û◊î◊ô◊®◊ï◊™</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="runAllDataJobs()" style="background: #38a169; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-play-circle"></i> ◊î◊®◊• ◊ê◊™ ◊õ◊ú ◊î◊û◊©◊ô◊û◊ï◊™
                            </button>
                            <button onclick="refreshDataStatus()" style="background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-sync"></i> ◊®◊¢◊†◊ü ◊°◊ò◊ò◊ï◊°
                            </button>
                            <button onclick="downloadDataLogs()" style="background: #4a5568; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-download"></i> ◊î◊ï◊®◊ì ◊ú◊ï◊í◊ô◊ù
                            </button>
                        </div>
                    </div>
                    <div class="ai-card">
                        <h4>üîß ◊ë◊®◊ô◊ê◊ï◊™ ◊î◊û◊¢◊®◊õ◊™</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="db-health-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <small>Database</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="scheduler-health-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <small>Scheduler</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="api-health-icon">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                                <small>API</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="storage-health-icon">
                                    <i class="fas fa-hdd"></i>
                                </div>
                                <small>Storage</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Logs -->
                <div class="ai-card">
                    <h4>üìã ◊ú◊ï◊í◊ô◊ù ◊ê◊ó◊®◊ï◊†◊ô◊ù</h4>
                    <div style="background: #2d3748; color: #a0aec0; font-family: 'Courier New', monospace; font-size: 0.85rem; border-radius: 10px; padding: 15px; max-height: 300px; overflow-y: auto;" id="recent-logs">
                        <div style="color: #63b3ed;">[16:00:01] üîÑ ◊û◊™◊ó◊ë◊® ◊ú◊ú◊ï◊í◊ô◊ù...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Data Tab -->
        <div id="financial-tab" class="tab-content">
            <div class="section">
                <h3>üí∞ Enhanced Financial Analytics</h3>
                
                <!-- Sector Performance -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>üìä Sector Performance</h4>
                        <div id="sector-performance-display">Loading sector data...</div>
                    </div>
                    <div class="ai-card">
                        <h4>üíπ Market Sentiment</h4>
                        <div id="market-sentiment-detailed">Loading sentiment analysis...</div>
                    </div>
                </div>

                <!-- Symbol-specific Analysis -->
                <div class="settings-container">
                    <div class="settings-group">
                        <h4>üéØ Symbol Analysis</h4>
                        <div class="setting-item">
                            <label for="financial-symbol">Stock Symbol:</label>
                            <input type="text" id="financial-symbol" placeholder="e.g., AAPL" value="AAPL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="getMarketData()" style="flex: 1; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üìà Market Data
                            </button>
                            <button onclick="getSentiment()" style="flex: 1; background: #8b5cf6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üí≠ Sentiment
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>üìä Analysis Results</h4>
                        <div id="financial-results" style="min-height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center;">Enter a symbol and select analysis type</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geopolitics Tab -->
        <div id="geopolitics-tab" class="tab-content">
            <div class="section">
                <h3>üåç Geopolitical Risk Analysis</h3>
                
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>‚ö†Ô∏è Risk Assessment</h4>
                        <div id="risk-assessment-display">Loading risk analysis...</div>
                    </div>
                    <div class="ai-card">
                        <h4>üåê Global Factors</h4>
                        <div id="global-factors-display">Loading global factors...</div>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>üìã Risk Factors & Recommendations</h4>
                    <div id="geopolitical-details" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="opacity: 0.6; text-align: center;">Loading detailed geopolitical analysis...</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="loadGeopoliticalData()" style="background: #ef4444; border: none; padding: 12px 24px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        üîÑ Refresh Risk Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist-tab" class="tab-content">
            <div class="section">
                <h3>‚≠ê Investment Watchlist</h3>
                
                <div class="settings-container" style="margin-bottom: 20px;">
                    <div class="settings-group">
                        <h4>‚ûï Add to Watchlist</h4>
                        <div class="setting-item">
                            <label for="watchlist-symbol">Stock Symbol:</label>
                            <input type="text" id="watchlist-symbol" placeholder="e.g., GOOGL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <button onclick="addToWatchlist()" style="width: 100%; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; margin-top: 10px;">
                            ‚≠ê Add Symbol
                        </button>
                    </div>
                    
                    <div class="settings-group">
                        <h4>‚öôÔ∏è Watchlist Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="auto-refresh-watchlist" checked>
                            <label for="auto-refresh-watchlist">Auto-refresh watchlist</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="price-alerts" checked>
                            <label for="price-alerts">Price change alerts</label>
                        </div>
                    </div>
                </div>

                <div class="ai-card">
                    <h4>üìä My Watchlist</h4>
                    <div id="watchlist-display">
                        <p style="opacity: 0.6; text-align: center;">Loading watchlist...</p>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="loadWatchlist()" style="background: #3b82f6; border: none; padding: 8px 16px; border-radius: 6px; color: white; cursor: pointer;">
                            üîÑ Refresh Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
            <p style="font-size: 0.8em; opacity: 0.6;">
                <strong>Architecture:</strong> FastAPI ‚Ä¢ PostgreSQL ‚Ä¢ Redis ‚Ä¢ Qdrant ‚Ä¢ Celery üèóÔ∏è<br>
                <strong>Deployment:</strong> Docker Containers ‚Ä¢ Production Ready ‚Ä¢ Scalable üöÄ<br>
                <strong>Status:</strong> Full Production System Running Successfully üåê
            </p>
        </div>
    </div>
    
    <script>
    // Tab Management Functions (unified from main.js)
    function showTab(tabName) {
        console.log('üîÑ Switching to tab:', tabName);
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab content
        const selectedContent = document.getElementById(tabName);
        if (selectedContent) {
            selectedContent.classList.add('active');
            console.log('‚úÖ Tab content shown:', tabName);
        } else {
            console.error('‚ùå Tab content not found:', tabName);
        }

        // Add active class to selected tab button
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
            console.log('‚úÖ Tab button activated');
        } else {
            console.error('‚ùå Tab button not found for:', tabName);
        }
    }

    // Direct tab switching function for debugging
    function showTabDirect(tabName) {
        console.log('üîÑ Direct tab switch to:', tabName);
        showTab(tabName);
    }

    // Make functions globally available
    window.showTab = showTab;
    window.showTabDirect = showTabDirect;
    
    // Make function globally available
    window.showTabDirect = showTabDirect;

    // ===============================
    // NEW FUNCTIONALITY FOR ENHANCED FEATURES
    // ===============================

    // ML Functions
    async function getPrediction() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üîÑ Getting ML prediction...</p>';
        
        try {
            const response = await fetch(`/api/ml/predictions/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #3b82f6; margin-bottom: 10px;">üîÆ ML Prediction for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                        <strong>Direction:</strong> ${data.predictions?.direction || 'N/A'}<br>
                        <strong>Confidence:</strong> ${data.predictions?.confidence || 'N/A'}<br>
                        <strong>Target Price:</strong> $${data.predictions?.target_price || 'N/A'}
                    </div>
                    <small style="opacity: 0.7;">Generated: ${new Date().toLocaleString()}</small>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå ${data.message || 'Failed to get prediction'}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    async function trainModel() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        const days = document.getElementById('training-days').value;
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üèãÔ∏è Training model... This may take a while...</p>';
        
        try {
            const response = await fetch(`/api/ml/train/${symbol}?days_back=${days}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">‚úÖ Training Completed for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Training Period:</strong> ${days} days<br>
                        <strong>Status:</strong> ${data.training_result?.status || 'Completed'}<br>
                        <strong>Model Performance:</strong> ${data.training_result?.accuracy || 'N/A'}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Training failed: ${data.message}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    // Financial Functions
    async function getMarketData() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üìà Loading market data...</p>';
        
        try {
            const response = await fetch(`/api/market/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const marketData = data.data;
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">üìà Market Data for ${symbol}</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Price:</strong> $${marketData.price}<br>
                            <strong>Change:</strong> ${marketData.change} (${marketData.change_percent})
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Volume:</strong> ${marketData.volume?.toLocaleString()}<br>
                            <strong>Range:</strong> $${marketData.low} - $${marketData.high}
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Failed to load data</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    async function getSentiment() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üí≠ Analyzing sentiment...</p>';
        
        try {
            const response = await fetch(`/api/sentiment/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const sentiment = data.sentiment;
                resultsDiv.innerHTML = `
                    <h5 style="color: #8b5cf6; margin-bottom: 10px;">üí≠ Sentiment Analysis for ${symbol}</h5>
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Overall Score:</strong> ${sentiment.overall_score}<br>
                        <strong>Positive:</strong> ${(sentiment.positive * 100).toFixed(1)}%<br>
                        <strong>Negative:</strong> ${(sentiment.negative * 100).toFixed(1)}%<br>
                        <strong>Volume:</strong> ${sentiment.volume} mentions<br>
                        <strong>Trending:</strong> ${sentiment.trending ? 'üî• Yes' : 'üìä Normal'}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Failed to analyze sentiment</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    // Geopolitical Functions
    async function loadGeopoliticalData() {
        const riskDiv = document.getElementById('risk-assessment-display');
        const factorsDiv = document.getElementById('global-factors-display');
        const detailsDiv = document.getElementById('geopolitical-details');
        
        riskDiv.innerHTML = 'üîÑ Loading...';
        factorsDiv.innerHTML = 'üîÑ Loading...';
        detailsDiv.innerHTML = '<p style="text-align: center;">üîÑ Loading detailed analysis...</p>';
        
        try {
            const response = await fetch('/api/financial/geopolitical-risks');
            const data = await response.json();
            
            if (data.status === 'success') {
                const riskData = data.data;
                
                // Update risk assessment
                riskDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">‚ö†Ô∏è</div>
                        <strong>Risk Level: ${riskData.overall_risk_level}</strong><br>
                        <span style="font-size: 1.2em; color: #ffd700;">Score: ${riskData.risk_score}</span>
                    </div>
                `;
                
                // Update global factors
                factorsDiv.innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>Active Factors:</strong><br>
                        ${riskData.factors?.length || 0} regions monitored<br>
                        Next update: ${new Date(riskData.next_update).toLocaleTimeString()}
                    </div>
                `;
                
                // Update detailed analysis
                let factorsHtml = '';
                if (riskData.factors) {
                    factorsHtml = riskData.factors.map(factor => `
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                            <strong>${factor.region}</strong> - ${factor.risk_type}<br>
                            <span style="color: #ffd700;">Level: ${factor.level}</span> | 
                            <span style="color: #10b981;">Impact: ${factor.impact}</span><br>
                            <small>${factor.description}</small>
                        </div>
                    `).join('');
                }
                
                let recommendationsHtml = '';
                if (riskData.recommendations) {
                    recommendationsHtml = `
                        <h5 style="color: #3b82f6; margin: 15px 0 10px;">üìã Recommendations:</h5>
                        ${riskData.recommendations.map(rec => `<div style="color: #10b981;">‚Ä¢ ${rec}</div>`).join('')}
                    `;
                }
                
                detailsDiv.innerHTML = factorsHtml + recommendationsHtml;
            } else {
                riskDiv.innerHTML = '‚ùå Error';
                factorsDiv.innerHTML = '‚ùå Error';
                detailsDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load geopolitical data</p>';
            }
        } catch (error) {
            riskDiv.innerHTML = '‚ùå Error';
            factorsDiv.innerHTML = '‚ùå Error';
            detailsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    // Watchlist Functions
    async function loadWatchlist() {
        const watchlistDiv = document.getElementById('watchlist-display');
        watchlistDiv.innerHTML = '<p style="text-align: center;">üîÑ Loading watchlist...</p>';
        
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();
            
            if (data.status === 'success') {
                if (data.watchlist && data.watchlist.length > 0) {
                    const watchlistHtml = data.watchlist.map(stock => `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #3b82f6;">${stock.symbol}</strong><br>
                                <small>${stock.name}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>$${stock.price}</div>
                                <div style="color: ${stock.change.startsWith('+') ? '#10b981' : '#ef4444'};">${stock.change}</div>
                            </div>
                        </div>
                    `).join('');
                    
                    watchlistDiv.innerHTML = watchlistHtml;
                } else {
                    watchlistDiv.innerHTML = '<p style="opacity: 0.6; text-align: center;">No stocks in watchlist</p>';
                }
            } else {
                watchlistDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load watchlist</p>';
            }
        } catch (error) {
            watchlistDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    async function addToWatchlist() {
        const symbol = document.getElementById('watchlist-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        // For now, just add to UI - in real implementation would call API
        alert(`Added ${symbol} to watchlist! (Demo - would call API in production)`);
        document.getElementById('watchlist-symbol').value = '';
        loadWatchlist(); // Refresh the list
    }

    // AI Analysis Functions
    window.analyzeStock = async function() {
        console.log('analyzeStock function called');
        const symbol = document.getElementById('ai-stock-input').value.trim().toUpperCase();
        console.log('Symbol entered:', symbol);
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        // Update UI to show loading
        document.getElementById('selected-stock-analysis').innerHTML = '<p style="text-align: center;">ü§ñ Analyzing ' + symbol + '...</p>';
        document.getElementById('ai-comprehensive-results').innerHTML = '<p style="text-align: center;">üîÑ Running AI analysis...</p>';
        document.getElementById('ai-technical-results').innerHTML = '<p style="text-align: center;">üìä Processing technical data...</p>';
        document.getElementById('ai-risk-factors').innerHTML = '<p style="text-align: center;">‚ö†Ô∏è Calculating risk factors...</p>';
        
        try {
            // Get comprehensive AI analysis
            const response = await fetch(`/api/ai/comprehensive-analysis/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const analysis = data.analysis;
                const prediction = data.prediction;
                
                // Update stock info with metadata
                const metadata = data.ai_metadata || {};
                document.getElementById('selected-stock-analysis').innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px;">
                        <strong style="color: #3b82f6;">${symbol}</strong><br>
                        <span style="color: #10b981;">Current Price: $${data.current_price || 'N/A'}</span><br>
                        <small>ü§ñ AI Model: ${metadata.model || 'N/A'}</small><br>
                        <small>üìä Sources: ${metadata.search_results_count || 0} | Cost: $${(metadata.cost?.total_cost || 0).toFixed(4)}</small><br>
                        <small>üìù Response: ${metadata.raw_response_length || 0} chars | ${new Date().toLocaleTimeString()}</small>
                        ${metadata.raw_response_preview ? `
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; color: #3b82f6; font-size: 0.8em;">üìÑ View AI Response Preview</summary>
                            <pre style="white-space: pre-wrap; margin-top: 8px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-size: 0.75em; max-height: 200px; overflow-y: auto;">${metadata.raw_response_preview}</pre>
                        </details>` : ''}
                    </div>
                `;
                
                // Update comprehensive analysis
                const directionColor = prediction.direction === 'up' ? '#10b981' : prediction.direction === 'down' ? '#ef4444' : '#f59e0b';
                document.getElementById('ai-comprehensive-results').innerHTML = `
                    <div class="prediction-item">
                        <span class="prediction-label">Overall Prediction:</span>
                        <span class="prediction-value" style="color: ${directionColor};">${prediction.direction.toUpperCase()}</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-label">Confidence Level:</span>
                        <span class="prediction-value">${(prediction.confidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-label">Target Price:</span>
                        <span class="prediction-value">$${prediction.target_price}</span>
                    </div>
                `;
                
                // Update technical analysis
                const technical = analysis.technical;
                const trendColor = technical.trend === 'bullish' ? '#10b981' : technical.trend === 'bearish' ? '#ef4444' : '#f59e0b';
                document.getElementById('ai-technical-results').innerHTML = `
                    <div class="timeseries-metric">
                        <span class="metric-name">Trend Direction:</span>
                        <span class="metric-value" style="color: ${trendColor};">${technical.trend}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">Support Level:</span>
                        <span class="metric-value">$${technical.support_level}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">Resistance Level:</span>
                        <span class="metric-value">$${technical.resistance_level}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">RSI Signal:</span>
                        <span class="metric-value">${technical.macd_signal}</span>
                    </div>
                `;
                
                // Update risk assessment
                const risk = analysis.risk_assessment;
                updateRiskGauge(risk.risk_score);
                document.getElementById('ai-risk-factors').innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>Risk Level:</strong> ${risk.volatility}<br>
                        <strong>Beta:</strong> ${risk.beta}<br>
                        <strong>Liquidity:</strong> ${risk.liquidity}<br>
                        <strong>Overall Score:</strong> ${(risk.risk_score * 100).toFixed(0)}%
                    </div>
                `;
                
            } else {
                document.getElementById('selected-stock-analysis').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Analysis failed</p>';
                document.getElementById('ai-comprehensive-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Failed to get AI analysis</p>';
                document.getElementById('ai-technical-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Technical analysis unavailable</p>';
                document.getElementById('ai-risk-factors').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Risk analysis failed</p>';
            }
        } catch (error) {
            document.getElementById('selected-stock-analysis').innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
            document.getElementById('ai-comprehensive-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Connection error</p>';
            document.getElementById('ai-technical-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Network error</p>';
            document.getElementById('ai-risk-factors').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Service unavailable</p>';
        }
    }
    
    // Debug function to see the prompt
    window.debugPrompt = async function() {
        const symbol = document.getElementById('ai-stock-input').value.trim().toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        try {
            console.log('üêõ Fetching debug info for:', symbol);
            const response = await fetch(`/api/ai/debug-prompt/${symbol}`);
            const data = await response.json();
            
            if (!data.error) {
                console.log('üéØ PROMPT THAT WILL BE SENT TO PERPLEXITY:');
                console.log('‚ïê'.repeat(60));
                console.log(data.prompt);
                console.log('‚ïê'.repeat(60));
                console.log(`üìä Symbol: ${data.symbol}`);
                console.log(`üí∞ Current Price: $${data.current_price}`);
                console.log(`ü§ñ Model: ${data.model}`);
                console.log(`üìù Estimated Tokens: ${Math.round(data.estimated_tokens)}`);
                
                // Show in UI too
                document.getElementById('selected-stock-analysis').innerHTML = `
                    <div style="background: rgba(245, 158, 11, 0.1); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.8em;">
                        <strong style="color: #f59e0b;">üêõ DEBUG INFO for ${symbol}</strong><br>
                        <strong>Price:</strong> $${data.current_price}<br>
                        <strong>Model:</strong> ${data.model}<br>
                        <strong>Est. Tokens:</strong> ${Math.round(data.estimated_tokens)}<br>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #f59e0b;">üìù View Full Prompt</summary>
                            <pre style="white-space: pre-wrap; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
                        </details>
                    </div>
                `;
                
                alert(`Debug info logged to console! Check the browser console (F12) for full prompt details.`);
            } else {
                console.error('‚ùå Debug error:', data.error);
                alert('Error getting debug info: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Debug request failed:', error);
            alert('Failed to get debug info: ' + error.message);
        }
    }
    
    window.updateRiskGauge = function(riskScore) {
        console.log('Updating risk gauge with score:', riskScore);
        // Update risk gauge needle position
        const needle = document.querySelector('#ai-risk-indicator .risk-needle');
        if (needle) {
            // Convert risk score (0-1) to degrees (-90 to 90)
            const degrees = (riskScore * 180) - 90;
            needle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
        }
    }
    
    // Allow Enter key to trigger analysis
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('ai-stock-input');
        const button = document.querySelector('button[onclick="analyzeStock()"]');
        
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeStock();
                }
            });
        }
        
        if (button) {
            button.addEventListener('click', function() {
                analyzeStock();
            });
        }
    });

    // Auto-load data when tabs are opened
    document.addEventListener('DOMContentLoaded', function() {
        // Load ML status and render into Overview tiles and Progressive box
        fetch('/api/ml/status')
            .then(r => r.json())
            .then(data => {
                const trainer = data?.components?.ml_trainer?.status || 'N/A';
                const models = data?.performance?.models_active ?? 0;
                const accuracy = data?.performance?.accuracy ?? 'N/A';

                // Overview: AI Models Status grid
                const grid = document.getElementById('ai-models-status');
                if (grid) {
                    grid.innerHTML = `
                        <div class="status-item">
                            <div class="status-icon">üß†</div>
                            <div class="status-label">${trainer}</div>
                            <div class="status-name">ML Trainer</div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">üì¶</div>
                            <div class="status-label">${models}</div>
                            <div class="status-name">Active Models</div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">üéØ</div>
                            <div class="status-label">${accuracy}</div>
                            <div class="status-name">Avg. Accuracy</div>
                        </div>
                    `;
                }

                // Progressive ML box summary (optional)
                const prog = document.getElementById('progressive-ml-status-display');
                if (prog) {
                    prog.innerHTML = `
                        <div style="font-size: 0.9em;">
                            <strong>ML Trainer:</strong> ${trainer}<br>
                            <strong>Models:</strong> ${models} active<br>
                            <strong>Accuracy:</strong> ${accuracy}
                        </div>
                    `;
                }
            })
            .catch(() => {
                const grid = document.getElementById('ai-models-status');
                if (grid) {
                    grid.innerHTML = `
                        <div class="status-item">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-label">Error</div>
                            <div class="status-name">ML Status</div>
                        </div>
                    `;
                }
                const prog = document.getElementById('progressive-ml-status-display');
                if (prog) {
                    prog.innerHTML = '<div style="color: #ef4444;">‚ùå Failed to load ML status</div>';
                }
            });

        // Load sector performance
        fetch('/api/financial/sector-performance').then(r => r.json()).then(data => {
            if (data.status === 'success' && data.data) {
                const sectors = Object.entries(data.data).map(([name, info]) => 
                    `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${name}:</span>
                        <span style="color: ${info.change.startsWith('+') ? '#10b981' : '#ef4444'};">${info.change}</span>
                    </div>`
                ).join('');
                document.getElementById('sector-performance-display').innerHTML = sectors;
            }
        }).catch(() => {
            document.getElementById('sector-performance-display').innerHTML = 'Failed to load sector data';
        });

        // Load geopolitical data
        loadGeopoliticalData();
        
        // Load watchlist
        loadWatchlist();
        
        // Load AI market intelligence
        loadAIMarketIntelligence();
    });
    
    async function loadAIMarketIntelligence() {
        const intelligenceDiv = document.getElementById('ai-intelligence-container');
        intelligenceDiv.innerHTML = '<p style="text-align: center;">ü§ñ Loading AI market intelligence...</p>';
        
        try {
            const response = await fetch('/api/ai/market-intelligence');
            const data = await response.json();
            
            if (data.status === 'success') {
                intelligenceDiv.innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 15px;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">üß† Market Intelligence</h4>
                        <div style="font-size: 0.9em;">
                            <strong>Market Sentiment:</strong> ${data.sentiment || 'Analyzing...'}<br>
                            <strong>Overall Trend:</strong> ${data.trend || 'Processing...'}<br>
                            <strong>Risk Level:</strong> ${data.risk_level || 'Calculating...'}
                        </div>
                    </div>
                `;
            } else {
                intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Failed to load market intelligence</p>';
            }
        } catch (error) {
            intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Market intelligence unavailable</p>';
        }
    }

    // Data Management Functions
    async function loadDataManagementStatus() {
        try {
            const response = await fetch('/api/data-management/status');
            const data = await response.json();
            
            // Update metrics
            document.getElementById('daily-downloads-count').textContent = data.daily_downloads || '0';
            document.getElementById('fundamental-updates-count').textContent = data.weekly_updates || '0';
            document.getElementById('errors-count').textContent = data.error_count || '0';
            document.getElementById('last-run-time').textContent = data.last_run ? 
                new Date(data.last_run).toLocaleString('he-IL', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                }) : '◊ê◊£ ◊§◊¢◊ù';
            
            // Update jobs table
            if (data.jobs) {
                const dailyJob = data.jobs.find(j => j.id === 'daily_data');
                const weeklyJob = data.jobs.find(j => j.id === 'weekly_fundamentals');
                
                if (dailyJob) {
                    document.getElementById('daily-last-run').textContent = 
                        dailyJob.last_run ? new Date(dailyJob.last_run).toLocaleString('he-IL') : '◊ê◊£ ◊§◊¢◊ù';
                    document.getElementById('daily-next-run').textContent = 
                        dailyJob.next_run ? new Date(dailyJob.next_run).toLocaleString('he-IL') : '◊ú◊ê ◊û◊™◊ï◊ñ◊û◊ü';
                    document.getElementById('daily-status').innerHTML = getDataStatusBadge(dailyJob.status);
                }
                
                if (weeklyJob) {
                    document.getElementById('weekly-last-run').textContent = 
                        weeklyJob.last_run ? new Date(weeklyJob.last_run).toLocaleString('he-IL') : '◊ê◊£ ◊§◊¢◊ù';
                    document.getElementById('weekly-next-run').textContent = 
                        weeklyJob.next_run ? new Date(weeklyJob.next_run).toLocaleString('he-IL') : '◊ú◊ê ◊û◊™◊ï◊ñ◊û◊ü';
                    document.getElementById('weekly-status').innerHTML = getDataStatusBadge(weeklyJob.status);
                }
            }
            
            // Update system health
            updateSystemHealth();
            
        } catch (error) {
            console.error('Error loading data management status:', error);
            addDataLog('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊°◊ò◊ò◊ï◊°: ' + error.message, 'error');
        }
    }

    function getDataStatusBadge(status) {
        const badges = {
            'running': '<span style="background: #3182ce; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊®◊•</span>',
            'success': '<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊î◊ï◊©◊ú◊ù</span>',
            'error': '<span style="background: #e53e3e; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊©◊í◊ô◊ê◊î</span>',
            'scheduled': '<span style="background: #4a5568; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊û◊™◊ï◊ñ◊û◊ü</span>',
            'stopped': '<span style="background: #718096; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊¢◊¶◊ï◊®</span>'
        };
        return badges[status] || '<span style="background: #718096; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">◊ú◊ê ◊ô◊ì◊ï◊¢</span>';
    }

    async function runDataJob(jobType) {
        try {
            addDataLog(`üöÄ ◊û◊™◊ó◊ô◊ú ◊î◊®◊¶◊™ ◊û◊©◊ô◊û◊î: ${jobType}`, 'info');
            
            const response = await fetch(`/api/data-management/run-job/${jobType}`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                addDataLog(`‚úÖ ◊û◊©◊ô◊û◊î ◊î◊™◊ó◊ô◊ú◊î ◊ë◊î◊¶◊ú◊ó◊î: ${jobType}`, 'success');
                addDataLog(`üìã Job ID: ${result.job_id}`, 'info');
                
                // Start polling for job logs
                pollJobStatus(result.job_id);
            } else {
                addDataLog(`‚ùå ◊õ◊©◊ú ◊ë◊î◊™◊ó◊ú◊™ ◊û◊©◊ô◊û◊î: ${result.error}`, 'error');
            }
            
            // Refresh status after 2 seconds
            setTimeout(loadDataManagementStatus, 2000);
            
        } catch (error) {
            addDataLog(`‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊î◊®◊¶◊™ ◊û◊©◊ô◊û◊î: ${error.message}`, 'error');
        }
    }

    let pollInterval = null;
    
    async function pollJobStatus(jobId) {
        // Clear any existing polling
        if (pollInterval) {
            clearInterval(pollInterval);
        }
        
        let lastLogCount = 0;
        
        pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/data-management/job-status/${jobId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const logs = data.logs || [];
                    
                    // Only show new logs
                    if (logs.length > lastLogCount) {
                        for (let i = lastLogCount; i < logs.length; i++) {
                            const log = logs[i];
                            let level = 'info';
                            if (log.message.includes('‚úÖ') || log.message.includes('SUCCESS')) {
                                level = 'success';
                            } else if (log.message.includes('‚ùå') || log.message.includes('ERROR')) {
                                level = 'error';
                            } else if (log.message.includes('‚ö†Ô∏è') || log.message.includes('WARNING')) {
                                level = 'warning';
                            }
                            addDataLog(log.message, level);
                        }
                        lastLogCount = logs.length;
                    }
                    
                    // Stop polling if job is completed
                    if (data.job.status === 'completed' || data.job.status === 'failed' || data.job.status === 'error') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        loadDataManagementStatus();
                    }
                }
            } catch (error) {
                console.error('Error polling job status:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    async function runAllDataJobs() {
        addDataLog('üöÄ ◊û◊™◊ó◊ô◊ú ◊î◊®◊¶◊™ ◊õ◊ú ◊î◊û◊©◊ô◊û◊ï◊™...', 'info');
        
        await runDataJob('daily');
        await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
        await runDataJob('weekly');
    }

    function refreshDataStatus() {
        addDataLog('üîÑ ◊®◊¢◊†◊ï◊ü ◊°◊ò◊ò◊ï◊°...', 'info');
        loadDataManagementStatus();
        addDataLog('‚úÖ ◊°◊ò◊ò◊ï◊° ◊¢◊ï◊ì◊õ◊ü', 'success');
    }

    async function updateSystemHealth() {
        try {
            const response = await fetch('/api/system/health');
            const health = await response.json();
            
            updateHealthIcon('db-health-icon', health.database);
            updateHealthIcon('scheduler-health-icon', health.scheduler);
            updateHealthIcon('api-health-icon', health.api);
            updateHealthIcon('storage-health-icon', health.storage);
            
        } catch (error) {
            console.error('Error updating system health:', error);
        }
    }

    function updateHealthIcon(iconId, status) {
        const icon = document.getElementById(iconId);
        if (!icon) return;
        
        if (status === true || status === 'healthy') {
            icon.style.color = '#38a169'; // Green
        } else if (status === 'warning') {
            icon.style.color = '#d69e2e'; // Yellow
        } else {
            icon.style.color = '#e53e3e'; // Red
        }
    }

    function addDataLog(message, level = 'info') {
        const container = document.getElementById('recent-logs');
        if (!container) return;
        
        const timestamp = new Date().toLocaleTimeString('he-IL');
        const logColors = {
            'success': '#68d391',
            'error': '#fc8181', 
            'warning': '#f6e05e',
            'info': '#63b3ed'
        };
        
        const logEntry = document.createElement('div');
        logEntry.style.color = logColors[level] || logColors.info;
        logEntry.innerHTML = `<span style="opacity: 0.7;">[${timestamp}]</span> ${message}`;
        
        container.appendChild(logEntry);
        container.scrollTop = container.scrollHeight;
        
        // Keep only last 50 log entries
        while (container.children.length > 50) {
            container.removeChild(container.firstChild);
        }
    }

    function viewDataLogs(jobType) {
        window.open(`/api/data-management/logs/${jobType}`, '_blank');
    }

    function downloadDataLogs() {
        const link = document.createElement('a');
        link.href = '/api/data-management/logs/download';
        link.download = `logs_${new Date().toISOString().split('T')[0]}.zip`;
        link.click();
    }

    // Load data management status when the tab is shown
    function initDataManagement() {
        if (document.getElementById('data-management-tab').style.display !== 'none') {
            loadDataManagementStatus();
            // Refresh every 30 seconds
            setInterval(() => {
                if (document.getElementById('data-management-tab').style.display !== 'none') {
                    loadDataManagementStatus();
                }
            }, 30000);
        }
    }

    // Hook into the tab switching function
    const originalShowTabDirect = window.showTabDirect;
    window.showTabDirect = function(tabId) {
        originalShowTabDirect(tabId);
        if (tabId === 'data-management-tab') {
            setTimeout(initDataManagement, 100); // Small delay to ensure tab is visible
        } else if (tabId === 'progressive-ml-tab') {
            setTimeout(initProgressiveML, 100); // Initialize Progressive ML tab
        }
    };

    // Progressive ML Functions
    async function initProgressiveML() {
        await loadProgressiveMLStatus();
        await loadProgressiveModels();
        await loadProgressiveTrainingStatus();
    }

    async function loadProgressiveMLStatus() {
        try {
            const response = await fetch('/api/ml/progressive/status');
            const data = await response.json();
            
            const statusDisplay = document.getElementById('progressive-ml-status-display');
            if (data.status === 'available') {
                statusDisplay.innerHTML = `
                    <div style="color: #10b981;">‚úÖ Progressive ML System Online</div>
                    <div style="font-size: 0.85em; margin-top: 5px;">
                        üìä Data Loader: ${data.data_loader ? '‚úÖ' : '‚ùå'}<br>
                        üèãÔ∏è Trainer: ${data.trainer ? '‚úÖ' : '‚ùå'}<br>
                        üîÆ Predictor: ${data.predictor ? '‚úÖ' : '‚ùå'}<br>
                        üéØ Training: ${data.training?.status || 'Unknown'}
                    </div>
                `;
            } else {
                statusDisplay.innerHTML = '<div style="color: #ef4444;">‚ùå Progressive ML System Unavailable</div>';
            }
        } catch (error) {
            console.error('Error loading Progressive ML status:', error);
            document.getElementById('progressive-ml-status-display').innerHTML = '<div style="color: #ef4444;">‚ùå Error loading status</div>';
        }
    }

    async function loadProgressiveModels() {
        try {
            const response = await fetch('/api/ml/progressive/models');
            const data = await response.json();
            
            const modelsDisplay = document.getElementById('progressive-models-display');
            modelsDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Available Models:</div>
                        ${data.available_models.map(model => `<div style="line-height: 1.4;">‚Ä¢ ${model.toUpperCase()}</div>`).join('')}
                    </div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Training Modes:</div>
                        ${data.available_modes.map(mode => `<div style="line-height: 1.4;">‚Ä¢ ${mode}</div>`).join('')}
                        <div style="font-weight: 600; margin-top: 8px; margin-bottom: 4px;">Models Directory:</div>
                        <div style="line-height: 1.4;">üìÅ ${data.models_saved?.directory || 'N/A'} ${data.models_saved?.found ? '‚úÖ' : '‚ùå'}</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Progressive models:', error);
            document.getElementById('progressive-models-display').innerHTML = '<div style="color: #ef4444;">‚ùå Error loading models</div>';
        }
    }

    async function loadProgressiveTrainingStatus() {
        try {
            const response = await fetch('/api/ml/progressive/training/status');
            const data = await response.json();
            
            const statusDisplay = document.getElementById('progressive-training-status-display');
            statusDisplay.innerHTML = `
                <div style="font-size: 0.85em;">
                    <div><strong>Status:</strong> ${data.training_status?.status || 'Unknown'}</div>
                    <div><strong>Training:</strong> ${data.training_status?.is_training ? 'üîÑ Active' : '‚è∏Ô∏è Idle'}</div>
                    <div><strong>Trainer:</strong> ${data.training_status?.trainer_available ? '‚úÖ Ready' : '‚ùå Not Ready'}</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Progressive training status:', error);
            document.getElementById('progressive-training-status-display').innerHTML = '<div style="color: #ef4444;">‚ùå Error loading training status</div>';
        }
    }

    async function getProgressivePrediction() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const mode = document.getElementById('progressive-mode').value;
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }

        const resultsDiv = document.getElementById('progressive-prediction-results');
        resultsDiv.innerHTML = '<div style="text-align: center;">üîÑ Getting progressive predictions...</div>';

        try {
            const response = await fetch(`/api/ml/progressive/predict/${symbol}?mode=${mode}`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'success' && data.predictions) {
                displayProgressivePredictions(data.predictions, symbol, mode);
            } else {
                resultsDiv.innerHTML = '<div style="color: #ef4444;">‚ùå No predictions available</div>';
            }
        } catch (error) {
            console.error('Error getting progressive prediction:', error);
            resultsDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
        }
    }

    function displayProgressivePredictions(predictions, symbol, mode) {
        const resultsDiv = document.getElementById('progressive-prediction-results');
        
        // Header
        let html = `
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border-radius: 12px; border: 2px solid rgba(59,130,246,0.3);">
                <div style="font-size: 1.8em; font-weight: bold; color: #60a5fa;">üìä Progressive ML Predictions</div>
                <div style="font-size: 1.3em; margin-top: 8px; color: #93c5fd;">${symbol}</div>
            </div>
        `;
        
        // Current Price
        if (predictions.current_price) {
            html += `
                <div style="margin: 15px 0; padding: 20px; background: rgba(34,197,94,0.15); border-radius: 10px; border-left: 4px solid #22c55e;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 0.9em; color: #86efac; margin-bottom: 5px;">üíµ Current Price</div>
                            <div style="font-size: 2em; font-weight: bold; color: #22c55e;">$${predictions.current_price.toFixed(2)}</div>
                        </div>
                        <div style="text-align: right; color: #94a3b8; font-size: 0.85em;">
                            üìÖ ${predictions.current_date || 'Latest'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Predictions for each horizon
        if (predictions.predictions && Object.keys(predictions.predictions).length > 0) {
            html += '<div style="margin: 20px 0;"><div style="font-size: 1.2em; font-weight: bold; color: #60a5fa; margin-bottom: 15px;">üìà Price Predictions</div>';
            
            const horizons = Object.keys(predictions.predictions).sort((a, b) => {
                return parseInt(a) - parseInt(b);
            });
            
            horizons.forEach(horizonKey => {
                const pred = predictions.predictions[horizonKey];
                const priceChange = pred.price_change_pct * 100;
                const isPositive = priceChange > 0;
                const changeColor = isPositive ? '#22c55e' : '#ef4444';
                const changeIcon = isPositive ? 'üìà' : 'üìâ';
                const signalColor = pred.signal === 'BUY' ? '#22c55e' : pred.signal === 'SELL' ? '#ef4444' : '#eab308';
                
                html += `
                    <div style="margin: 12px 0; padding: 18px; background: rgba(30,41,59,0.5); border-radius: 10px; border: 1px solid rgba(71,85,105,0.5); transition: all 0.3s; cursor: pointer;" 
                         onmouseover="this.style.background='rgba(30,41,59,0.8)'; this.style.borderColor='rgba(59,130,246,0.5)'" 
                         onmouseout="this.style.background='rgba(30,41,59,0.5)'; this.style.borderColor='rgba(71,85,105,0.5)'">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="font-size: 1.1em; font-weight: bold; color: #60a5fa;">‚è∞ ${horizonKey.toUpperCase()}</div>
                            <div style="padding: 6px 14px; background: ${signalColor}33; color: ${signalColor}; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                üì° ${pred.signal}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 12px;">
                            
                            <div style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 0.85em; color: #93c5fd; margin-bottom: 4px;">üéØ Target Price</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #60a5fa;">$${pred.target_price.toFixed(2)}</div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(${isPositive ? '34,197,94' : '239,68,68'},0.1); border-radius: 8px; border-left: 3px solid ${changeColor};">
                                <div style="font-size: 0.85em; color: ${changeColor}bb; margin-bottom: 4px;">${changeIcon} Price Change</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: ${changeColor};">${priceChange > 0 ? '+' : ''}${priceChange.toFixed(2)}%</div>
                                <div style="font-size: 0.9em; color: ${changeColor}99; margin-top: 2px;">${pred.price_change_abs > 0 ? '+' : ''}$${pred.price_change_abs.toFixed(2)}</div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(234,179,8,0.1); border-radius: 8px; border-left: 3px solid #eab308;">
                                <div style="font-size: 0.85em; color: #fde047; margin-bottom: 4px;">üé≤ Confidence</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #facc15;">${(pred.confidence * 100).toFixed(1)}%</div>
                                <div style="width: 100%; height: 6px; background: rgba(234,179,8,0.2); border-radius: 3px; margin-top: 6px; overflow: hidden;">
                                    <div style="width: ${pred.confidence * 100}%; height: 100%; background: linear-gradient(90deg, #eab308, #facc15); border-radius: 3px;"></div>
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(168,85,247,0.1); border-radius: 8px; border-left: 3px solid #a855f7;">
                                <div style="font-size: 0.85em; color: #c084fc; margin-bottom: 4px;">üîº Direction</div>
                                <div style="font-size: 1.3em; font-weight: bold; color: #a855f7;">${pred.direction}</div>
                                <div style="font-size: 0.9em; color: #c084fc99; margin-top: 2px;">${(pred.direction_prob * 100).toFixed(1)}% probability</div>
                            </div>
                            
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: rgba(100,116,139,0.1); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.85em; color: #94a3b8;">
                                ü§ñ Based on <strong style="color: #cbd5e1;">${pred.num_models}</strong> model${pred.num_models > 1 ? 's' : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #64748b;">
                                üìä Agreement: ${(100 - pred.model_agreement_std * 100).toFixed(1)}%
                            </div>
                        </div>
                        
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Overall Sentiment
        if (predictions.overall_sentiment) {
            const sentiment = predictions.overall_sentiment;
            const sentimentColor = sentiment.sentiment === 'BULLISH' ? '#22c55e' : 
                                  sentiment.sentiment === 'BEARISH' ? '#ef4444' : '#eab308';
            const sentimentIcon = sentiment.sentiment === 'BULLISH' ? 'üìà' : 
                                 sentiment.sentiment === 'BEARISH' ? 'üìâ' : '‚û°Ô∏è';
            
            html += `
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(168,85,247,0.15)); border-radius: 12px; border: 2px solid rgba(139,92,246,0.3);">
                    <div style="font-size: 1.2em; font-weight: bold; color: #a78bfa; margin-bottom: 15px;">üé≠ Overall Market Sentiment</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                        
                        <div style="padding: 12px; background: rgba(${sentimentColor === '#22c55e' ? '34,197,94' : sentimentColor === '#ef4444' ? '239,68,68' : '234,179,8'},0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Sentiment</div>
                            <div style="font-size: 1.8em;">${sentimentIcon}</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${sentimentColor}; margin-top: 4px;">${sentiment.sentiment}</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(59,130,246,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Strength</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #60a5fa; margin-top: 10px;">${(sentiment.strength * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(234,179,8,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Confidence</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #facc15; margin-top: 10px;">${(sentiment.confidence * 100).toFixed(1)}%</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(168,85,247,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Avg Change</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #a855f7; margin-top: 10px;">${(sentiment.avg_price_change * 100).toFixed(2)}%</div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // Risk Metrics
        if (predictions.risk_metrics) {
            const risk = predictions.risk_metrics;
            const riskColor = risk.risk_level === 'HIGH' ? '#ef4444' : 
                            risk.risk_level === 'MEDIUM' ? '#eab308' : '#22c55e';
            
            html += `
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,146,60,0.1)); border-radius: 12px; border: 2px solid rgba(239,68,68,0.3);">
                    <div style="font-size: 1.2em; font-weight: bold; color: #fca5a5; margin-bottom: 15px;">‚ö†Ô∏è Risk Analysis</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        
                        <div style="padding: 14px; background: rgba(${riskColor === '#22c55e' ? '34,197,94' : riskColor === '#ef4444' ? '239,68,68' : '234,179,8'},0.15); border-radius: 8px; text-align: center; border: 2px solid ${riskColor}44;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">Risk Level</div>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${riskColor}; margin-top: 8px;">${risk.risk_level}</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(251,146,60,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">üìä Volatility</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #fb923c; margin-top: 8px;">${(risk.volatility * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">üìà Max Gain</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #22c55e; margin-top: 8px;">+${(risk.max_gain * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(239,68,68,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">üìâ Max Loss</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #ef4444; margin-top: 8px;">${(risk.max_loss * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(59,130,246,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">‚öñÔ∏è Risk/Reward</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #3b82f6; margin-top: 8px;">${risk.risk_reward_ratio.toFixed(2)}</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(234,179,8,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">üìè Price Range</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #eab308; margin-top: 8px;">$${risk.prediction_range.toFixed(2)}</div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        resultsDiv.innerHTML = html;
    }

    let trainingPollingInterval = null;

    async function startProgressiveTraining() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const mode = document.getElementById('progressive-mode').value;
        const modelSelect = document.getElementById('progressive-model-types');
        const selectedModels = Array.from(modelSelect.selectedOptions).map(option => option.value);
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        if (selectedModels.length === 0) {
            alert('Please select at least one model type');
            return;
        }

        const resultsDiv = document.getElementById('progressive-training-results');
        resultsDiv.innerHTML = '<div style="text-align: center;">üöÄ Starting progressive training...</div>';

        try {
            const response = await fetch(`/api/ml/progressive/train?symbol=${symbol}&model_types=${selectedModels.join(',')}&mode=${mode}`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // New async training returns job_id immediately
            if (data.status === 'training_started' && data.job_id) {
                // Show progress bar
                showTrainingProgress(data.job_id, symbol);
                
                // Start polling for updates
                if (trainingPollingInterval) {
                    clearInterval(trainingPollingInterval);
                }
                
                trainingPollingInterval = setInterval(async () => {
                    await pollTrainingProgress(data.job_id, symbol);
                }, 2000); // Poll every 2 seconds
                
            } else if (data.status === 'training_completed') {
                // Old synchronous response (backward compatibility)
                displayTrainingResults(data, symbol);
            } else {
                resultsDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Training failed or status unknown</div>';
            }
        } catch (error) {
            console.error('Error starting progressive training:', error);
            resultsDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${error.message}</div>`;
        }
    }

    function showTrainingProgress(jobId, symbol) {
        const resultsDiv = document.getElementById('progressive-training-results');
        resultsDiv.innerHTML = `
            <div style="padding: 15px;">
                <div style="color: #10b981; font-size: 1.1em; margin-bottom: 10px;">
                    <strong>ÔøΩ Training ${symbol}</strong>
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 0.9em; color: #9ca3af;" id="training-current-step">Initializing...</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 8px;">
                    <div id="training-progress-bar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85em; font-weight: bold;">
                        0%
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #9ca3af;">
                    <span id="training-progress-text">Progress: 0%</span>
                    <span id="training-eta-text">Calculating ETA...</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.8em; color: #6b7280;">
                    Job ID: <code style="background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 3px;">${jobId}</code>
                </div>
            </div>
        `;
    }

    async function pollTrainingProgress(jobId, symbol) {
        try {
            const response = await fetch(`/api/ml/progressive/training/status/${jobId}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update progress bar
            const progressBar = document.getElementById('training-progress-bar');
            const progressText = document.getElementById('training-progress-text');
            const etaText = document.getElementById('training-eta-text');
            const currentStepText = document.getElementById('training-current-step');
            
            if (progressBar && data.progress !== undefined) {
                const progress = Math.round(data.progress);
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                progressText.textContent = `Progress: ${progress}%`;
            }
            
            if (currentStepText && data.current_step) {
                currentStepText.textContent = data.current_step;
            }
            
            if (etaText && data.eta_seconds !== null && data.eta_seconds !== undefined) {
                const minutes = Math.floor(data.eta_seconds / 60);
                const seconds = Math.round(data.eta_seconds % 60);
                if (minutes > 0) {
                    etaText.textContent = `ETA: ${minutes}m ${seconds}s`;
                } else {
                    etaText.textContent = `ETA: ${seconds}s`;
                }
            } else if (etaText) {
                etaText.textContent = 'Calculating ETA...';
            }
            
            // Check if completed or failed
            if (data.status === 'completed') {
                clearInterval(trainingPollingInterval);
                trainingPollingInterval = null;
                displayTrainingResults(data, symbol);
                await loadProgressiveTrainingStatus();
            } else if (data.status === 'failed') {
                clearInterval(trainingPollingInterval);
                trainingPollingInterval = null;
                const resultsDiv = document.getElementById('progressive-training-results');
                resultsDiv.innerHTML = `<div style="color: #ef4444;">‚ùå Training failed: ${data.error || 'Unknown error'}</div>`;
            }
            
        } catch (error) {
            console.error('Error polling training progress:', error);
            // Don't stop polling on temporary errors
        }
    }

    function displayTrainingResults(data, symbol) {
        const resultsDiv = document.getElementById('progressive-training-results');
        let html = `<div style="color: #10b981;"><strong>‚úÖ Training Completed for ${symbol}</strong></div>`;
        
        html += `<div style="margin: 10px 0; font-size: 0.9em;">`;
        if (data.mode) html += `üìä Mode: ${data.mode}<br>`;
        if (data.model_types) html += `üß† Models: ${data.model_types.join(', ')}<br>`;
        if (data.end_time) html += `‚è∞ Completed: ${new Date(data.end_time).toLocaleString()}<br>`;
        html += `</div>`;
        
        const result = data.result || data.training_result;
        if (result) {
            html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                <strong>üìà Training Results:</strong><br>
                <pre style="font-size: 0.8em; overflow-x: auto; max-height: 300px;">${JSON.stringify(result, null, 2)}</pre>
            </div>`;
        }
        
        resultsDiv.innerHTML = html;
    }

    // ============================================
    // Advanced Backtesting Functions
    // ============================================

    // Update accuracy slider display
    document.addEventListener('DOMContentLoaded', function() {
        const accuracySlider = document.getElementById('backtest-target-accuracy');
        if (accuracySlider) {
            accuracySlider.addEventListener('input', (e) => {
                document.getElementById('accuracy-display').textContent = e.target.value + '%';
            });
        }
    });

    let backtestPollingInterval = null;
    let backtestChart = null;

    async function startBacktesting() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const startDate = document.getElementById('backtest-start-date').value;
        const endDate = document.getElementById('backtest-end-date').value;
        const testPeriod = parseInt(document.getElementById('backtest-test-period').value);
        const maxIterations = parseInt(document.getElementById('backtest-max-iterations').value);
        const targetAccuracy = parseFloat(document.getElementById('backtest-target-accuracy').value) / 100;
        const autoStop = document.getElementById('backtest-auto-stop').checked;
        const modelSelect = document.getElementById('progressive-model-types');
        const selectedModels = Array.from(modelSelect.selectedOptions).map(option => option.value);

        // Validation
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }

        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        if (new Date(startDate) >= new Date(endDate)) {
            alert('Start date must be before end date');
            return;
        }

        if (selectedModels.length === 0) {
            alert('Please select at least one model type');
            return;
        }

        // Show progress
        document.getElementById('backtest-progress').style.display = 'block';
        document.getElementById('backtest-results-container').style.display = 'none';
        document.getElementById('backtest-chart-container').style.display = 'none';
        document.getElementById('backtest-status-text').textContent = 'Starting backtest...';
        document.getElementById('backtest-progress-fill').style.width = '0%';

        try {
            const response = await fetch('/api/ml/progressive/backtest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    symbol: symbol,
                    train_start_date: startDate,
                    train_end_date: endDate,
                    test_period_days: testPeriod,
                    max_iterations: maxIterations,
                    target_accuracy: targetAccuracy,
                    auto_stop: autoStop,
                    model_types: selectedModels
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.status === 'success') {
                displayBacktestResults(data.backtest_results);
            } else {
                document.getElementById('backtest-status-text').textContent = 'Backtest failed';
                alert('Backtesting failed: ' + (data.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Error starting backtest:', error);
            document.getElementById('backtest-status-text').textContent = 'Error: ' + error.message;
            alert('Error starting backtest: ' + error.message);
        }
    }

    function stopBacktesting() {
        if (backtestPollingInterval) {
            clearInterval(backtestPollingInterval);
            backtestPollingInterval = null;
        }
        document.getElementById('backtest-status-text').textContent = 'Stopped';
    }

    function displayBacktestResults(results) {
        if (!results || !results.all_iterations) {
            alert('No results to display');
            return;
        }

        // Hide progress, show results
        document.getElementById('backtest-progress').style.display = 'none';
        document.getElementById('backtest-results-container').style.display = 'block';
        document.getElementById('backtest-chart-container').style.display = 'block';

        // Populate table
        const tbody = document.getElementById('backtest-results-tbody');
        tbody.innerHTML = '';

        results.all_iterations.forEach((iter, index) => {
            const row = tbody.insertRow();
            const isBest = (iter.iteration === results.best_iteration);
            
            row.innerHTML = `
                <td style="padding: 8px;">${iter.iteration}</td>
                <td style="padding: 8px;">${iter.train_until}</td>
                <td style="padding: 8px; color: ${iter.accuracy >= 0.85 ? '#10b981' : '#f59e0b'};">${(iter.accuracy * 100).toFixed(1)}%</td>
                <td style="padding: 8px;">${iter.val_loss ? iter.val_loss.toFixed(4) : 'N/A'}</td>
                <td style="padding: 8px;">${iter.training_time ? iter.training_time.toFixed(1) + 's' : 'N/A'}</td>
                <td style="padding: 8px;">${isBest ? '‚úÖ Best' : ''}</td>
            `;
        });

        // Create chart
        createBacktestChart(results);
    }

    function createBacktestChart(results) {
        const ctx = document.getElementById('backtest-chart').getContext('2d');

        // Destroy existing chart if any
        if (backtestChart) {
            backtestChart.destroy();
        }

        const iterations = results.all_iterations.map(iter => `Iter ${iter.iteration}`);
        const accuracies = results.all_iterations.map(iter => iter.accuracy * 100);
        const losses = results.all_iterations.map(iter => iter.val_loss || 0);

        backtestChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: iterations,
                datasets: [
                    {
                        label: 'Accuracy (%)',
                        data: accuracies,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Loss',
                        data: losses,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Backtest Performance Over Iterations',
                        color: '#e2e8f0'
                    },
                    legend: {
                        labels: {
                            color: '#e2e8f0'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#e2e8f0' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Accuracy (%)',
                            color: '#e2e8f0'
                        },
                        ticks: { color: '#e2e8f0' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Loss',
                            color: '#e2e8f0'
                        },
                        ticks: { color: '#e2e8f0' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // ============================================
    // Settings Manager
    // ============================================
    
    class SettingsManager {
        constructor() {
            this.storageKey = 'marketpulse_settings';
            this.defaults = {
                // Update Settings
                updateInterval: 30,
                autoRefresh: true,
                enableWebSocket: true,
                
                // Display Settings
                darkMode: true,
                compactView: false,
                showCharts: true,
                
                // AI & ML Settings
                enableMLPredictions: true,
                keywordThreshold: 0.3,
                highScoreThreshold: 0.7,
                
                // Hot Stocks Scanner
                hotStocksReturnThreshold: 1.0,
                hotStocksConfidenceThreshold: 0.55,
                hotStocksLimit: 5,
                hotStocksAutoRefresh: true,
                
                // Progressive ML Training
                trainingEpochs: 100,
                trainingBatchSize: 32,
                trainingSequenceLength: 60,
                trainingLearningRate: 0.001,
                
                // Notification Settings
                enableNotifications: false,
                maxArticles: 50,
                
                // Debug
                debugMode: false
            };
            
            this.settings = this.loadSettings();
        }
        
        loadSettings() {
            try {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    return { ...this.defaults, ...JSON.parse(stored) };
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            return { ...this.defaults };
        }
        
        saveSettings() {
            try {
                // Collect all settings from form
                const settings = {};
                
                for (const key in this.defaults) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            settings[key] = element.checked;
                        } else if (element.type === 'number') {
                            settings[key] = parseFloat(element.value);
                        } else {
                            settings[key] = element.value;
                        }
                    }
                }
                
                this.settings = settings;
                localStorage.setItem(this.storageKey, JSON.stringify(settings));
                
                alert('‚úÖ Settings saved successfully!');
                console.log('üíæ Settings saved:', settings);
                
                // Apply settings immediately
                this.applySettings();
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('‚ùå Error saving settings');
            }
        }
        
        resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                this.settings = { ...this.defaults };
                localStorage.removeItem(this.storageKey);
                this.applySettingsToForm();
                alert('‚úÖ Settings reset to defaults');
                console.log('üîÑ Settings reset');
            }
        }
        
        applySettingsToForm() {
            for (const key in this.settings) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = this.settings[key];
                    } else {
                        element.value = this.settings[key];
                    }
                }
            }
        }
        
        applySettings() {
            // Apply auto-refresh interval
            if (window.marketDataManager && this.settings.autoRefresh) {
                window.marketDataManager.startPeriodicUpdates(this.settings.updateInterval * 1000);
            }
            
            // Apply other settings as needed
            console.log('‚öôÔ∏è Settings applied');
        }
        
        exportSettings() {
            const dataStr = JSON.stringify(this.settings, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'marketpulse_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('üì• Settings exported');
        }
        
        getSetting(key) {
            return this.settings[key] !== undefined ? this.settings[key] : this.defaults[key];
        }
    }
    
    // Settings import handler (replaces legacy main.js handler)
    function handleSettingsImport(input) {
        try {
            const file = input && input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    // Persist and apply
                    localStorage.setItem('marketpulse_settings', JSON.stringify(settings));
                    if (window.settingsManager && typeof window.settingsManager.applySettingsToForm === 'function') {
                        window.settingsManager.settings = settings;
                        window.settingsManager.applySettingsToForm();
                    }
                    alert('‚úÖ Settings imported successfully');
                } catch (err) {
                    console.error('Error importing settings:', err);
                    alert('‚ùå Invalid settings file');
                }
            };
            reader.readAsText(file);
        } catch (err) {
            console.error('Error handling settings import:', err);
        }
    }

    // Initialize settings manager
    window.settingsManager = new SettingsManager();

    // Initialize Market Data Manager
    let marketDataManager;
    
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Initializing Market Data Manager...');
        
        // Apply settings to form
        window.settingsManager.applySettingsToForm();
        
        if (typeof MarketDataManager !== 'undefined') {
            marketDataManager = new MarketDataManager();
            window.marketDataManager = marketDataManager; // Make it globally accessible
            await marketDataManager.init();
            
            // Update market intelligence
            await marketDataManager.updateMarketIntelligence();
            await marketDataManager.updateGeopoliticalRisks();
            
            // Start periodic updates (using settings)
            const interval = window.settingsManager.getSetting('updateInterval') * 1000;
            if (window.settingsManager.getSetting('autoRefresh')) {
                marketDataManager.startPeriodicUpdates(interval);
            }
            
            console.log('‚úÖ Market Data Manager ready and running');
        } else {
            console.error('‚ùå MarketDataManager not loaded - check market-data.js');
        }
    });

    </script>
</body>
</html>