<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPulse Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Load JavaScript modules with cache busting -->
    <script src="/static/js/modules/market-data.js?v=20251020" defer></script>
    <script src="/static/js/modules/chart-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/alerts-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/ml-scanner.js?v=20251020" defer></script>
    <script src="/static/js/modules/settings-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/websocket-client.js?v=20251020" defer></script>
    <!-- DISABLED: Old main.js conflicts with new AI Analysis - use inline functions instead -->
    <!-- <script src="/static/js/main.js?v=20251020" defer></script> -->
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .header h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 4px;
        }
        .subtitle { font-size: 0.85em; opacity: 0.8; margin-bottom: 6px; }
        .live-status {
            display: inline-block;
            background: rgba(16, 185, 129, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #10b981;
        }
        .market-header {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .market-indices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 8px;
        }
        .index-item {
            text-align: center;
            background: rgba(255,255,255,0.04);
            padding: 10px;
            border-radius: 8px;
        }
        .index-name { font-size: 0.75em; opacity: 0.7; margin-bottom: 3px; }
        .index-value { font-size: 1.1em; font-weight: bold; margin-bottom: 3px; }
        .index-change {
            font-size: 0.8em;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 500;
        }
        .positive { color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .negative { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        .last-update { text-align: center; font-size: 0.75em; opacity: 0.6; }
        .sentiment-bar-container {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sentiment-label { font-size: 0.85em; font-weight: 600; white-space: nowrap; }
        .sentiment-bar {
            flex: 1;
            height: 8px;
            background: #2d3748;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .sentiment-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            width: 54%;
            border-radius: 5px;
        }
        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 12px;
            justify-content: center;
        }
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .tab.active { background: rgba(255,255,255,0.15); color: #ffd700; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .section h3 {
            color: #ffd700;
            border-bottom: 2px solid rgba(255,255,255,0.15);
            padding-bottom: 6px;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .ai-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .ai-grid .ai-card:last-child {
            grid-column: 1 / -1; /* Hot Stocks takes full width */
        }
        .ai-card {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .ai-card h4 { color: #ffd700; font-size: 0.95em; margin-bottom: 8px; }
        .loading-text { color: #10b981; font-size: 0.85em; font-style: italic; }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .status-item {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
        }
        .status-icon { font-size: 1.5em; margin-bottom: 4px; }
        .status-label { font-size: 0.75em; opacity: 0.8; }
        .status-name { font-size: 0.7em; opacity: 0.6; margin-top: 2px; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .metric-item {
            text-align: center;
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        .metric-value { font-size: 1.3em; font-weight: bold; color: #3b82f6; }
        .metric-label { font-size: 0.75em; opacity: 0.8; margin-top: 3px; }
        .btn-analyze {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-analyze:hover { background: #2563eb; }
        
        /* Settings Tab Styles */
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .settings-group {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .settings-group h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .setting-item {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .setting-item label {
            font-size: 0.85em;
            color: #cbd5e0;
            font-weight: 500;
        }
        .setting-item input[type="number"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .setting-item input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .checkbox-setting {
            flex-direction: row !important;
            align-items: center;
            gap: 8px;
        }
        .checkbox-setting input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
            cursor: pointer;
        }
        .checkbox-setting label {
            cursor: pointer;
            margin: 0;
        }
        .settings-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .save-btn, .reset-btn, .export-btn, .import-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .save-btn {
            background: #10b981;
            color: white;
        }
        .save-btn:hover { background: #059669; }
        .reset-btn {
            background: #f59e0b;
            color: white;
        }
        .reset-btn:hover { background: #d97706; }
        .export-btn, .import-btn {
            background: #3b82f6;
            color: white;
        }
        .export-btn:hover, .import-btn:hover { background: #2563eb; }
        
        /* AI Analysis Tab Styles */
        .ai-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .ai-selector-card, .ai-prediction-card, .ai-timeseries-card, .ai-risk-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .ai-selector-card h4, .ai-prediction-card h4, .ai-timeseries-card h4, .ai-risk-card h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .stock-selector select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .stock-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .prediction-item, .timeseries-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .prediction-label, .metric-name {
            font-size: 0.85em;
            color: #cbd5e0;
        }
        .prediction-value, .metric-value {
            font-weight: 600;
            font-size: 0.85em;
        }
        .prediction-value.bullish, .metric-value.bullish { color: #10b981; }
        .prediction-value.bearish, .metric-value.bearish { color: #ef4444; }
        .prediction-value.neutral, .metric-value.neutral { color: #f59e0b; }
        .risk-gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(to right, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 60px 60px 0 0;
        }
        .risk-indicator {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .risk-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 50px;
            background: #ffffff;
            transform-origin: bottom;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.5s ease;
        }
        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            margin-top: 5px;
        }
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        /* Hot Stocks Grid Styles */
        .hot-stocks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;  
            margin-top: 10px;
        }
        .hot-stock-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        .hot-stock-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .stock-symbol {
            font-weight: bold;
            color: #3b82f6;
            font-size: 0.9em;
        }
        .stock-price {
            font-size: 0.85em;
            color: #e2e8f0;
        }
        .stock-return {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .stock-return.change-positive {
            color: #10b981;
        }
        .stock-return.change-negative {
            color: #ef4444;
        }
        .stock-details {
            font-size: 0.8em;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        /* Responsive adjustments for hot stocks */
        @media (max-width: 1200px) {
            .hot-stocks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .hot-stocks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MarketPulse üìä</h1>
            <p class="subtitle">Real-Time Financial Intelligence Platform</p>
            <p>Live market data ‚Ä¢ AI-powered analysis ‚Ä¢ Smart alerts ‚Ä¢ Stock insights</p>
            <div class="live-status">üöÄ LIVE MARKET DATA</div>
        </div>

        <div class="market-header">
            <div class="market-indices">
                <div class="index-item" data-index="VIX">
                    <div class="index-name">VIX</div>
                    <div class="index-value" id="VIX-value">--</div>
                    <div class="index-change" id="VIX-change">Loading...</div>
                </div>
                <div class="index-item" data-index="RUSSELL2000">
                    <div class="index-name">RUSSELL 2000</div>
                    <div class="index-value" id="RUSSELL2000-value">--</div>
                    <div class="index-change" id="RUSSELL2000-change">Loading...</div>
                </div>
                <div class="index-item" data-index="DOW">
                    <div class="index-name">DOW JONES</div>
                    <div class="index-value" id="DOW-value">--</div>
                    <div class="index-change" id="DOW-change">Loading...</div>
                </div>
                <div class="index-item" data-index="NASDAQ">
                    <div class="index-name">NASDAQ</div>
                    <div class="index-value" id="NASDAQ-value">--</div>
                    <div class="index-change" id="NASDAQ-change">Loading...</div>
                </div>
                <div class="index-item" data-index="SP500">
                    <div class="index-name">S&P 500</div>
                    <div class="index-value" id="SP500-value">--</div>
                    <div class="index-change" id="SP500-change">Loading...</div>
                </div>
            </div>
            <div class="last-update" id="last-update">Connecting...</div>
        </div>

        <div class="sentiment-bar-container">
            <span class="sentiment-label" id="sentiment-label">Connecting...</span>
            <div class="sentiment-bar">
                <div class="sentiment-fill" id="sentiment-fill" style="width: 0%;"></div>
            </div>
            <span class="sentiment-label">Market Sentiment üìà</span>
        </div>

        <div class="tabs">
            <button class="tab" data-tab="settings-tab" onclick="showTabDirect('settings-tab')">Settings ‚öôÔ∏è</button>
            <button class="tab" data-tab="articles-tab" onclick="showTabDirect('articles-tab')">Articles üìÑ</button>
            <button class="tab" data-tab="ai-tab" onclick="showTabDirect('ai-tab')">AI Analysis ü§ñ</button>
            <button class="tab" data-tab="ml-tab" onclick="showTabDirect('ml-tab')">ML Training üß†</button>
            <button class="tab" data-tab="financial-tab" onclick="showTabDirect('financial-tab')">Finance üí∞</button>
            <button class="tab" data-tab="geopolitics-tab" onclick="showTabDirect('geopolitics-tab')">Geopolitics üåç</button>
            <button class="tab" data-tab="watchlist-tab" onclick="showTabDirect('watchlist-tab')">Watchlist ‚≠ê</button>
            <button class="tab active" data-tab="overview-tab" onclick="showTabDirect('overview-tab')">Overview üìä</button>
        </div>
        
        <!-- Tab Contents -->
        <div id="overview-tab" class="tab-content active">
            <!-- Overview content here -->
        
        <div class="section">
            <h3>MarketPulse AI Intelligence ü§ñ</h3>
            <div class="ai-grid">
                <div class="ai-card">
                    <h4>Market Intelligence Dashboard üß†</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Market Sentiment</strong>
                        <div class="loading-text" id="market-sentiment-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Overall Market</strong>
                        <div class="loading-text" id="overall-market-display">...Loading</div>
                    </div>
                </div>
                <div class="ai-card">
                    <h4>Risk Assessment ‚ö†Ô∏è</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #ef4444;">Market Risk (VIX)</strong>
                        <div class="loading-text" id="market-risk-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0; font-size: 0.75em; opacity: 0.7;">
                        <div id="risk-interpretation">Analyzing market volatility...</div>
                    </div>
                </div>
                <!-- Geopolitical Risks Card -->
                <div class="ai-card" id="geopolitical-card">
                    <h4>Geopolitical Risks üåç</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #f59e0b;">Current Events</strong>
                        <div class="loading-text" id="geopolitical-events">Loading geopolitical risks...</div>
                    </div>
                    <div style="margin-top:8px; font-size:0.85em; opacity:0.8;" id="geopolitical-summary"></div>
                </div>
                <!-- Hot Stocks Card -->
                <div class="ai-card">
                    <h4>AI Hot Stocks üî•</h4>
                    <div id="hot-alerts" style="margin: 8px 0;">
                        <p style="text-align: center; opacity: 0.6;">Scanning for hot opportunities...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Top Market Movers üìà</h3>
            <div id="top-movers" style="display: grid; gap: 10px;">
                <p style="text-align: center; opacity: 0.6;">Loading top market movers...</p>
            </div>
        </div>

        <div class="section">
            <h3>AI Models Status ü§ñ</h3>
            <div class="status-grid" id="ai-models-status">
                <div class="status-item">
                    <div class="status-icon">‚è≥</div>
                    <div class="status-label">Loading...</div>
                    <div class="status-name">Checking status</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>ML Intelligence Dashboard üß†</h3>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="market-sentiment-value">Loading...</div>
                    <div class="metric-label" id="market-sentiment-label">Market Sentiment</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="risk-level-value">Loading...</div>
                    <div class="metric-label" id="risk-level-label">Risk Level</div>
                </div>
            </div>
            <div id="ai-recommendations" style="margin-top: 15px;">
                <h4 style="color: #ffd700; margin-bottom: 10px;">AI Recommendations</h4>
                <p style="text-align: center; opacity: 0.6;">Analyzing market conditions...</p>
            </div>
        </div>

        </div>
        <!-- End Overview Tab -->
        
        <!-- AI Analysis Tab -->
        <div id="ai-tab" class="tab-content">
            <div class="section">
                <h3>ü§ñ AI Market Intelligence</h3>
                <div id="ai-intelligence-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading AI market intelligence...</p>
                </div>
                
                <div class="ai-analysis-grid">
                    <!-- Stock Input -->
                    <div class="ai-selector-card">
                        <h4>ü§ñ AI Stock Analysis</h4>
                        <div class="stock-selector">
                            <input type="text" id="ai-stock-input" placeholder="Enter stock symbol (e.g., AAPL)" 
                                   style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em; text-transform: uppercase;">
                            <div style="display: flex; gap: 5px; margin-top: 8px;">
                                <button onclick="analyzeStock()" style="flex: 1; background: #3b82f6; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    üîç Analyze Stock
                                </button>
                                <button onclick="debugPrompt()" style="flex: 1; background: #f59e0b; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    üêõ Debug Prompt
                                </button>
                            </div>
                        </div>
                        <div id="selected-stock-analysis" style="margin-top: 15px;">
                            <p style="text-align: center; opacity: 0.6;">Enter a stock symbol above for comprehensive AI analysis</p>
                        </div>
                    </div>

                    <!-- AI Comprehensive Analysis -->
                    <div class="ai-prediction-card">
                        <h4>üéØ AI Comprehensive Analysis</h4>
                        <div id="ai-comprehensive-results">
                            <div class="prediction-item">
                                <span class="prediction-label">Overall Prediction:</span>
                                <span class="prediction-value neutral">Waiting for analysis</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Confidence Level:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Target Price:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Technical Analysis -->
                    <div class="ai-timeseries-card">
                        <h4>üìä AI Technical Analysis</h4>
                        <div id="ai-technical-results">
                            <div class="timeseries-metric">
                                <span class="metric-name">Trend Direction:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Support Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Resistance Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">RSI Signal:</span>
                                <span class="metric-value">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Risk Assessment -->
                    <div class="ai-risk-card">
                        <h4>‚ö†Ô∏è AI Risk Assessment</h4>
                        <div id="ai-risk-assessment">
                            <div class="risk-gauge">
                                <div class="risk-indicator" id="ai-risk-indicator">
                                    <div class="risk-needle"></div>
                                </div>
                                <div class="risk-labels">
                                    <span class="risk-low">Low</span>
                                    <span class="risk-medium">Medium</span>
                                    <span class="risk-high">High</span>
                                </div>
                            </div>
                            <div id="ai-risk-factors">
                                <p style="text-align: center; opacity: 0.6;">Enter a stock symbol for AI risk analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Articles Tab -->
        <div id="articles-tab" class="tab-content">
            <div class="section">
                <h3>Active Alerts üö®</h3>
                <div id="alerts-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading active alerts...</p>
                </div>
                
                <h3>Recent Articles üìÑ</h3>
                <div id="articles-container">
                    <p style="text-align: center; opacity: 0.6;">Loading recent articles...</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section">
                <h3>‚öôÔ∏è System Settings</h3>
                <div class="settings-container">
                    <!-- Update Settings -->
                    <div class="settings-group">
                        <h4>üîÑ Update Settings</h4>
                        <div class="setting-item">
                            <label for="updateInterval">Auto-refresh interval (seconds):</label>
                            <input type="number" id="updateInterval" min="5" max="300" value="30">
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">Enable auto-refresh</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableWebSocket" checked>
                            <label for="enableWebSocket">Enable real-time updates</label>
                        </div>
                    </div>

                    <!-- Display Settings -->
                    <div class="settings-group">
                        <h4>üé® Display Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="darkMode" checked>
                            <label for="darkMode">Dark mode</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="compactView">
                            <label for="compactView">Compact view</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="showCharts" checked>
                            <label for="showCharts">Show charts</label>
                        </div>
                    </div>

                    <!-- AI & ML Settings -->
                    <div class="settings-group">
                        <h4>ü§ñ AI & ML Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableMLPredictions" checked>
                            <label for="enableMLPredictions">Enable ML predictions</label>
                        </div>
                        <div class="setting-item">
                            <label for="keywordThreshold">Keyword relevance threshold:</label>
                            <input type="number" id="keywordThreshold" min="0" max="1" step="0.1" value="0.3">
                        </div>
                        <div class="setting-item">
                            <label for="highScoreThreshold">High score threshold:</label>
                            <input type="number" id="highScoreThreshold" min="0" max="1" step="0.1" value="0.7">
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="settings-group">
                        <h4>üîî Notifications</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableNotifications">
                            <label for="enableNotifications">Enable browser notifications</label>
                        </div>
                        <div class="setting-item">
                            <label for="maxArticles">Maximum articles to display:</label>
                            <input type="number" id="maxArticles" min="10" max="500" value="50">
                        </div>
                    </div>

                    <!-- Debug Settings -->
                    <div class="settings-group">
                        <h4>üêõ Debug</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="debugMode">
                            <label for="debugMode">Enable debug mode</label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-actions">
                        <button class="save-btn" onclick="window.settingsManager?.saveSettings()">üíæ Save Settings</button>
                        <button class="reset-btn" onclick="window.settingsManager?.resetSettings()">üîÑ Reset to Defaults</button>
                        <button class="export-btn" onclick="window.settingsManager?.exportSettings()">üì• Export Settings</button>
                        <input type="file" id="importSettings" accept=".json" style="display: none;" onchange="handleSettingsImport(this)">
                        <button class="import-btn" onclick="document.getElementById('importSettings').click()">üì§ Import Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ML Training Tab -->
        <div id="ml-tab" class="tab-content">
            <div class="section">
                <h3>üß† Machine Learning Training & Predictions</h3>
                
                <!-- ML Status Section -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>ü§ñ ML System Status</h4>
                        <div id="ml-status-display">Loading ML status...</div>
                    </div>
                    <div class="ai-card">
                        <h4>üìä Training Statistics</h4>
                        <div id="training-stats-display">Loading training stats...</div>
                    </div>
                </div>

                <!-- Symbol Analysis & Training -->
                <div class="settings-container">
                    <div class="settings-group">
                        <h4>üéØ Symbol Analysis & Training</h4>
                        <div class="setting-item">
                            <label for="ml-symbol">Stock Symbol:</label>
                            <input type="text" id="ml-symbol" placeholder="e.g., AAPL" value="AAPL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <div class="setting-item">
                            <label for="training-days">Training Period (days):</label>
                            <input type="number" id="training-days" min="30" max="3650" value="365">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="getPrediction()" style="flex: 1; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üîÆ Get Prediction
                            </button>
                            <button onclick="trainModel()" style="flex: 1; background: #3b82f6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üèãÔ∏è Train Model
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>üìà Prediction Results</h4>
                        <div id="prediction-results" style="min-height: 100px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center;">Select a symbol and click "Get Prediction" to see ML predictions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Data Tab -->
        <div id="financial-tab" class="tab-content">
            <div class="section">
                <h3>üí∞ Enhanced Financial Analytics</h3>
                
                <!-- Sector Performance -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>üìä Sector Performance</h4>
                        <div id="sector-performance-display">Loading sector data...</div>
                    </div>
                    <div class="ai-card">
                        <h4>üíπ Market Sentiment</h4>
                        <div id="market-sentiment-detailed">Loading sentiment analysis...</div>
                    </div>
                </div>

                <!-- Symbol-specific Analysis -->
                <div class="settings-container">
                    <div class="settings-group">
                        <h4>üéØ Symbol Analysis</h4>
                        <div class="setting-item">
                            <label for="financial-symbol">Stock Symbol:</label>
                            <input type="text" id="financial-symbol" placeholder="e.g., AAPL" value="AAPL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="getMarketData()" style="flex: 1; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üìà Market Data
                            </button>
                            <button onclick="getSentiment()" style="flex: 1; background: #8b5cf6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                üí≠ Sentiment
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>üìä Analysis Results</h4>
                        <div id="financial-results" style="min-height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center;">Enter a symbol and select analysis type</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geopolitics Tab -->
        <div id="geopolitics-tab" class="tab-content">
            <div class="section">
                <h3>üåç Geopolitical Risk Analysis</h3>
                
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>‚ö†Ô∏è Risk Assessment</h4>
                        <div id="risk-assessment-display">Loading risk analysis...</div>
                    </div>
                    <div class="ai-card">
                        <h4>üåê Global Factors</h4>
                        <div id="global-factors-display">Loading global factors...</div>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>üìã Risk Factors & Recommendations</h4>
                    <div id="geopolitical-details" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="opacity: 0.6; text-align: center;">Loading detailed geopolitical analysis...</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="loadGeopoliticalData()" style="background: #ef4444; border: none; padding: 12px 24px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        üîÑ Refresh Risk Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist-tab" class="tab-content">
            <div class="section">
                <h3>‚≠ê Investment Watchlist</h3>
                
                <div class="settings-container" style="margin-bottom: 20px;">
                    <div class="settings-group">
                        <h4>‚ûï Add to Watchlist</h4>
                        <div class="setting-item">
                            <label for="watchlist-symbol">Stock Symbol:</label>
                            <input type="text" id="watchlist-symbol" placeholder="e.g., GOOGL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <button onclick="addToWatchlist()" style="width: 100%; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; margin-top: 10px;">
                            ‚≠ê Add Symbol
                        </button>
                    </div>
                    
                    <div class="settings-group">
                        <h4>‚öôÔ∏è Watchlist Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="auto-refresh-watchlist" checked>
                            <label for="auto-refresh-watchlist">Auto-refresh watchlist</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="price-alerts" checked>
                            <label for="price-alerts">Price change alerts</label>
                        </div>
                    </div>
                </div>

                <div class="ai-card">
                    <h4>üìä My Watchlist</h4>
                    <div id="watchlist-display">
                        <p style="opacity: 0.6; text-align: center;">Loading watchlist...</p>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="loadWatchlist()" style="background: #3b82f6; border: none; padding: 8px 16px; border-radius: 6px; color: white; cursor: pointer;">
                            üîÑ Refresh Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
            <p style="font-size: 0.8em; opacity: 0.6;">
                <strong>Architecture:</strong> FastAPI ‚Ä¢ PostgreSQL ‚Ä¢ Redis ‚Ä¢ Qdrant ‚Ä¢ Celery üèóÔ∏è<br>
                <strong>Deployment:</strong> Docker Containers ‚Ä¢ Production Ready ‚Ä¢ Scalable üöÄ<br>
                <strong>Status:</strong> Full Production System Running Successfully üåê
            </p>
        </div>
    </div>
    
    <script>
    // Tab Management Functions (unified from main.js)
    function showTab(tabName) {
        console.log('üîÑ Switching to tab:', tabName);
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab content
        const selectedContent = document.getElementById(tabName);
        if (selectedContent) {
            selectedContent.classList.add('active');
            console.log('‚úÖ Tab content shown:', tabName);
        } else {
            console.error('‚ùå Tab content not found:', tabName);
        }

        // Add active class to selected tab button
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
            console.log('‚úÖ Tab button activated');
        } else {
            console.error('‚ùå Tab button not found for:', tabName);
        }
    }

    // Direct tab switching function for debugging
    function showTabDirect(tabName) {
        console.log('üîÑ Direct tab switch to:', tabName);
        showTab(tabName);
    }

    // Make functions globally available
    window.showTab = showTab;
    window.showTabDirect = showTabDirect;
    
    // Make function globally available
    window.showTabDirect = showTabDirect;

    // ===============================
    // NEW FUNCTIONALITY FOR ENHANCED FEATURES
    // ===============================

    // ML Functions
    async function getPrediction() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üîÑ Getting ML prediction...</p>';
        
        try {
            const response = await fetch(`/api/ml/predictions/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #3b82f6; margin-bottom: 10px;">üîÆ ML Prediction for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                        <strong>Direction:</strong> ${data.predictions?.direction || 'N/A'}<br>
                        <strong>Confidence:</strong> ${data.predictions?.confidence || 'N/A'}<br>
                        <strong>Target Price:</strong> $${data.predictions?.target_price || 'N/A'}
                    </div>
                    <small style="opacity: 0.7;">Generated: ${new Date().toLocaleString()}</small>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå ${data.message || 'Failed to get prediction'}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    async function trainModel() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        const days = document.getElementById('training-days').value;
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üèãÔ∏è Training model... This may take a while...</p>';
        
        try {
            const response = await fetch(`/api/ml/train/${symbol}?days_back=${days}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">‚úÖ Training Completed for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Training Period:</strong> ${days} days<br>
                        <strong>Status:</strong> ${data.training_result?.status || 'Completed'}<br>
                        <strong>Model Performance:</strong> ${data.training_result?.accuracy || 'N/A'}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Training failed: ${data.message}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    // Financial Functions
    async function getMarketData() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üìà Loading market data...</p>';
        
        try {
            const response = await fetch(`/api/market/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const marketData = data.data;
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">üìà Market Data for ${symbol}</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Price:</strong> $${marketData.price}<br>
                            <strong>Change:</strong> ${marketData.change} (${marketData.change_percent})
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Volume:</strong> ${marketData.volume?.toLocaleString()}<br>
                            <strong>Range:</strong> $${marketData.low} - $${marketData.high}
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Failed to load data</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    async function getSentiment() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">üí≠ Analyzing sentiment...</p>';
        
        try {
            const response = await fetch(`/api/sentiment/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const sentiment = data.sentiment;
                resultsDiv.innerHTML = `
                    <h5 style="color: #8b5cf6; margin-bottom: 10px;">üí≠ Sentiment Analysis for ${symbol}</h5>
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Overall Score:</strong> ${sentiment.overall_score}<br>
                        <strong>Positive:</strong> ${(sentiment.positive * 100).toFixed(1)}%<br>
                        <strong>Negative:</strong> ${(sentiment.negative * 100).toFixed(1)}%<br>
                        <strong>Volume:</strong> ${sentiment.volume} mentions<br>
                        <strong>Trending:</strong> ${sentiment.trending ? 'üî• Yes' : 'üìä Normal'}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Failed to analyze sentiment</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
        }
    }

    // Geopolitical Functions
    async function loadGeopoliticalData() {
        const riskDiv = document.getElementById('risk-assessment-display');
        const factorsDiv = document.getElementById('global-factors-display');
        const detailsDiv = document.getElementById('geopolitical-details');
        
        riskDiv.innerHTML = 'üîÑ Loading...';
        factorsDiv.innerHTML = 'üîÑ Loading...';
        detailsDiv.innerHTML = '<p style="text-align: center;">üîÑ Loading detailed analysis...</p>';
        
        try {
            const response = await fetch('/api/financial/geopolitical-risks');
            const data = await response.json();
            
            if (data.status === 'success') {
                const riskData = data.data;
                
                // Update risk assessment
                riskDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">‚ö†Ô∏è</div>
                        <strong>Risk Level: ${riskData.overall_risk_level}</strong><br>
                        <span style="font-size: 1.2em; color: #ffd700;">Score: ${riskData.risk_score}</span>
                    </div>
                `;
                
                // Update global factors
                factorsDiv.innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>Active Factors:</strong><br>
                        ${riskData.factors?.length || 0} regions monitored<br>
                        Next update: ${new Date(riskData.next_update).toLocaleTimeString()}
                    </div>
                `;
                
                // Update detailed analysis
                let factorsHtml = '';
                if (riskData.factors) {
                    factorsHtml = riskData.factors.map(factor => `
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                            <strong>${factor.region}</strong> - ${factor.risk_type}<br>
                            <span style="color: #ffd700;">Level: ${factor.level}</span> | 
                            <span style="color: #10b981;">Impact: ${factor.impact}</span><br>
                            <small>${factor.description}</small>
                        </div>
                    `).join('');
                }
                
                let recommendationsHtml = '';
                if (riskData.recommendations) {
                    recommendationsHtml = `
                        <h5 style="color: #3b82f6; margin: 15px 0 10px;">üìã Recommendations:</h5>
                        ${riskData.recommendations.map(rec => `<div style="color: #10b981;">‚Ä¢ ${rec}</div>`).join('')}
                    `;
                }
                
                detailsDiv.innerHTML = factorsHtml + recommendationsHtml;
            } else {
                riskDiv.innerHTML = '‚ùå Error';
                factorsDiv.innerHTML = '‚ùå Error';
                detailsDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load geopolitical data</p>';
            }
        } catch (error) {
            riskDiv.innerHTML = '‚ùå Error';
            factorsDiv.innerHTML = '‚ùå Error';
            detailsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    // Watchlist Functions
    async function loadWatchlist() {
        const watchlistDiv = document.getElementById('watchlist-display');
        watchlistDiv.innerHTML = '<p style="text-align: center;">üîÑ Loading watchlist...</p>';
        
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();
            
            if (data.status === 'success') {
                if (data.watchlist && data.watchlist.length > 0) {
                    const watchlistHtml = data.watchlist.map(stock => `
                        <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #3b82f6;">${stock.symbol}</strong><br>
                                <small>${stock.name}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>$${stock.price}</div>
                                <div style="color: ${stock.change.startsWith('+') ? '#10b981' : '#ef4444'};">${stock.change}</div>
                            </div>
                        </div>
                    `).join('');
                    
                    watchlistDiv.innerHTML = watchlistHtml;
                } else {
                    watchlistDiv.innerHTML = '<p style="opacity: 0.6; text-align: center;">No stocks in watchlist</p>';
                }
            } else {
                watchlistDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load watchlist</p>';
            }
        } catch (error) {
            watchlistDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    async function addToWatchlist() {
        const symbol = document.getElementById('watchlist-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        // For now, just add to UI - in real implementation would call API
        alert(`Added ${symbol} to watchlist! (Demo - would call API in production)`);
        document.getElementById('watchlist-symbol').value = '';
        loadWatchlist(); // Refresh the list
    }

    // AI Analysis Functions
    window.analyzeStock = async function() {
        console.log('analyzeStock function called');
        const symbol = document.getElementById('ai-stock-input').value.trim().toUpperCase();
        console.log('Symbol entered:', symbol);
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        // Update UI to show loading
        document.getElementById('selected-stock-analysis').innerHTML = '<p style="text-align: center;">ü§ñ Analyzing ' + symbol + '...</p>';
        document.getElementById('ai-comprehensive-results').innerHTML = '<p style="text-align: center;">üîÑ Running AI analysis...</p>';
        document.getElementById('ai-technical-results').innerHTML = '<p style="text-align: center;">üìä Processing technical data...</p>';
        document.getElementById('ai-risk-factors').innerHTML = '<p style="text-align: center;">‚ö†Ô∏è Calculating risk factors...</p>';
        
        try {
            // Get comprehensive AI analysis
            const response = await fetch(`/api/ai/comprehensive-analysis/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const analysis = data.analysis;
                const prediction = data.prediction;
                
                // Update stock info with metadata
                const metadata = data.ai_metadata || {};
                document.getElementById('selected-stock-analysis').innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px;">
                        <strong style="color: #3b82f6;">${symbol}</strong><br>
                        <span style="color: #10b981;">Current Price: $${data.current_price || 'N/A'}</span><br>
                        <small>ü§ñ AI Model: ${metadata.model || 'N/A'}</small><br>
                        <small>üìä Sources: ${metadata.search_results_count || 0} | Cost: $${(metadata.cost?.total_cost || 0).toFixed(4)}</small><br>
                        <small>üìù Response: ${metadata.raw_response_length || 0} chars | ${new Date().toLocaleTimeString()}</small>
                        ${metadata.raw_response_preview ? `
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; color: #3b82f6; font-size: 0.8em;">üìÑ View AI Response Preview</summary>
                            <pre style="white-space: pre-wrap; margin-top: 8px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-size: 0.75em; max-height: 200px; overflow-y: auto;">${metadata.raw_response_preview}</pre>
                        </details>` : ''}
                    </div>
                `;
                
                // Update comprehensive analysis
                const directionColor = prediction.direction === 'up' ? '#10b981' : prediction.direction === 'down' ? '#ef4444' : '#f59e0b';
                document.getElementById('ai-comprehensive-results').innerHTML = `
                    <div class="prediction-item">
                        <span class="prediction-label">Overall Prediction:</span>
                        <span class="prediction-value" style="color: ${directionColor};">${prediction.direction.toUpperCase()}</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-label">Confidence Level:</span>
                        <span class="prediction-value">${(prediction.confidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-label">Target Price:</span>
                        <span class="prediction-value">$${prediction.target_price}</span>
                    </div>
                `;
                
                // Update technical analysis
                const technical = analysis.technical;
                const trendColor = technical.trend === 'bullish' ? '#10b981' : technical.trend === 'bearish' ? '#ef4444' : '#f59e0b';
                document.getElementById('ai-technical-results').innerHTML = `
                    <div class="timeseries-metric">
                        <span class="metric-name">Trend Direction:</span>
                        <span class="metric-value" style="color: ${trendColor};">${technical.trend}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">Support Level:</span>
                        <span class="metric-value">$${technical.support_level}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">Resistance Level:</span>
                        <span class="metric-value">$${technical.resistance_level}</span>
                    </div>
                    <div class="timeseries-metric">
                        <span class="metric-name">RSI Signal:</span>
                        <span class="metric-value">${technical.macd_signal}</span>
                    </div>
                `;
                
                // Update risk assessment
                const risk = analysis.risk_assessment;
                updateRiskGauge(risk.risk_score);
                document.getElementById('ai-risk-factors').innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>Risk Level:</strong> ${risk.volatility}<br>
                        <strong>Beta:</strong> ${risk.beta}<br>
                        <strong>Liquidity:</strong> ${risk.liquidity}<br>
                        <strong>Overall Score:</strong> ${(risk.risk_score * 100).toFixed(0)}%
                    </div>
                `;
                
            } else {
                document.getElementById('selected-stock-analysis').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Analysis failed</p>';
                document.getElementById('ai-comprehensive-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Failed to get AI analysis</p>';
                document.getElementById('ai-technical-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Technical analysis unavailable</p>';
                document.getElementById('ai-risk-factors').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Risk analysis failed</p>';
            }
        } catch (error) {
            document.getElementById('selected-stock-analysis').innerHTML = `<p style="color: #ef4444; text-align: center;">‚ùå Error: ${error.message}</p>`;
            document.getElementById('ai-comprehensive-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Connection error</p>';
            document.getElementById('ai-technical-results').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Network error</p>';
            document.getElementById('ai-risk-factors').innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Service unavailable</p>';
        }
    }
    
    // Debug function to see the prompt
    window.debugPrompt = async function() {
        const symbol = document.getElementById('ai-stock-input').value.trim().toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        try {
            console.log('üêõ Fetching debug info for:', symbol);
            const response = await fetch(`/api/ai/debug-prompt/${symbol}`);
            const data = await response.json();
            
            if (!data.error) {
                console.log('üéØ PROMPT THAT WILL BE SENT TO PERPLEXITY:');
                console.log('‚ïê'.repeat(60));
                console.log(data.prompt);
                console.log('‚ïê'.repeat(60));
                console.log(`üìä Symbol: ${data.symbol}`);
                console.log(`üí∞ Current Price: $${data.current_price}`);
                console.log(`ü§ñ Model: ${data.model}`);
                console.log(`üìù Estimated Tokens: ${Math.round(data.estimated_tokens)}`);
                
                // Show in UI too
                document.getElementById('selected-stock-analysis').innerHTML = `
                    <div style="background: rgba(245, 158, 11, 0.1); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.8em;">
                        <strong style="color: #f59e0b;">üêõ DEBUG INFO for ${symbol}</strong><br>
                        <strong>Price:</strong> $${data.current_price}<br>
                        <strong>Model:</strong> ${data.model}<br>
                        <strong>Est. Tokens:</strong> ${Math.round(data.estimated_tokens)}<br>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #f59e0b;">üìù View Full Prompt</summary>
                            <pre style="white-space: pre-wrap; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
                        </details>
                    </div>
                `;
                
                alert(`Debug info logged to console! Check the browser console (F12) for full prompt details.`);
            } else {
                console.error('‚ùå Debug error:', data.error);
                alert('Error getting debug info: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Debug request failed:', error);
            alert('Failed to get debug info: ' + error.message);
        }
    }
    
    window.updateRiskGauge = function(riskScore) {
        console.log('Updating risk gauge with score:', riskScore);
        // Update risk gauge needle position
        const needle = document.querySelector('#ai-risk-indicator .risk-needle');
        if (needle) {
            // Convert risk score (0-1) to degrees (-90 to 90)
            const degrees = (riskScore * 180) - 90;
            needle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
        }
    }
    
    // Allow Enter key to trigger analysis
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('ai-stock-input');
        const button = document.querySelector('button[onclick="analyzeStock()"]');
        
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeStock();
                }
            });
        }
        
        if (button) {
            button.addEventListener('click', function() {
                analyzeStock();
            });
        }
    });

    // Auto-load data when tabs are opened
    document.addEventListener('DOMContentLoaded', function() {
        // Load ML status
        fetch('/api/ml/status').then(r => r.json()).then(data => {
            document.getElementById('ml-status-display').innerHTML = 
                data.components ? `
                    <div style="font-size: 0.9em;">
                        <strong>ML Trainer:</strong> ${data.components.ml_trainer?.status || 'N/A'}<br>
                        <strong>Models:</strong> ${data.performance?.models_active || 0} active<br>
                        <strong>Accuracy:</strong> ${data.performance?.accuracy || 'N/A'}
                    </div>
                ` : 'ML system information unavailable';
        }).catch(() => {
            document.getElementById('ml-status-display').innerHTML = 'Failed to load ML status';
        });

        // Load sector performance
        fetch('/api/financial/sector-performance').then(r => r.json()).then(data => {
            if (data.status === 'success' && data.data) {
                const sectors = Object.entries(data.data).map(([name, info]) => 
                    `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${name}:</span>
                        <span style="color: ${info.change.startsWith('+') ? '#10b981' : '#ef4444'};">${info.change}</span>
                    </div>`
                ).join('');
                document.getElementById('sector-performance-display').innerHTML = sectors;
            }
        }).catch(() => {
            document.getElementById('sector-performance-display').innerHTML = 'Failed to load sector data';
        });

        // Load geopolitical data
        loadGeopoliticalData();
        
        // Load watchlist
        loadWatchlist();
        
        // Load AI market intelligence
        loadAIMarketIntelligence();
    });
    
    async function loadAIMarketIntelligence() {
        const intelligenceDiv = document.getElementById('ai-intelligence-container');
        intelligenceDiv.innerHTML = '<p style="text-align: center;">ü§ñ Loading AI market intelligence...</p>';
        
        try {
            const response = await fetch('/api/ai/market-intelligence');
            const data = await response.json();
            
            if (data.status === 'success') {
                intelligenceDiv.innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 15px;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">üß† Market Intelligence</h4>
                        <div style="font-size: 0.9em;">
                            <strong>Market Sentiment:</strong> ${data.sentiment || 'Analyzing...'}<br>
                            <strong>Overall Trend:</strong> ${data.trend || 'Processing...'}<br>
                            <strong>Risk Level:</strong> ${data.risk_level || 'Calculating...'}
                        </div>
                    </div>
                `;
            } else {
                intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Failed to load market intelligence</p>';
            }
        } catch (error) {
            intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">‚ùå Market intelligence unavailable</p>';
        }
    }

    </script>
</body>
</html>