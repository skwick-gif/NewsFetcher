<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPulse Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    
    <!-- Load JavaScript modules with cache busting -->
    <script src="/static/js/modules/market-data.js?v=20251020" defer></script>
    <script src="/static/js/modules/chart-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/alerts-manager.js?v=20251020" defer></script>
    <script src="/static/js/modules/ml-scanner.js?v=20251020" defer></script>
    
    <script src="/static/js/modules/websocket-client.js?v=20251020" defer></script>
    <!-- DISABLED: Old main.js conflicts with new AI Analysis - use inline functions instead -->
    <!-- <script src="/static/js/main.js?v=20251020" defer></script> -->
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .header h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 4px;
        }
        .subtitle { font-size: 0.85em; opacity: 0.8; margin-bottom: 6px; }
        .live-status {
            display: inline-block;
            background: rgba(16, 185, 129, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: #10b981;
        }
        /* WebSocket connection status */
        .ws-controls { margin-top: 8px; display: flex; gap: 8px; justify-content: center; align-items: center; }
        .ws-toggle-btn {
            background: transparent;
            color: #e2e8f0;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .ws-toggle-btn.on { background: #10b981; color: #0b1220; border-color: #10b981; }
        .ws-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75em;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .ws-off { background: rgba(148,163,184,0.15); color: #cbd5e1; }
        .ws-warn { background: rgba(234,179,8,0.15); color: #facc15; }
        .ws-on { background: rgba(16,185,129,0.15); color: #10b981; }
        .market-header {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .market-indices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 8px;
        }
        .index-item {
            text-align: center;
            background: rgba(255,255,255,0.04);
            padding: 10px;
            border-radius: 8px;
        }
        .index-name { font-size: 0.75em; opacity: 0.7; margin-bottom: 3px; }
        .index-value { font-size: 1.1em; font-weight: bold; margin-bottom: 3px; }
        .index-change {
            font-size: 0.8em;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 500;
        }
        .positive { color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .negative { color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        .last-update { text-align: center; font-size: 0.75em; opacity: 0.6; }
        .sentiment-bar-container {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sentiment-label { font-size: 0.85em; font-weight: 600; white-space: nowrap; }
        .sentiment-bar {
            flex: 1;
            height: 8px;
            background: #2d3748;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .sentiment-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            width: 54%;
            border-radius: 5px;
        }
        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 12px;
            justify-content: center;
        }
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .tab.active { background: rgba(255,255,255,0.15); color: #ffd700; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .section h3 {
            color: #ffd700;
            border-bottom: 2px solid rgba(255,255,255,0.15);
            padding-bottom: 6px;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .ai-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .ai-grid .ai-card:last-child {
            grid-column: 1 / -1; /* Hot Stocks takes full width */
        }
        .ai-card {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .ai-card h4 { color: #ffd700; font-size: 0.95em; margin-bottom: 8px; }
        .loading-text { color: #10b981; font-size: 0.85em; font-style: italic; }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .status-item {
            text-align: center;
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 8px;
        }
        .status-icon { font-size: 1.5em; margin-bottom: 4px; }
        .status-label { font-size: 0.75em; opacity: 0.8; }
        .status-name { font-size: 0.7em; opacity: 0.6; margin-top: 2px; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .metric-item {
            text-align: center;
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        .metric-value { font-size: 1.3em; font-weight: bold; color: #3b82f6; }
        .metric-label { font-size: 0.75em; opacity: 0.8; margin-top: 3px; }
        .btn-analyze {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-analyze:hover { background: #2563eb; }
        
        /* Settings Tab Styles */
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .settings-group {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .settings-group h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .setting-item {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .setting-item label {
            font-size: 0.85em;
            color: #cbd5e0;
            font-weight: 500;
        }
        .setting-item input[type="number"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .setting-item input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .checkbox-setting {
            flex-direction: row !important;
            align-items: center;
            gap: 8px;
        }
        .checkbox-setting input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
            cursor: pointer;
        }
        .checkbox-setting label {
            cursor: pointer;
            margin: 0;
        }
        .settings-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .save-btn, .reset-btn, .export-btn, .import-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .save-btn {
            background: #10b981;
            color: white;
        }
        .save-btn:hover { background: #059669; }
        .reset-btn {
            background: #f59e0b;
            color: white;
        }
        .reset-btn:hover { background: #d97706; }
        .export-btn, .import-btn {
            background: #3b82f6;
            color: white;
        }
        .export-btn:hover, .import-btn:hover { background: #2563eb; }
        
        /* AI Analysis Tab Styles */
        .ai-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .ai-selector-card, .ai-prediction-card, .ai-timeseries-card, .ai-risk-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .ai-selector-card h4, .ai-prediction-card h4, .ai-timeseries-card h4, .ai-risk-card h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 6px;
        }
        .stock-selector select {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #e2e8f0;
            font-size: 0.85em;
        }
        .stock-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .prediction-item, .timeseries-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .prediction-label, .metric-name {
            font-size: 0.85em;
            color: #cbd5e0;
        }
        .prediction-value, .metric-value {
            font-weight: 600;
            font-size: 0.85em;
        }
        .prediction-value.bullish, .metric-value.bullish { color: #10b981; }
        .prediction-value.bearish, .metric-value.bearish { color: #ef4444; }
        .prediction-value.neutral, .metric-value.neutral { color: #f59e0b; }
        .risk-gauge {
            position: relative;
            width: 120px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(to right, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            border-radius: 60px 60px 0 0;
        }
        .risk-indicator {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .risk-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 50px;
            background: #ffffff;
            transform-origin: bottom;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.5s ease;
        }
        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            margin-top: 5px;
        }
        .risk-low { color: #10b981; }
        .risk-medium { color: #f59e0b; }
        .risk-high { color: #ef4444; }
        
        /* Hot Stocks Grid Styles */
        .hot-stocks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;  
            margin-top: 10px;
        }
        .hot-stock-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        .hot-stock-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .stock-symbol {
            font-weight: bold;
            color: #3b82f6;
            font-size: 0.9em;
        }
        .stock-price {
            font-size: 0.85em;
            color: #e2e8f0;
        }
        .stock-return {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .stock-return.change-positive {
            color: #10b981;
        }
        .stock-return.change-negative {
            color: #ef4444;
        }
        .stock-details {
            font-size: 0.8em;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        /* Responsive adjustments for hot stocks */
        @media (max-width: 1200px) {
            .hot-stocks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .hot-stocks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MarketPulse 📊</h1>
            <p class="subtitle">Real-Time Financial Intelligence Platform</p>
            <p>Live market data • AI-powered analysis • Smart alerts • Stock insights</p>
            <div class="live-status">🚀 LIVE MARKET DATA</div>
            <div class="ws-controls">
                <button id="realtime-btn" class="ws-toggle-btn">⚪ Enable Real-time</button>
                <span id="ws-status-badge" class="ws-badge ws-off">WS: OFF</span>
            </div>
        </div>

        <div class="market-header">
            <div class="market-indices">
                <div class="index-item" data-index="VIX">
                    <div class="index-name">VIX</div>
                    <div class="index-value" id="VIX-value">--</div>
                    <div class="index-change" id="VIX-change">Loading...</div>
                </div>
                <div class="index-item" data-index="RUSSELL2000">
                    <div class="index-name">RUSSELL 2000</div>
                    <div class="index-value" id="RUSSELL2000-value">--</div>
                    <div class="index-change" id="RUSSELL2000-change">Loading...</div>
                </div>
                <div class="index-item" data-index="DOW">
                    <div class="index-name">DOW JONES</div>
                    <div class="index-value" id="DOW-value">--</div>
                    <div class="index-change" id="DOW-change">Loading...</div>
                </div>
                <div class="index-item" data-index="NASDAQ">
                    <div class="index-name">NASDAQ</div>
                    <div class="index-value" id="NASDAQ-value">--</div>
                    <div class="index-change" id="NASDAQ-change">Loading...</div>
                </div>
                <div class="index-item" data-index="SP500">
                    <div class="index-name">S&P 500</div>
                    <div class="index-value" id="SP500-value">--</div>
                    <div class="index-change" id="SP500-change">Loading...</div>
                </div>
            </div>
            <div class="last-update" id="last-update">Connecting...</div>
        </div>

        <div class="sentiment-bar-container">
            <span class="sentiment-label" id="sentiment-label">Connecting...</span>
            <div class="sentiment-bar">
                <div class="sentiment-fill" id="sentiment-fill" style="width: 0%;"></div>
            </div>
            <span class="sentiment-label">Market Sentiment 📈</span>
        </div>

        <div class="tabs">
            <button class="tab" data-tab="settings-tab" onclick="showTabDirect('settings-tab')">Settings ⚙️</button>
            <button class="tab" data-tab="articles-tab" onclick="showTabDirect('articles-tab')">Articles 📄</button>
            <button class="tab" data-tab="ai-tab" onclick="showTabDirect('ai-tab')">AI Analysis 🤖</button>
            <button class="tab" data-tab="progressive-ml-tab" onclick="showTabDirect('progressive-ml-tab')">Progressive ML 🚀</button>
            <button class="tab" data-tab="data-management-tab" onclick="showTabDirect('data-management-tab')">Data Management 📊</button>
            <button class="tab" data-tab="financial-tab" onclick="showTabDirect('financial-tab')">Finance 💰</button>
            <button class="tab" data-tab="geopolitics-tab" onclick="showTabDirect('geopolitics-tab')">Geopolitics 🌍</button>
            <button class="tab" data-tab="watchlist-tab" onclick="showTabDirect('watchlist-tab')">Watchlist ⭐</button>
            <button class="tab active" data-tab="overview-tab" onclick="showTabDirect('overview-tab')">Overview 📊</button>
        </div>
        
        <!-- Tab Contents -->
        <div id="overview-tab" class="tab-content active">
            <!-- Overview content here -->
        
        <div class="section">
            <h3>MarketPulse AI Intelligence 🤖</h3>
            <div class="ai-grid">
                <div class="ai-card">
                    <h4>Market Intelligence Dashboard 🧠</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Market Sentiment</strong>
                        <div class="loading-text" id="market-sentiment-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0;">
                        <strong style="color: #10b981;">Overall Market</strong>
                        <div class="loading-text" id="overall-market-display">...Loading</div>
                    </div>
                </div>
                <div class="ai-card">
                    <h4>Risk Assessment ⚠️</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #ef4444;">Market Risk (VIX)</strong>
                        <div class="loading-text" id="market-risk-display">...Loading</div>
                    </div>
                    <div style="margin: 8px 0; font-size: 0.75em; opacity: 0.7;">
                        <div id="risk-interpretation">Analyzing market volatility...</div>
                    </div>
                </div>
                <!-- Geopolitical Risks Card -->
                <div class="ai-card" id="geopolitical-card">
                    <h4>Geopolitical Risks 🌍</h4>
                    <div style="margin: 8px 0;">
                        <strong style="color: #f59e0b;">Current Events</strong>
                        <div class="loading-text" id="geopolitical-events">Loading geopolitical risks...</div>
                    </div>
                    <div style="margin-top:8px; font-size:0.85em; opacity:0.8;" id="geopolitical-summary"></div>
                </div>
                <!-- Hot Stocks Card -->
                <div class="ai-card">
                    <h4>AI Hot Stocks 🔥</h4>
                    <div id="hot-alerts" style="margin: 8px 0;">
                        <p style="text-align: center; opacity: 0.6;">Scanning for hot opportunities...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Top Market Movers 📈</h3>
            <div id="top-movers" style="display: grid; gap: 10px;">
                <p style="text-align: center; opacity: 0.6;">Loading top market movers...</p>
            </div>
        </div>

        <div class="section">
            <h3>AI Models Status 🤖</h3>
            <div class="status-grid" id="ai-models-status">
                <div class="status-item">
                    <div class="status-icon">⏳</div>
                    <div class="status-label">Loading...</div>
                    <div class="status-name">Checking status</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>ML Intelligence Dashboard 🧠</h3>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="market-sentiment-value">Loading...</div>
                    <div class="metric-label" id="market-sentiment-label">Market Sentiment</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="risk-level-value">Loading...</div>
                    <div class="metric-label" id="risk-level-label">Risk Level</div>
                </div>
            </div>
            <div id="ai-recommendations" style="margin-top: 15px;">
                <h4 style="color: #ffd700; margin-bottom: 10px;">AI Recommendations</h4>
                <p style="text-align: center; opacity: 0.6;">Analyzing market conditions...</p>
            </div>
        </div>

        </div>
        <!-- End Overview Tab -->
        
        <!-- AI Analysis Tab -->
        <div id="ai-tab" class="tab-content">
            <div class="section">
                <h3>🤖 AI Market Intelligence</h3>
                <div id="ai-intelligence-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading AI market intelligence...</p>
                </div>
                
                <div class="ai-analysis-grid">
                    <!-- Stock Input -->
                    <div class="ai-selector-card">
                        <h4>🤖 AI Stock Analysis</h4>
                        
                        <div class="stock-selector">
                            <input type="text" id="ai-stock-input" placeholder="Enter stock symbol (e.g., AAPL)" 
                                   style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em; text-transform: uppercase;">
                            <div style="display: flex; gap: 5px; margin-top: 8px;">
                                <button id="analyze-stock-btn" style="flex: 1; background: #3b82f6; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    🔍 Analyze Stock
                                </button>
                                <button onclick="debugPrompt()" style="flex: 1; background: #f59e0b; border: none; border-radius: 6px; padding: 8px; color: white; cursor: pointer; font-size: 0.85em;">
                                    🐛 Debug Prompt
                                </button>
                            </div>
                        </div>
                        <div id="selected-stock-analysis" style="margin-top: 15px;">
                            <p style="text-align: center; opacity: 0.6;">Enter a stock symbol above for comprehensive AI analysis</p>
                        </div>
                    </div>

                    <!-- AI Comprehensive Analysis -->
                    <div class="ai-prediction-card">
                        <h4>🎯 AI Comprehensive Analysis</h4>
                        <div id="ai-comprehensive-results">
                            <div class="prediction-item">
                                <span class="prediction-label">Overall Prediction:</span>
                                <span class="prediction-value neutral">Waiting for analysis</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Confidence Level:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                            <div class="prediction-item">
                                <span class="prediction-label">Target Price:</span>
                                <span class="prediction-value neutral">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Technical Analysis -->
                    <div class="ai-timeseries-card">
                        <h4>📊 AI Technical Analysis</h4>
                        <div id="ai-technical-results">
                            <div class="timeseries-metric">
                                <span class="metric-name">Trend Direction:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Support Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">Resistance Level:</span>
                                <span class="metric-value">--</span>
                            </div>
                            <div class="timeseries-metric">
                                <span class="metric-name">RSI Signal:</span>
                                <span class="metric-value">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Risk Assessment -->
                    <div class="ai-risk-card">
                        <h4>⚠️ AI Risk Assessment</h4>
                        <div id="ai-risk-assessment">
                            <div class="risk-gauge">
                                <div class="risk-indicator" id="ai-risk-indicator">
                                    <div class="risk-needle"></div>
                                </div>
                                <div class="risk-labels">
                                    <span class="risk-low">Low</span>
                                    <span class="risk-medium">Medium</span>
                                    <span class="risk-high">High</span>
                                </div>
                            </div>
                            <div id="ai-risk-factors">
                                <p style="text-align: center; opacity: 0.6;">Enter a stock symbol for AI risk analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Articles Tab -->
        <div id="articles-tab" class="tab-content">
            <div class="section">
                <h3>Active Alerts 🚨</h3>
                <div id="alerts-container" style="margin-bottom: 20px;">
                    <p style="text-align: center; opacity: 0.6;">Loading active alerts...</p>
                </div>
                
                <h3>Recent Articles 📄</h3>
                <div id="articles-container">
                    <p style="text-align: center; opacity: 0.6;">Loading recent articles...</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="section">
                <h3>⚙️ System Settings</h3>
                <div class="settings-container">
                    <!-- Update Settings -->
                    <div class="settings-group">
                        <h4>🔄 Update Settings</h4>
                        <div class="setting-item">
                            <label for="updateInterval">Auto-refresh interval (seconds):</label>
                            <input type="number" id="updateInterval" min="5" max="300" value="30">
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">Enable auto-refresh</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableWebSocket" checked>
                            <label for="enableWebSocket">Enable real-time updates</label>
                        </div>
                    </div>

                    <!-- Display Settings -->
                    <div class="settings-group">
                        <h4>🎨 Display Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="darkMode" checked>
                            <label for="darkMode">Dark mode</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="compactView">
                            <label for="compactView">Compact view</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="showCharts" checked>
                            <label for="showCharts">Show charts</label>
                        </div>
                    </div>

                    <!-- AI & ML Settings -->
                    <div class="settings-group">
                        <h4>🤖 AI & ML Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableMLPredictions" checked>
                            <label for="enableMLPredictions">Enable ML predictions</label>
                        </div>
                        <div class="setting-item">
                            <label for="keywordThreshold">Keyword relevance threshold:</label>
                            <input type="number" id="keywordThreshold" min="0" max="1" step="0.1" value="0.3">
                        </div>
                        <div class="setting-item">
                            <label for="highScoreThreshold">High score threshold:</label>
                            <input type="number" id="highScoreThreshold" min="0" max="1" step="0.1" value="0.7">
                        </div>
                    </div>

                    <!-- Hot Stocks Scanner Settings -->
                    <div class="settings-group">
                        <h4>🔥 Hot Stocks Scanner</h4>
                        <div class="setting-item">
                            <label for="hotStocksReturnThreshold">Minimum expected return (%):</label>
                            <input type="number" id="hotStocksReturnThreshold" min="0.1" max="10" step="0.1" value="1.0">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Stocks must exceed this % to be considered "hot"</small>
                        </div>
                        <div class="setting-item">
                            <label for="hotStocksConfidenceThreshold">Minimum confidence score:</label>
                            <input type="number" id="hotStocksConfidenceThreshold" min="0.1" max="1.0" step="0.05" value="0.55">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">ML model confidence (0.0 - 1.0)</small>
                        </div>
                        <div class="setting-item">
                            <label for="hotStocksLimit">Number of stocks to display:</label>
                            <input type="number" id="hotStocksLimit" min="1" max="25" value="5">
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="hotStocksAutoRefresh" checked>
                            <label for="hotStocksAutoRefresh">Auto-refresh hot stocks</label>
                        </div>
                    </div>

                    <!-- Progressive ML Training Settings -->
                    <div class="settings-group">
                        <h4>🚀 Progressive ML Training</h4>
                        <div class="setting-item">
                            <label for="trainingEpochs">Training epochs:</label>
                            <input type="number" id="trainingEpochs" min="10" max="500" value="100">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">More epochs = better accuracy but longer training</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingBatchSize">Batch size:</label>
                            <input type="number" id="trainingBatchSize" min="8" max="128" step="8" value="32">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Larger batches use more memory</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingSequenceLength">Sequence length (days):</label>
                            <input type="number" id="trainingSequenceLength" min="30" max="120" value="60">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Historical data window for predictions</small>
                        </div>
                        <div class="setting-item">
                            <label for="trainingLearningRate">Learning rate:</label>
                            <input type="number" id="trainingLearningRate" min="0.0001" max="0.01" step="0.0001" value="0.001">
                            <small style="color: #9ca3af; display: block; margin-top: 4px;">Model optimization speed (0.0001 - 0.01)</small>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="settings-group">
                        <h4>🔔 Notifications</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="enableNotifications">
                            <label for="enableNotifications">Enable browser notifications</label>
                        </div>
                        <div class="setting-item">
                            <label for="maxArticles">Maximum articles to display:</label>
                            <input type="number" id="maxArticles" min="10" max="500" value="50">
                        </div>
                    </div>

                    <!-- Debug Settings -->
                    <div class="settings-group">
                        <h4>🐛 Debug</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="debugMode">
                            <label for="debugMode">Enable debug mode</label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-actions">
                        <button class="save-btn" onclick="window.settingsManager?.saveSettings()">💾 Save Settings</button>
                        <button class="reset-btn" onclick="window.settingsManager?.resetSettings()">🔄 Reset to Defaults</button>
                        <button class="export-btn" onclick="window.settingsManager?.exportSettings()">📥 Export Settings</button>
                        <input type="file" id="importSettings" accept=".json" style="display: none;" onchange="handleSettingsImport(this)">
                        <button class="import-btn" onclick="document.getElementById('importSettings').click()">📤 Import Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progressive ML Tab -->
        <div id="progressive-ml-tab" class="tab-content">
            <div class="section">
                <h3>🚀 Progressive ML Training System</h3>
                
                <!-- Row 1: Status Cards in Single Row -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>🤖 Progressive ML Status</h4>
                        <div id="progressive-ml-status-display">Loading Progressive ML status...</div>
                    </div>
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>🧠 Available Models</h4>
                        <div id="progressive-models-display">Loading models info...</div>
                    </div>
                    <div class="ai-card" style="grid-column: auto;">
                        <h4>📊 Training Status</h4>
                        <div id="progressive-training-status-display">Loading training status...</div>
                    </div>
                </div>

                <!-- Row 2: Advanced Backtesting (Full Width, Parameters in Row) -->
                <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px;">
                        <h4 style="color: #ffd700; margin-bottom: 15px; font-size: 1.1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; flex:1;">🔬 Advanced Backtesting Training</h4>
                        <div style="display:flex; align-items:center; gap:10px; white-space: nowrap;">
                            <a href="#" onclick="openBacktestExplainer(); return false;" style="color:#93c5fd; font-size:0.9em;">What does this mean?</a>
                            <span style="opacity:0.5;">|</span>
                            <a href="/docs/progressive-ml" target="_blank" style="color:#10b981; font-size:0.9em;">📘 Progressive ML Guide</a>
                        </div>
                    </div>
                    <p style="font-size: 0.9em; opacity: 0.8; margin-bottom: 15px;">Train with expanding date windows and automatic accuracy improvement</p>
                    
                    <!-- Parameters Grid - All in Row including buttons -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Start Date:</label>
                            <input type="date" id="backtest-start-date" value="2024-01-01" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">End Date:</label>
                            <input type="date" id="backtest-end-date" value="2025-10-07" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Test Period:</label>
                            <input type="number" id="backtest-test-period" value="14" min="1" max="365" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Iterations:</label>
                            <input type="number" id="backtest-max-iterations" value="10" min="1" max="50" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Target: <span id="accuracy-display" style="font-weight: bold; color: #10b981;">85%</span></label>
                            <input type="range" id="backtest-target-accuracy" min="50" max="100" value="85" style="width: 100%;">
                        </div>
                        
                        <div>
                            <label style="font-size: 0.75em; color: #cbd5e0; display: flex; align-items: center; cursor: pointer; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <input type="checkbox" id="backtest-auto-stop" checked style="width: 16px; height: 16px; margin-left: 5px; accent-color: #3b82f6;">
                                Auto-stop
                            </label>
                        </div>
                        
                        <div>
                            <button onclick="startBacktesting()" style="width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em;">
                                🔬 Start
                            </button>
                            <button onclick="startAutoBacktesting()" style="width: 100%; background: linear-gradient(135deg, #10b981, #3b82f6); border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em; margin-top:6px;">
                                🤖 Auto (Plan & Run)
                            </button>
                        </div>
                        
                        <div>
                            <button onclick="stopBacktesting()" style="width: 100%; background: #ef4444; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-size: 0.85em;">
                                ⏹ Stop
                            </button>
                        </div>
                    </div>
                    
                    <!-- Indicator Parameters -->
                    <div style="margin-top: 12px; background: rgba(0,0,0,0.25); border-radius: 8px; padding: 12px;">
                        <details>
                            <summary style="cursor: pointer; color: #cbd5e0;">🧩 Indicator Parameters (optional)</summary>
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px;">
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">RSI Period</label>
                                    <input id="ind-rsi-period" type="number" min="2" max="200" value="14" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">MACD Fast</label>
                                    <input id="ind-macd-fast" type="number" min="2" max="200" value="12" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">MACD Slow</label>
                                    <input id="ind-macd-slow" type="number" min="3" max="400" value="26" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">MACD Signal</label>
                                    <input id="ind-macd-signal" type="number" min="2" max="200" value="9" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">SMA Periods (CSV)</label>
                                    <input id="ind-sma-periods" type="text" value="5,10,20,50" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">EMA Periods (CSV)</label>
                                    <input id="ind-ema-periods" type="text" value="5,10,20,50" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">BB Period</label>
                                    <input id="ind-bb-period" type="number" min="5" max="200" value="20" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em; color:#cbd5e0; display:block; margin-bottom:4px;">BB Std Dev</label>
                                    <input id="ind-bb-std" type="number" min="0.5" max="5" step="0.1" value="2" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- Progress Display -->
                    <div id="backtest-progress" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span id="backtest-status-text">Starting backtest...</span>
                                <span id="backtest-iteration-text">Iteration 0/10</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 10px; overflow: hidden;">
                                <div id="backtest-progress-fill" style="background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Plan & Preflight Card -->
                    <div id="backtest-plan-card" style="margin-top: 12px; display:none; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px;">
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:6px;">
                            <h5 style="margin:0;">🧭 Plan & Preflight</h5>
                            <span id="backtest-preflight-badge" style="background:#2563eb; color:#fff; padding:2px 8px; border-radius:999px; font-size:0.75em;">Planning…</span>
                        </div>
                        <div id="backtest-plan-content" style="font-size:0.9em; opacity:0.95;"></div>
                    </div>

                    <!-- Champion Card -->
                    <div id="backtest-champion-card" style="margin-top: 12px; display:none; background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.35); border-radius: 8px; padding: 10px;">
                        <div style="display:flex; justify-content: space-between; align-items:center;">
                            <h5 style="margin:0;">🏆 Champion</h5>
                            <button id="champion-forward-btn" onclick="runChampionForwardTest()" style="background:#059669; border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:0.85em;">Run Forward Test</button>
                        </div>
                        <div id="backtest-champion-content" style="margin-top:6px; font-size:0.9em;"></div>
                        <div id="backtest-current-preds" style="margin-top:6px; font-size:0.9em;"></div>
                        <div id="backtest-forward-results" style="margin-top:6px; font-size:0.9em;"></div>
                    </div>

                    <!-- Results Table -->
                    <div id="backtest-results-container" style="margin-top: 20px; display: none;">
                        <h5 style="margin-bottom: 10px;">📊 Backtest Results</h5>
                        <div style="overflow-x: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;">
                            <table id="backtest-results-table" style="width: 100%; color: #e2e8f0; font-size: 0.9em;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="padding: 8px; text-align: left;">#</th>
                                        <th style="padding: 8px; text-align: left;">Train Until</th>
                                        <th style="padding: 8px; text-align: left;">Accuracy</th>
                                        <th style="padding: 8px; text-align: left;">Loss</th>
                                        <th style="padding: 8px; text-align: left;">Time</th>
                                        <th style="padding: 8px; text-align: left;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="backtest-results-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Backtest History Panel -->
                    <div id="backtest-history-container" style="margin-top: 20px; display: block;">
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:8px;">
                            <h5 style="margin:0;">🕘 Backtest History</h5>
                            <button onclick="loadBacktestHistory()" style="background:#4b5563; border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:0.85em;">Refresh</button>
                        </div>
                        <div id="backtest-history-list" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; max-height:180px; overflow:auto;">
                            <div style="opacity:0.7; font-size:0.9em;">No history yet. Run a backtest, then click Refresh.</div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div id="backtest-chart-container" style="margin-top: 20px; display: none;">
                        <canvas id="backtest-chart"></canvas>
                    </div>
                </div>

                <!-- Row 3: Progressive Training Interface (2 Boxes) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                        <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">🎯 Progressive Model Training</h4>
                        
                        <!-- All inputs in one row -->
                        <div style="display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 10px; margin-bottom: 10px; align-items: start;">
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Stock Symbol:</label>
                                <input type="text" id="progressive-symbol" placeholder="Enter symbol (e.g., TSLA, NVDA)" value="" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.9em;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Model Types:</label>
                                <select id="progressive-model-types" multiple style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px 8px; color: #e2e8f0; height: 60px; font-size: 0.85em;">
                                    <option value="lstm" selected>LSTM</option>
                                    <option value="cnn_lstm">CNN-LSTM</option>
                                    <option value="transformer">Transformer</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85em; color: #cbd5e0; display: block; margin-bottom: 5px;">Training Mode:</label>
                                <select id="progressive-mode" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0; font-size: 0.85em;">
                                    <option value="progressive" selected>Progressive</option>
                                    <option value="unified">Unified</option>
                                </select>
                            </div>
                        </div>
                        
                        <small style="opacity: 0.7; font-size: 0.8em; display: block; margin-bottom: 10px;">💡 Enter any stock symbol from your stock_data folder</small>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="getProgressivePrediction()" style="flex: 1; background: #8b5cf6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                🔮 Get Prediction
                            </button>
                            <button onclick="startProgressiveTraining()" style="flex: 1; background: #f59e0b; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                🚀 Start Training
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                        <h4 style="color: #ffd700; margin-bottom: 6px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">🏋️ Training Progress</h4>
                        <div style="margin-bottom: 6px; font-size: 0.8em; opacity: 0.7;">Progress is approximate and may jump to 100% when training completes.</div>
                        <div id="progressive-training-results" style="min-height: 100px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center; font-size: 0.9em;">Training results will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Prediction Results (Full Width) -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                    <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 1em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;">📈 Progressive Prediction Results</h4>
                    <div id="progressive-prediction-results" style="min-height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="opacity: 0.6; text-align: center; font-size: 0.9em;">Select a symbol and click "Get Progressive Prediction" to see advanced ML predictions with multiple time horizons</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data-management-tab" class="tab-content">
            <div class="section">
                <h3>📊 Data Management & Download Status</h3>
                
                <!-- Status Overview -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <h4><i class="fas fa-download"></i> הורדות יומיות</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="daily-downloads-count">-</div>
                        <small>מהיום</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                        <h4><i class="fas fa-chart-bar"></i> נתוני פנדמנטל</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="fundamental-updates-count">-</div>
                        <small>השבוע</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h4><i class="fas fa-exclamation-triangle"></i> שגיאות</h4>
                        <div style="font-size: 2em; font-weight: bold;" id="errors-count">-</div>
                        <small>24 שעות</small>
                    </div>
                    <div class="ai-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white;">
                        <h4><i class="fas fa-clock"></i> ריצה אחרונה</h4>
                        <div style="font-size: 1.2em; font-weight: bold;" id="last-run-time">-</div>
                        <small>הורדת נתונים</small>
                    </div>
                </div>

                <!-- Jobs Schedule -->
                <div class="ai-card" style="background: rgba(255, 255, 255, 0.05); margin-bottom: 20px;">
                    <h4>⏰ לוח זמנים אוטומטי</h4>
                    <div style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 15px;">
                        <table style="width: 100%; color: #e2e8f0;">
                            <thead style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <tr>
                                    <th style="text-align: right; padding: 10px;">משימה</th>
                                    <th style="text-align: right; padding: 10px;">תדירות</th>
                                    <th style="text-align: right; padding: 10px;">ריצה אחרונה</th>
                                    <th style="text-align: right; padding: 10px;">ריצה הבאה</th>
                                    <th style="text-align: right; padding: 10px;">סטטוס</th>
                                    <th style="text-align: right; padding: 10px;">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-schedule-table">
                                <tr>
                                    <td style="padding: 10px;">
                                        <strong>הורדת מחירים יומית</strong><br>
                                        <small style="opacity: 0.7;">daily_scan.py</small>
                                    </td>
                                    <td style="padding: 10px;">
                                        <span style="background: #3182ce; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">יומי 17:10</span>
                                    </td>
                                    <td style="padding: 10px;" id="daily-last-run">טוען...</td>
                                    <td style="padding: 10px;" id="daily-next-run">טוען...</td>
                                    <td style="padding: 10px;" id="daily-status">טוען...</td>
                                    <td style="padding: 10px;">
                                        <button onclick="runDataJob('daily')" style="background: #38a169; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; margin-right: 5px;">
                                            <i class="fas fa-play"></i> הרץ עכשיו
                                        </button>
                                        <button onclick="viewDataLogs('daily')" style="background: #4a5568; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em;">
                                            <i class="fas fa-file-alt"></i> לוגים
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px;">
                                        <strong>עדכון נתוני פנדמנטל</strong><br>
                                        <small style="opacity: 0.7;">run_weekly_fundamentals.py</small>
                                    </td>
                                    <td style="padding: 10px;">
                                        <span style="background: #d69e2e; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">שבועי א' 02:00</span>
                                    </td>
                                    <td style="padding: 10px;" id="weekly-last-run">טוען...</td>
                                    <td style="padding: 10px;" id="weekly-next-run">טוען...</td>
                                    <td style="padding: 10px;" id="weekly-status">טוען...</td>
                                    <td style="padding: 10px;">
                                        <button onclick="runDataJob('weekly')" style="background: #38a169; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; margin-right: 5px;">
                                            <i class="fas fa-play"></i> הרץ עכשיו
                                        </button>
                                        <button onclick="viewDataLogs('weekly')" style="background: #4a5568; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8em;">
                                            <i class="fas fa-file-alt"></i> לוגים
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>🚀 פעולות מהירות</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="runAllDataJobs()" style="background: #38a169; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-play-circle"></i> הרץ את כל המשימות
                            </button>
                            <button onclick="refreshDataStatus()" style="background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-sync"></i> רענן סטטוס
                            </button>
                            <button onclick="downloadDataLogs()" style="background: #4a5568; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
                                <i class="fas fa-download"></i> הורד לוגים
                            </button>
                        </div>
                    </div>
                    <div class="ai-card">
                        <h4>🔧 בריאות המערכת</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="db-health-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <small>Database</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="scheduler-health-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <small>Scheduler</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="api-health-icon">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                                <small>API</small>
                            </div>
                            <div>
                                <div style="font-size: 2em; margin-bottom: 5px;" id="storage-health-icon">
                                    <i class="fas fa-hdd"></i>
                                </div>
                                <small>Storage</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Logs -->
                <div class="ai-card">
                    <h4>📋 לוגים אחרונים</h4>
                    <div style="background: #2d3748; color: #a0aec0; font-family: 'Courier New', monospace; font-size: 0.85rem; border-radius: 10px; padding: 15px; max-height: 300px; overflow-y: auto;" id="recent-logs">
                        <div style="color: #63b3ed;">[16:00:01] 🔄 מתחבר ללוגים...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Data Tab -->
        <div id="financial-tab" class="tab-content">
            <div class="section">
                <h3>💰 Enhanced Financial Analytics</h3>
                
                <!-- Sector Performance -->
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>📊 Sector Performance</h4>
                        <div id="sector-performance-display">Loading sector data...</div>
                    </div>
                    <div class="ai-card">
                        <h4>💹 Market Sentiment</h4>
                        <div id="market-sentiment-detailed">Loading sentiment analysis...</div>
                    </div>
                </div>

                <!-- Symbol-specific Analysis -->
                <div class="settings-container">
                    <div class="settings-group">
                        <h4>🎯 Symbol Analysis</h4>
                        <div class="setting-item">
                            <label for="financial-symbol">Stock Symbol:</label>
                            <input type="text" id="financial-symbol" placeholder="e.g., AAPL" value="AAPL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="getMarketData()" style="flex: 1; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                📈 Market Data
                            </button>
                            <button onclick="getSentiment()" style="flex: 1; background: #8b5cf6; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer;">
                                💭 Sentiment
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>📊 Analysis Results</h4>
                        <div id="financial-results" style="min-height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <p style="opacity: 0.6; text-align: center;">Enter a symbol and select analysis type</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geopolitics Tab -->
        <div id="geopolitics-tab" class="tab-content">
            <div class="section">
                <h3>🌍 Geopolitical Risk Analysis</h3>
                
                <div class="ai-grid" style="margin-bottom: 20px;">
                    <div class="ai-card">
                        <h4>⚠️ Risk Assessment</h4>
                        <div id="risk-assessment-display">Loading risk analysis...</div>
                    </div>
                    <div class="ai-card">
                        <h4>🌐 Global Factors</h4>
                        <div id="global-factors-display">Loading global factors...</div>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>📋 Risk Factors & Recommendations</h4>
                    <div id="geopolitical-details" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.1);">
                        <p style="opacity: 0.6; text-align: center;">Loading detailed geopolitical analysis...</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="loadGeopoliticalData()" style="background: #ef4444; border: none; padding: 12px 24px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
                        🔄 Refresh Risk Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist-tab" class="tab-content">
            <div class="section">
                <h3>⭐ Investment Watchlist</h3>
                
                <div class="settings-container" style="margin-bottom: 20px;">
                    <div class="settings-group">
                        <h4>➕ Add to Watchlist</h4>
                        <div class="setting-item">
                            <label for="watchlist-symbol">Stock Symbol:</label>
                            <input type="text" id="watchlist-symbol" placeholder="e.g., GOOGL" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 10px; color: #e2e8f0;">
                        </div>
                        <button onclick="addToWatchlist()" style="width: 100%; background: #10b981; border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; margin-top: 10px;">
                            ⭐ Add Symbol
                        </button>
                    </div>
                    
                    <div class="settings-group">
                        <h4>⚙️ Watchlist Settings</h4>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="auto-refresh-watchlist" checked>
                            <label for="auto-refresh-watchlist">Auto-refresh watchlist</label>
                        </div>
                        <div class="setting-item checkbox-setting">
                            <input type="checkbox" id="price-alerts" checked>
                            <label for="price-alerts">Price change alerts</label>
                        </div>
                    </div>
                </div>

                <div class="ai-card">
                    <h4>📊 My Watchlist</h4>
                    <div id="watchlist-display">
                        <p style="opacity: 0.6; text-align: center;">Loading watchlist...</p>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="loadWatchlist()" style="background: #3b82f6; border: none; padding: 8px 16px; border-radius: 6px; color: white; cursor: pointer;">
                            🔄 Refresh Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
            <p style="font-size: 0.8em; opacity: 0.6;">
                <strong>Architecture:</strong> FastAPI • PostgreSQL • Redis • Qdrant • Celery 🏗️<br>
                <strong>Deployment:</strong> Docker Containers • Production Ready • Scalable 🚀<br>
                <strong>Status:</strong> Full Production System Running Successfully 🌐
            </p>
        </div>
    </div>
    
    <!-- Backtest Explainer Modal -->
    <div id="backtest-explainer-modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:1000;">
        <div style="max-width:700px; margin: 60px auto; background:#111827; color:#e5e7eb; border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="color:#ffd700; margin:0;">Backtest Results: What do these mean?</h4>
                <button onclick="closeBacktestExplainer()" style="background:#374151; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">Close</button>
            </div>
            <div style="margin-top:10px; font-size:0.95em; line-height:1.5;">
                <p><strong>Iteration:</strong> Each loop trains on an expanding window, then tests forward for the selected period.</p>
                <p><strong>Accuracy:</strong> Direction accuracy on the test window. 80%+ is generally solid; 85%+ is strong.</p>
                <p><strong>Loss:</strong> Validation loss from training; lower is better. We use the best checkpoint per horizon.</p>
                <p><strong>Best:</strong> The iteration with the highest test accuracy. Consider using its checkpoint when deploying.</p>
                <p style="opacity:0.85;">See the Backtest Guide in the docs folder (docs/BACKTEST_GUIDE.md) for deeper details, zero-accuracy causes, and tips.</p>
            </div>
        </div>
    </div>
    <script>
    // Tab Management Functions (unified from main.js)
    function showTab(tabName) {
        console.log('🔄 Switching to tab:', tabName);
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab content
        const selectedContent = document.getElementById(tabName);
        if (selectedContent) {
            selectedContent.classList.add('active');
            console.log('✅ Tab content shown:', tabName);
        } else {
            console.error('❌ Tab content not found:', tabName);
        }

        // Add active class to selected tab button
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
            console.log('✅ Tab button activated');
        } else {
            console.error('❌ Tab button not found for:', tabName);
        }
    }

    // Direct tab switching function for debugging
    function showTabDirect(tabName) {
        console.log('🔄 Direct tab switch to:', tabName);
        showTab(tabName);
    }

    // Make functions globally available
    window.showTab = showTab;
    window.showTabDirect = showTabDirect;
    
    // Make function globally available
    window.showTabDirect = showTabDirect;

    // ===============================
    // NEW FUNCTIONALITY FOR ENHANCED FEATURES
    // ===============================

    // ML Functions
    async function getPrediction() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">🔄 Getting ML prediction...</p>';
        
        try {
            const response = await fetch(`/api/ml/predictions/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #3b82f6; margin-bottom: 10px;">🔮 ML Prediction for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                        <strong>Direction:</strong> ${data.predictions?.direction || 'N/A'}<br>
                        <strong>Confidence:</strong> ${data.predictions?.confidence || 'N/A'}<br>
                        <strong>Target Price:</strong> $${data.predictions?.target_price || 'N/A'}
                    </div>
                    <small style="opacity: 0.7;">Generated: ${new Date().toLocaleString()}</small>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ ${data.message || 'Failed to get prediction'}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Error: ${error.message}</p>`;
        }
    }

    async function trainModel() {
        const symbol = document.getElementById('ml-symbol').value.toUpperCase();
        const days = document.getElementById('training-days').value;
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('prediction-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">🏋️ Training model... This may take a while...</p>';
        
        try {
            const response = await fetch(`/api/ml/train/${symbol}?days_back=${days}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">✅ Training Completed for ${symbol}</h5>
                    <div style="background: rgba(16, 185, 129, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Training Period:</strong> ${days} days<br>
                        <strong>Status:</strong> ${data.training_result?.status || 'Completed'}<br>
                        <strong>Model Performance:</strong> ${data.training_result?.accuracy || 'N/A'}
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Training failed: ${data.message}</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Error: ${error.message}</p>`;
        }
    }

    // Financial Functions
    async function getMarketData() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">📈 Loading market data...</p>';
        
        try {
            const response = await fetch(`/api/market/${symbol}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                const marketData = data.data;
                resultsDiv.innerHTML = `
                    <h5 style="color: #10b981; margin-bottom: 10px;">📈 Market Data for ${symbol}</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Price:</strong> $${marketData.price}<br>
                            <strong>Change:</strong> ${marketData.change} (${marketData.change_percent})
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                            <strong>Volume:</strong> ${marketData.volume?.toLocaleString()}<br>
                            <strong>Range:</strong> $${marketData.low} - $${marketData.high}
                        </div>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Failed to load data</p>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Error: ${error.message}</p>`;
        }
    }

    async function getSentiment() {
        const symbol = document.getElementById('financial-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        const resultsDiv = document.getElementById('financial-results');
        resultsDiv.innerHTML = '<p style="text-align: center;">💭 Analyzing sentiment...</p>';
        
        try {
            // Fetch social sentiment
            const [socialResp, newsResp] = await Promise.all([
                fetch(`/api/sentiment/${symbol}`),
                fetch(`/api/news/sentiment/${symbol}`)
            ]);

            const socialData = await socialResp.json();
            const newsData = await newsResp.json();

            let socialHtml = '';
            if (socialData.status === 'success' && socialData.sentiment) {
                const s = socialData.sentiment;
                socialHtml = `
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 6px; padding: 10px;">
                        <strong>Social Sentiment</strong><br>
                        <strong>Overall Score:</strong> ${s.overall_score}<br>
                        <strong>Positive:</strong> ${(s.positive * 100).toFixed(1)}% | 
                        <strong>Negative:</strong> ${(s.negative * 100).toFixed(1)}%<br>
                        <strong>Volume:</strong> ${s.volume} mentions | 
                        <strong>Trending:</strong> ${s.trending ? '🔥 Yes' : '📊 Normal'}
                    </div>
                `;
            } else {
                socialHtml = `<div style="background: rgba(139, 92, 246, 0.08); border-radius: 6px; padding: 10px;">Social sentiment unavailable</div>`;
            }

            let newsHtml = '';
            if (newsData.status === 'success') {
                const rows = Array.isArray(newsData.data) ? newsData.data : [];
                if (rows.length > 0) {
                    const latest = rows[rows.length - 1];
                    const score = typeof latest.sentiment_score === 'number' ? latest.sentiment_score.toFixed(3) : latest.sentiment_score;
                    newsHtml = `
                        <div style="background: rgba(16, 185, 129, 0.08); border-radius: 6px; padding: 10px; margin-top: 8px;">
                            <strong>News Sentiment</strong><br>
                            <strong>Latest Score:</strong> ${score} | 
                            <strong>Articles:</strong> ${latest.article_count}
                        </div>
                    `;
                } else {
                    newsHtml = `
                        <div style="background: rgba(16, 185, 129, 0.08); border-radius: 6px; padding: 10px; margin-top: 8px;">
                            No sentiment data available
                        </div>
                    `;
                }
            } else {
                newsHtml = `<div style="background: rgba(16, 185, 129, 0.08); border-radius: 6px; padding: 10px; margin-top: 8px;">News sentiment unavailable</div>`;
            }

            resultsDiv.innerHTML = `
                <h5 style="color: #8b5cf6; margin-bottom: 10px;">💭 Sentiment Analysis for ${symbol}</h5>
                ${socialHtml}
                ${newsHtml}
            `;
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">❌ Error: ${error.message}</p>`;
        }
    }

    // Geopolitical Functions
    async function loadGeopoliticalData() {
        const riskDiv = document.getElementById('risk-assessment-display');
        const factorsDiv = document.getElementById('global-factors-display');
        const detailsDiv = document.getElementById('geopolitical-details');
        
        riskDiv.innerHTML = '🔄 Loading...';
        factorsDiv.innerHTML = '🔄 Loading...';
        detailsDiv.innerHTML = '<p style="text-align: center;">🔄 Loading detailed analysis...</p>';
        
        try {
            const response = await fetch('/api/financial/geopolitical-risks');
            const data = await response.json();
            
            if (data.status === 'success') {
                const riskData = data.data;
                
                // Update risk assessment
                riskDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 5px;">⚠️</div>
                        <strong>Risk Level: ${riskData.overall_risk_level}</strong><br>
                        <span style="font-size: 1.2em; color: #ffd700;">Score: ${riskData.risk_score}</span>
                    </div>
                `;
                
                // Update global factors
                factorsDiv.innerHTML = `
                    <div style="font-size: 0.9em;">
                        <strong>Active Factors:</strong><br>
                        ${riskData.factors?.length || 0} regions monitored<br>
                        Next update: ${new Date(riskData.next_update).toLocaleTimeString()}
                    </div>
                `;
                
                // Update detailed analysis
                let factorsHtml = '';
                if (riskData.factors) {
                    factorsHtml = riskData.factors.map(factor => `
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                            <strong>${factor.region}</strong> - ${factor.risk_type}<br>
                            <span style="color: #ffd700;">Level: ${factor.level}</span> | 
                            <span style="color: #10b981;">Impact: ${factor.impact}</span><br>
                            <small>${factor.description}</small>
                        </div>
                    `).join('');
                }
                
                let recommendationsHtml = '';
                if (riskData.recommendations) {
                    recommendationsHtml = `
                        <h5 style="color: #3b82f6; margin: 15px 0 10px;">📋 Recommendations:</h5>
                        ${riskData.recommendations.map(rec => `<div style="color: #10b981;">• ${rec}</div>`).join('')}
                    `;
                }
                
                detailsDiv.innerHTML = factorsHtml + recommendationsHtml;
            } else {
                riskDiv.innerHTML = '❌ Error';
                factorsDiv.innerHTML = '❌ Error';
                detailsDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load geopolitical data</p>';
            }
        } catch (error) {
            riskDiv.innerHTML = '❌ Error';
            factorsDiv.innerHTML = '❌ Error';
            detailsDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    // Watchlist Functions
    async function loadWatchlist() {
        const watchlistDiv = document.getElementById('watchlist-display');
        watchlistDiv.innerHTML = '<p style="text-align: center;">🔄 Loading watchlist...</p>';
        
        try {
            const response = await fetch('/api/watchlist');
            const data = await response.json();
            
            if (data.status === 'success') {
                if (data.watchlist && data.watchlist.length > 0) {
                    const watchlistHtml = data.watchlist.map(stock => {
                        const confPct = typeof stock.confidence === 'number' ? `${(stock.confidence * 100).toFixed(0)}%` : '--';
                        const isPos = (stock.expected_return || 0) > 0;
                        const changeColor = stock.change?.startsWith('+') ? '#10b981' : '#ef4444';
                        const sl = stock?.risk_7d?.stop_loss;
                        const tp = stock?.risk_7d?.take_profit;
                        const basis = stock?.risk_7d?.basis;
                        const rr = stock?.risk_7d?.rr;
                        const riskLine = (sl && tp) ? `<div style="font-size: 0.8em; opacity: 0.85;" title="Basis: ${basis || '—'} | RR ${rr || '—'}">SL/TP → $${Number(sl).toFixed(2)} / $${Number(tp).toFixed(2)}</div>` : '';
                        const sig = stock.recommendation || 'HOLD';
                        const ret = typeof stock.expected_return === 'number' ? `${isPos ? '+' : ''}${stock.expected_return.toFixed(2)}%` : '--';
                        return `
                            <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                <div>
                                    <strong style="color: #3b82f6;">${stock.symbol}</strong><br>
                                    <small>${stock.name || ''}</small>
                                </div>
                                <div style="text-align: right; min-width: 200px;">
                                    <div>$${(stock.price ?? 0).toFixed?.(2) || stock.price || '--'}</div>
                                    <div style="color: ${changeColor};">${stock.change || ''}</div>
                                </div>
                                <div style="text-align: right; min-width: 260px;">
                                    <div>${sig} • ${confPct} • ${ret}</div>
                                    ${riskLine}
                                </div>
                            </div>
                        `;
                    }).join('');
                    watchlistDiv.innerHTML = watchlistHtml;
                } else {
                    watchlistDiv.innerHTML = '<p style="opacity: 0.6; text-align: center;">No stocks in watchlist</p>';
                }
            } else {
                watchlistDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load watchlist</p>';
            }
        } catch (error) {
            watchlistDiv.innerHTML = `<p style="color: #ef4444; text-align: center;">Error: ${error.message}</p>`;
        }
    }

    async function addToWatchlist() {
        const symbol = document.getElementById('watchlist-symbol').value.toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        // For now, just add to UI - in real implementation would call API
        alert(`Added ${symbol} to watchlist! (Demo - would call API in production)`);
        document.getElementById('watchlist-symbol').value = '';
        loadWatchlist(); // Refresh the list
    }

    // AI Analysis handled by ml-scanner.js (module)
    
    // Debug function to see the prompt
    window.debugPrompt = async function() {
        const symbol = document.getElementById('ai-stock-input').value.trim().toUpperCase();
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        try {
            console.log('🐛 Fetching debug info for:', symbol);
            const response = await fetch(`/api/ai/debug-prompt/${symbol}`);
            const data = await response.json();
            
            if (!data.error) {
                console.log('🎯 PROMPT THAT WILL BE SENT TO PERPLEXITY:');
                console.log('═'.repeat(60));
                console.log(data.prompt);
                console.log('═'.repeat(60));
                console.log(`📊 Symbol: ${data.symbol}`);
                console.log(`💰 Current Price: $${data.current_price}`);
                console.log(`🤖 Model: ${data.model}`);
                console.log(`📝 Estimated Tokens: ${Math.round(data.estimated_tokens)}`);
                
                // Show in UI too
                document.getElementById('selected-stock-analysis').innerHTML = `
                    <div style="background: rgba(245, 158, 11, 0.1); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.8em;">
                        <strong style="color: #f59e0b;">🐛 DEBUG INFO for ${symbol}</strong><br>
                        <strong>Price:</strong> $${data.current_price}<br>
                        <strong>Model:</strong> ${data.model}<br>
                        <strong>Est. Tokens:</strong> ${Math.round(data.estimated_tokens)}<br>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #f59e0b;">📝 View Full Prompt</summary>
                            <pre style="white-space: pre-wrap; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
                        </details>
                    </div>
                `;
                
                alert(`Debug info logged to console! Check the browser console (F12) for full prompt details.`);
            } else {
                console.error('❌ Debug error:', data.error);
                alert('Error getting debug info: ' + data.error);
            }
        } catch (error) {
            console.error('❌ Debug request failed:', error);
            alert('Failed to get debug info: ' + error.message);
        }
    }
    
    window.updateRiskGauge = function(riskScore) {
        console.log('Updating risk gauge with score:', riskScore);
        // Update risk gauge needle position
        const needle = document.querySelector('#ai-risk-indicator .risk-needle');
        if (needle) {
            // Convert risk score (0-1) to degrees (-90 to 90)
            const degrees = (riskScore * 180) - 90;
            needle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
        }
    }
    
    // Allow Enter key to trigger analysis
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('ai-stock-input');
        const button = document.querySelector('button[onclick="analyzeStock()"]');
        
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    analyzeStock();
                }
            });
        }
        
        if (button) {
            button.addEventListener('click', function() {
                analyzeStock();
            });
        }
    });

    // Auto-load data when tabs are opened
    document.addEventListener('DOMContentLoaded', function() {
        // Load ML status and render into Overview tiles and Progressive box
        fetch('/api/ml/status')
            .then(r => r.json())
            .then(data => {
                const trainer = data?.components?.ml_trainer?.status || 'N/A';
                const models = data?.performance?.models_active ?? 0;
                const accuracy = data?.performance?.accuracy ?? 'N/A';

                // Overview: AI Models Status grid
                const grid = document.getElementById('ai-models-status');
                if (grid) {
                    grid.innerHTML = `
                        <div class="status-item">
                            <div class="status-icon">🧠</div>
                            <div class="status-label">${trainer}</div>
                            <div class="status-name">ML Trainer</div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">📦</div>
                            <div class="status-label">${models}</div>
                            <div class="status-name">Active Models</div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">🎯</div>
                            <div class="status-label">${accuracy}</div>
                            <div class="status-name">Avg. Accuracy</div>
                        </div>
                    `;
                }

                // Progressive ML box summary (optional)
                const prog = document.getElementById('progressive-ml-status-display');
                if (prog) {
                    prog.innerHTML = `
                        <div style="font-size: 0.9em;">
                            <strong>ML Trainer:</strong> ${trainer}<br>
                            <strong>Models:</strong> ${models} active<br>
                            <strong>Accuracy:</strong> ${accuracy}
                        </div>
                    `;
                }
            })
            .catch(() => {
                const grid = document.getElementById('ai-models-status');
                if (grid) {
                    grid.innerHTML = `
                        <div class="status-item">
                            <div class="status-icon">❌</div>
                            <div class="status-label">Error</div>
                            <div class="status-name">ML Status</div>
                        </div>
                    `;
                }
                const prog = document.getElementById('progressive-ml-status-display');
                if (prog) {
                    prog.innerHTML = '<div style="color: #ef4444;">❌ Failed to load ML status</div>';
                }
            });

        // Load sector performance
        fetch('/api/financial/sector-performance').then(r => r.json()).then(data => {
            if (data.status === 'success' && data.data) {
                const sectors = Object.entries(data.data).map(([name, info]) => 
                    `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${name}:</span>
                        <span style="color: ${info.change.startsWith('+') ? '#10b981' : '#ef4444'};">${info.change}</span>
                    </div>`
                ).join('');
                document.getElementById('sector-performance-display').innerHTML = sectors;
            }
        }).catch(() => {
            document.getElementById('sector-performance-display').innerHTML = 'Failed to load sector data';
        });

        // Load geopolitical data
        loadGeopoliticalData();
        
        // Load watchlist
        loadWatchlist();
        
        // Load AI market intelligence
        loadAIMarketIntelligence();
    });
    
    async function loadAIMarketIntelligence() {
        const intelligenceDiv = document.getElementById('ai-intelligence-container');
        intelligenceDiv.innerHTML = '<p style="text-align: center;">🤖 Loading AI market intelligence...</p>';
        
        try {
            const response = await fetch('/api/ai/market-intelligence');
            const data = await response.json();
            
            if (data.status === 'success' && data.data) {
                const intel = data.data;
                const sentiment = intel.market_sentiment || {};
                const risk = intel.risk_assessment || {};

                intelligenceDiv.innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 15px;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">🧠 Market Intelligence</h4>
                        <div style="font-size: 0.9em;">
                            <strong>Market Sentiment:</strong> ${sentiment.interpretation || 'Analyzing...'}<br>
                            <strong>Overall Trend:</strong> ${sentiment.trend || 'neutral'}<br>
                            <strong>Risk Level:</strong> ${risk.overall_risk || 'Calculating...'}
                        </div>
                    </div>
                `;
            } else {
                intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">❌ Failed to load market intelligence</p>';
            }
        } catch (error) {
            intelligenceDiv.innerHTML = '<p style="color: #ef4444; text-align: center;">❌ Market intelligence unavailable</p>';
        }
    }

    // Data Management Functions
    async function loadDataManagementStatus() {
        try {
            const response = await fetch('/api/data-management/status');
            const data = await response.json();
            
            // Update metrics
            document.getElementById('daily-downloads-count').textContent = data.daily_downloads || '0';
            document.getElementById('fundamental-updates-count').textContent = data.weekly_updates || '0';
            document.getElementById('errors-count').textContent = data.error_count || '0';
            document.getElementById('last-run-time').textContent = data.last_run ? 
                new Date(data.last_run).toLocaleString('he-IL', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                }) : 'אף פעם';
            
            // Update jobs table
            if (data.jobs) {
                const dailyJob = data.jobs.find(j => j.id === 'daily_data');
                const weeklyJob = data.jobs.find(j => j.id === 'weekly_fundamentals');
                
                if (dailyJob) {
                    document.getElementById('daily-last-run').textContent = 
                        dailyJob.last_run ? new Date(dailyJob.last_run).toLocaleString('he-IL') : 'אף פעם';
                    document.getElementById('daily-next-run').textContent = 
                        dailyJob.next_run ? new Date(dailyJob.next_run).toLocaleString('he-IL') : 'לא מתוזמן';
                    document.getElementById('daily-status').innerHTML = getDataStatusBadge(dailyJob.status);
                }
                
                if (weeklyJob) {
                    document.getElementById('weekly-last-run').textContent = 
                        weeklyJob.last_run ? new Date(weeklyJob.last_run).toLocaleString('he-IL') : 'אף פעם';
                    document.getElementById('weekly-next-run').textContent = 
                        weeklyJob.next_run ? new Date(weeklyJob.next_run).toLocaleString('he-IL') : 'לא מתוזמן';
                    document.getElementById('weekly-status').innerHTML = getDataStatusBadge(weeklyJob.status);
                }
            }
            
            // Update system health
            updateSystemHealth();
            
        } catch (error) {
            console.error('Error loading data management status:', error);
            addDataLog('❌ שגיאה בטעינת סטטוס: ' + error.message, 'error');
        }
    }

    function getDataStatusBadge(status) {
        const badges = {
            'running': '<span style="background: #3182ce; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">רץ</span>',
            'success': '<span style="background: #38a169; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">הושלם</span>',
            'error': '<span style="background: #e53e3e; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">שגיאה</span>',
            'scheduled': '<span style="background: #4a5568; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">מתוזמן</span>',
            'stopped': '<span style="background: #718096; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">עצור</span>'
        };
        return badges[status] || '<span style="background: #718096; color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8em;">לא ידוע</span>';
    }

    async function runDataJob(jobType) {
        try {
            addDataLog(`🚀 מתחיל הרצת משימה: ${jobType}`, 'info');
            
            const response = await fetch(`/api/data-management/run-job/${jobType}`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                addDataLog(`✅ משימה התחילה בהצלחה: ${jobType}`, 'success');
                addDataLog(`📋 Job ID: ${result.job_id}`, 'info');
                
                // Start polling for job logs
                pollJobStatus(result.job_id);
            } else {
                addDataLog(`❌ כשל בהתחלת משימה: ${result.error}`, 'error');
            }
            
            // Refresh status after 2 seconds
            setTimeout(loadDataManagementStatus, 2000);
            
        } catch (error) {
            addDataLog(`❌ שגיאה בהרצת משימה: ${error.message}`, 'error');
        }
    }

    let pollInterval = null;
    
    async function pollJobStatus(jobId) {
        // Clear any existing polling
        if (pollInterval) {
            clearInterval(pollInterval);
        }
        
        let lastLogCount = 0;
        
        pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/data-management/job-status/${jobId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const logs = data.logs || [];
                    
                    // Only show new logs
                    if (logs.length > lastLogCount) {
                        for (let i = lastLogCount; i < logs.length; i++) {
                            const log = logs[i];
                            let level = 'info';
                            if (log.message.includes('✅') || log.message.includes('SUCCESS')) {
                                level = 'success';
                            } else if (log.message.includes('❌') || log.message.includes('ERROR')) {
                                level = 'error';
                            } else if (log.message.includes('⚠️') || log.message.includes('WARNING')) {
                                level = 'warning';
                            }
                            addDataLog(log.message, level);
                        }
                        lastLogCount = logs.length;
                    }
                    
                    // Stop polling if job is completed
                    if (data.job.status === 'completed' || data.job.status === 'failed' || data.job.status === 'error') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        loadDataManagementStatus();
                    }
                }
            } catch (error) {
                console.error('Error polling job status:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    async function runAllDataJobs() {
        addDataLog('🚀 מתחיל הרצת כל המשימות...', 'info');
        
        await runDataJob('daily');
        await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
        await runDataJob('weekly');
    }

    function refreshDataStatus() {
        addDataLog('🔄 רענון סטטוס...', 'info');
        loadDataManagementStatus();
        addDataLog('✅ סטטוס עודכן', 'success');
    }

    async function updateSystemHealth() {
        try {
            const response = await fetch('/api/system/health');
            const health = await response.json();
            
            updateHealthIcon('db-health-icon', health.database);
            updateHealthIcon('scheduler-health-icon', health.scheduler);
            updateHealthIcon('api-health-icon', health.api);
            updateHealthIcon('storage-health-icon', health.storage);
            
        } catch (error) {
            console.error('Error updating system health:', error);
        }
    }

    function updateHealthIcon(iconId, status) {
        const icon = document.getElementById(iconId);
        if (!icon) return;
        
        if (status === true || status === 'healthy') {
            icon.style.color = '#38a169'; // Green
        } else if (status === 'warning') {
            icon.style.color = '#d69e2e'; // Yellow
        } else {
            icon.style.color = '#e53e3e'; // Red
        }
    }

    function addDataLog(message, level = 'info') {
        const container = document.getElementById('recent-logs');
        if (!container) return;
        
        const timestamp = new Date().toLocaleTimeString('he-IL');
        const logColors = {
            'success': '#68d391',
            'error': '#fc8181', 
            'warning': '#f6e05e',
            'info': '#63b3ed'
        };
        
        const logEntry = document.createElement('div');
        logEntry.style.color = logColors[level] || logColors.info;
        logEntry.innerHTML = `<span style="opacity: 0.7;">[${timestamp}]</span> ${message}`;
        
        container.appendChild(logEntry);
        container.scrollTop = container.scrollHeight;
        
        // Keep only last 50 log entries
        while (container.children.length > 50) {
            container.removeChild(container.firstChild);
        }
    }

    function viewDataLogs(jobType) {
        window.open(`/api/data-management/logs/${jobType}`, '_blank');
    }

    function downloadDataLogs() {
        const link = document.createElement('a');
        link.href = '/api/data-management/logs/download';
        link.download = `logs_${new Date().toISOString().split('T')[0]}.zip`;
        link.click();
    }

    // Load data management status when the tab is shown
    function initDataManagement() {
        if (document.getElementById('data-management-tab').style.display !== 'none') {
            loadDataManagementStatus();
            // Refresh every 30 seconds
            setInterval(() => {
                if (document.getElementById('data-management-tab').style.display !== 'none') {
                    loadDataManagementStatus();
                }
            }, 30000);
        }
    }

    // Hook into the tab switching function
    const originalShowTabDirect = window.showTabDirect;
    window.showTabDirect = function(tabId) {
        originalShowTabDirect(tabId);
        if (tabId === 'data-management-tab') {
            setTimeout(initDataManagement, 100); // Small delay to ensure tab is visible
        } else if (tabId === 'progressive-ml-tab') {
            setTimeout(initProgressiveML, 100); // Initialize Progressive ML tab
        }
    };

    // Progressive ML Functions
    async function initProgressiveML() {
        await loadProgressiveMLStatus();
        await loadProgressiveModels();
        await loadProgressiveTrainingStatus();
    }

    async function loadProgressiveMLStatus() {
        try {
            const response = await fetch('/api/ml/progressive/status');
            const data = await response.json();
            
            const statusDisplay = document.getElementById('progressive-ml-status-display');
            if (data.status === 'available') {
                statusDisplay.innerHTML = `
                    <div style="color: #10b981;">✅ Progressive ML System Online</div>
                    <div style="font-size: 0.85em; margin-top: 5px;">
                        📊 Data Loader: ${data.data_loader ? '✅' : '❌'}<br>
                        🏋️ Trainer: ${data.trainer ? '✅' : '❌'}<br>
                        🔮 Predictor: ${data.predictor ? '✅' : '❌'}<br>
                        🎯 Training: ${data.training?.status || 'Unknown'}
                    </div>
                `;
            } else {
                statusDisplay.innerHTML = '<div style="color: #ef4444;">❌ Progressive ML System Unavailable</div>';
            }
        } catch (error) {
            console.error('Error loading Progressive ML status:', error);
            document.getElementById('progressive-ml-status-display').innerHTML = '<div style="color: #ef4444;">❌ Error loading status</div>';
        }
    }

    async function loadProgressiveModels() {
        try {
            const response = await fetch('/api/ml/progressive/models');
            const data = await response.json();
            
            const modelsDisplay = document.getElementById('progressive-models-display');
            modelsDisplay.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Available Models:</div>
                        ${data.available_models.map(model => `<div style="line-height: 1.4;">• ${model.toUpperCase()}</div>`).join('')}
                    </div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">Training Modes:</div>
                        ${data.available_modes.map(mode => `<div style="line-height: 1.4;">• ${mode}</div>`).join('')}
                        <div style="font-weight: 600; margin-top: 8px; margin-bottom: 4px;">Models Directory:</div>
                        <div style="line-height: 1.4;">📁 ${data.models_saved?.directory || 'N/A'} ${data.models_saved?.found ? '✅' : '❌'}</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Progressive models:', error);
            document.getElementById('progressive-models-display').innerHTML = '<div style="color: #ef4444;">❌ Error loading models</div>';
        }
    }

    async function loadProgressiveTrainingStatus() {
        try {
            const response = await fetch('/api/ml/progressive/training/status');
            const data = await response.json();
            
            const statusDisplay = document.getElementById('progressive-training-status-display');
            const statusText = data.status || (data.trainer_available ? 'success' : 'unavailable');
            const isTraining = !!(data.is_training);
            const trainerReady = !!(data.trainer_available);
            statusDisplay.innerHTML = `
                <div style="font-size: 0.85em;">
                    <div><strong>Status:</strong> ${statusText}</div>
                    <div><strong>Training:</strong> ${isTraining ? '🔄 Active' : '⏸️ Idle'}</div>
                    <div><strong>Trainer:</strong> ${trainerReady ? '✅ Ready' : '❌ Not Ready'}</div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Progressive training status:', error);
            document.getElementById('progressive-training-status-display').innerHTML = '<div style="color: #ef4444;">❌ Error loading training status</div>';
        }
    }

    async function getProgressivePrediction() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const mode = document.getElementById('progressive-mode').value;
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }

        const resultsDiv = document.getElementById('progressive-prediction-results');
        resultsDiv.innerHTML = '<div style="text-align: center;">🔄 Preparing data (ensure)...</div>';

        // Ensure symbol data exists and is fresh before prediction
        try {
            const ensureRes = await fetch(`/api/data/ensure/${symbol}`);
            const ensureJson = await ensureRes.json();
            const ensureHtml = renderEnsureSummary(ensureJson, symbol);
            resultsDiv.innerHTML = ensureHtml + '<div style="text-align: center; margin-top:8px;">🔄 Getting progressive predictions...</div>';
        } catch (e) {
            // Non-fatal for prediction; show warning and continue
            resultsDiv.innerHTML = `<div style="background:#3b82f61a;border:1px solid #3b82f655;color:#93c5fd;padding:8px;border-radius:6px;">⚠️ Ensure step warning: ${e?.message || e}</div>`;
        }

        try {
            const response = await fetch(`/api/ml/progressive/predict/${symbol}?mode=${mode}`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            console.log('API Response:', data); // Debug log
            
            if (data.status === 'success' && data.predictions) {
                displayProgressivePredictions(data.predictions, symbol, mode);
            } else {
                console.error('API returned error or no predictions:', data);
                resultsDiv.innerHTML = `<div style="color: #ef4444;">❌ API Error: ${data.message || 'No predictions available'}</div>`;
            }
        } catch (error) {
            console.error('Error getting progressive prediction:', error);
            resultsDiv.innerHTML = `<div style="color: #ef4444;">❌ Error: ${error.message}</div>`;
        }
    }

    function displayProgressivePredictions(predictions, symbol, mode) {
        const resultsDiv = document.getElementById('progressive-prediction-results');
        
        // Check if predictions object exists
        if (!predictions) {
            resultsDiv.innerHTML = '<div style="color: #ef4444;">❌ No prediction data available</div>';
            return;
        }
        
        console.log('Processing predictions:', predictions); // Debug log
        
        // Check if we have the expected structure
        if (typeof predictions !== 'object') {
            resultsDiv.innerHTML = '<div style="color: #ef4444;">❌ Invalid prediction data format</div>';
            return;
        }
        
        // Header
        let html = `
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border-radius: 12px; border: 2px solid rgba(59,130,246,0.3);">
                <div style="font-size: 1.8em; font-weight: bold; color: #60a5fa;">📊 Progressive ML Predictions</div>
                <div style="font-size: 1.3em; margin-top: 8px; color: #93c5fd;">${symbol}</div>
            </div>
        `;
        
        // Current Price
        if (predictions.current_price !== undefined && predictions.current_price !== null && !isNaN(predictions.current_price)) {
            html += `
                <div style="margin: 15px 0; padding: 20px; background: rgba(34,197,94,0.15); border-radius: 10px; border-left: 4px solid #22c55e;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 0.9em; color: #86efac; margin-bottom: 5px;">💵 Current Price</div>
                            <div style="font-size: 2em; font-weight: bold; color: #22c55e;">$${predictions.current_price.toFixed(2)}</div>
                        </div>
                        <div style="text-align: right; color: #94a3b8; font-size: 0.85em;">
                            📅 ${predictions.current_date || 'Latest'}
                        </div>
                    </div>
                </div>
            `;
        } else {
            console.warn('Current price not available or invalid:', predictions.current_price);
            html += `
                <div style="margin: 15px 0; padding: 20px; background: rgba(239,68,68,0.15); border-radius: 10px; border-left: 4px solid #ef4444;">
                    <div>
                        <div style="font-size: 0.9em; color: #fca5a5; margin-bottom: 5px;">⚠️ Current Price</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #ef4444;">Price data unavailable</div>
                    </div>
                </div>
            `;
        }
        
        // Predictions for each horizon
        if (predictions.predictions && Object.keys(predictions.predictions).length > 0) {
            html += '<div style="margin: 20px 0;"><div style="font-size: 1.2em; font-weight: bold; color: #60a5fa; margin-bottom: 15px;">📈 Price Predictions</div>';
            
            const horizons = Object.keys(predictions.predictions).sort((a, b) => {
                return parseInt(a) - parseInt(b);
            });
            
            horizons.forEach(horizonKey => {
                const pred = predictions.predictions[horizonKey];
                if (!pred || typeof pred !== 'object') {
                    console.warn(`Skipping invalid prediction for ${horizonKey}:`, pred);
                    return; // Skip if prediction data is missing or invalid
                }
                
                // Ensure numeric values are valid numbers
                const priceChange = (typeof pred.price_change_pct === 'number' && !isNaN(pred.price_change_pct)) ? pred.price_change_pct : 0;
                const targetPrice = (typeof pred.target_price === 'number' && !isNaN(pred.target_price)) ? pred.target_price : 0;
                const priceChangeAbs = (typeof pred.price_change_abs === 'number' && !isNaN(pred.price_change_abs)) ? pred.price_change_abs : 0;
                const confidence = (typeof pred.confidence === 'number' && !isNaN(pred.confidence)) ? pred.confidence : 0;
                const directionProb = (typeof pred.direction_prob === 'number' && !isNaN(pred.direction_prob)) ? pred.direction_prob : 0.5;
                const numModels = (typeof pred.num_models === 'number' && !isNaN(pred.num_models)) ? pred.num_models : 0;
                const modelAgreement = (typeof pred.model_agreement_std === 'number' && !isNaN(pred.model_agreement_std)) ? pred.model_agreement_std : 0;
                
                const isPositive = priceChange > 0;
                const changeColor = isPositive ? '#22c55e' : '#ef4444';
                const changeIcon = isPositive ? '📈' : '📉';
                const signalColor = pred.signal === 'BUY' ? '#22c55e' : pred.signal === 'SELL' ? '#ef4444' : '#eab308';
                
                html += `
                    <div style="margin: 12px 0; padding: 18px; background: rgba(30,41,59,0.5); border-radius: 10px; border: 1px solid rgba(71,85,105,0.5); transition: all 0.3s; cursor: pointer;" 
                         onmouseover="this.style.background='rgba(30,41,59,0.8)'; this.style.borderColor='rgba(59,130,246,0.5)'" 
                         onmouseout="this.style.background='rgba(30,41,59,0.5)'; this.style.borderColor='rgba(71,85,105,0.5)'">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="font-size: 1.1em; font-weight: bold; color: #60a5fa;">⏰ ${horizonKey.toUpperCase()}</div>
                            <div style="padding: 6px 14px; background: ${signalColor}33; color: ${signalColor}; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                                📡 ${pred.signal || 'HOLD'}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 12px;">
                            
                            <div style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 0.85em; color: #93c5fd; margin-bottom: 4px;">🎯 Target Price</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #60a5fa;">$${targetPrice.toFixed(2)}</div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(${isPositive ? '34,197,94' : '239,68,68'},0.1); border-radius: 8px; border-left: 3px solid ${changeColor};">
                                <div style="font-size: 0.85em; color: ${changeColor}bb; margin-bottom: 4px;">${changeIcon} Price Change</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: ${changeColor};">${priceChange > 0 ? '+' : ''}${(priceChange * 100).toFixed(2)}%</div>
                                <div style="font-size: 0.9em; color: ${changeColor}99; margin-top: 2px;">${priceChangeAbs > 0 ? '+' : ''}$${priceChangeAbs.toFixed(2)}</div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(234,179,8,0.1); border-radius: 8px; border-left: 3px solid #eab308;">
                                <div style="font-size: 0.85em; color: #fde047; margin-bottom: 4px;">🎲 Confidence</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #facc15;">${(confidence * 100).toFixed(1)}%</div>
                                <div style="width: 100%; height: 6px; background: rgba(234,179,8,0.2); border-radius: 3px; margin-top: 6px; overflow: hidden;">
                                    <div style="width: ${(confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #eab308, #facc15); border-radius: 3px;"></div>
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(168,85,247,0.1); border-radius: 8px; border-left: 3px solid #a855f7;">
                                <div style="font-size: 0.85em; color: #c084fc; margin-bottom: 4px;">🔼 Direction</div>
                                <div style="font-size: 1.3em; font-weight: bold; color: #a855f7;">${pred.direction || 'NEUTRAL'}</div>
                                <div style="font-size: 0.9em; color: #c084fc99; margin-top: 2px;">${(directionProb * 100).toFixed(1)}% probability</div>
                            </div>
                            
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: rgba(100,116,139,0.1); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.85em; color: #94a3b8;">
                                🤖 Based on <strong style="color: #cbd5e1;">${numModels}</strong> model${numModels > 1 ? 's' : ''}
                            </div>
                            <div style="font-size: 0.85em; color: #64748b;">
                                📊 Agreement: ${(modelAgreement * 100).toFixed(1)}%
                            </div>
                        </div>
                        
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Overall Sentiment
        if (predictions.overall_sentiment && typeof predictions.overall_sentiment === 'object') {
            const sentiment = predictions.overall_sentiment;
            const sentimentColor = sentiment.sentiment === 'BULLISH' ? '#22c55e' : 
                                  sentiment.sentiment === 'BEARISH' ? '#ef4444' : '#eab308';
            const sentimentIcon = sentiment.sentiment === 'BULLISH' ? '📈' : 
                                 sentiment.sentiment === 'BEARISH' ? '📉' : '➡️';
            
            // Validate sentiment values
            const sentimentStrength = (typeof sentiment.strength === 'number' && !isNaN(sentiment.strength)) ? sentiment.strength : 0;
            const sentimentConfidence = (typeof sentiment.confidence === 'number' && !isNaN(sentiment.confidence)) ? sentiment.confidence : 0;
            const sentimentAvgChange = (typeof sentiment.avg_price_change === 'number' && !isNaN(sentiment.avg_price_change)) ? sentiment.avg_price_change : 0;
            
            html += `
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(168,85,247,0.15)); border-radius: 12px; border: 2px solid rgba(139,92,246,0.3);">
                    <div style="font-size: 1.2em; font-weight: bold; color: #a78bfa; margin-bottom: 15px;">🎭 Overall Market Sentiment</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                        
                        <div style="padding: 12px; background: rgba(${sentimentColor === '#22c55e' ? '34,197,94' : sentimentColor === '#ef4444' ? '239,68,68' : '234,179,8'},0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Sentiment</div>
                            <div style="font-size: 1.8em;">${sentimentIcon}</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${sentimentColor}; margin-top: 4px;">${sentiment.sentiment || 'NEUTRAL'}</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(59,130,246,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Strength</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #60a5fa; margin-top: 10px;">${(sentimentStrength * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(234,179,8,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Confidence</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #facc15; margin-top: 10px;">${(sentimentConfidence * 100).toFixed(1)}%</div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(168,85,247,0.15); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #c4b5fd; margin-bottom: 6px;">Avg Change</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #a855f7; margin-top: 10px;">${(sentimentAvgChange * 100).toFixed(2)}%</div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // Risk Metrics
        if (predictions.risk_metrics && typeof predictions.risk_metrics === 'object') {
            const risk = predictions.risk_metrics;
            const riskColor = risk.risk_level === 'HIGH' ? '#ef4444' : 
                            risk.risk_level === 'MEDIUM' ? '#eab308' : '#22c55e';
            
            // Validate risk metrics values
            const riskVolatility = (typeof risk.volatility === 'number' && !isNaN(risk.volatility)) ? risk.volatility : 0;
            const riskMaxGain = (typeof risk.max_gain === 'number' && !isNaN(risk.max_gain)) ? risk.max_gain : 0;
            const riskMaxLoss = (typeof risk.max_loss === 'number' && !isNaN(risk.max_loss)) ? risk.max_loss : 0;
            const riskRewardRatio = (typeof risk.risk_reward_ratio === 'number' && !isNaN(risk.risk_reward_ratio)) ? risk.risk_reward_ratio : 0;
            const riskRange = (typeof risk.prediction_range === 'number' && !isNaN(risk.prediction_range)) ? risk.prediction_range : 0;
            
            html += `
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(251,146,60,0.1)); border-radius: 12px; border: 2px solid rgba(239,68,68,0.3);">
                    <div style="font-size: 1.2em; font-weight: bold; color: #fca5a5; margin-bottom: 15px;">⚠️ Risk Analysis</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        
                        <div style="padding: 14px; background: rgba(${riskColor === '#22c55e' ? '34,197,94' : riskColor === '#ef4444' ? '239,68,68' : '234,179,8'},0.15); border-radius: 8px; text-align: center; border: 2px solid ${riskColor}44;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">Risk Level</div>
                            <div style="font-size: 1.8em; font-weight: bold; color: ${riskColor}; margin-top: 8px;">${risk.risk_level || 'UNKNOWN'}</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(251,146,60,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">📊 Volatility</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #fb923c; margin-top: 8px;">${(riskVolatility * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">📈 Max Gain</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #22c55e; margin-top: 8px;">+${(riskMaxGain * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(239,68,68,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">📉 Max Loss</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #ef4444; margin-top: 8px;">${(riskMaxLoss * 100).toFixed(2)}%</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(59,130,246,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">⚖️ Risk/Reward</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #3b82f6; margin-top: 8px;">${riskRewardRatio.toFixed(2)}</div>
                        </div>
                        
                        <div style="padding: 14px; background: rgba(234,179,8,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.85em; color: #fecaca; margin-bottom: 6px;">📏 Price Range</div>
                            <div style="font-size: 1.4em; font-weight: bold; color: #eab308; margin-top: 8px;">$${riskRange.toFixed(2)}</div>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        resultsDiv.innerHTML = html;
    }

    let trainingPollingInterval = null;

    async function startProgressiveTraining() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const mode = document.getElementById('progressive-mode').value;
        const modelSelect = document.getElementById('progressive-model-types');
        const selectedModels = Array.from(modelSelect.selectedOptions).map(option => option.value);
        
        if (!symbol) {
            alert('Please enter a stock symbol');
            return;
        }
        
        if (selectedModels.length === 0) {
            alert('Please select at least one model type');
            return;
        }

        const resultsDiv = document.getElementById('progressive-training-results');
        resultsDiv.innerHTML = '<div style="text-align: center;">🔄 Preparing data (ensure)...</div>';

        // Ensure symbol data exists and is fresh before training
        try {
            const ensureRes = await fetch(`/api/data/ensure/${symbol}`);
            const ensureJson = await ensureRes.json();
            const ensureHtml = renderEnsureSummary(ensureJson, symbol);
            resultsDiv.innerHTML = ensureHtml + '<div style="text-align: center; margin-top:8px;">🚀 Starting progressive training...</div>';
        } catch (e) {
            resultsDiv.innerHTML = `<div style="background:#3b82f61a;border:1px solid #3b82f655;color:#93c5fd;padding:8px;border-radius:6px;">⚠️ Ensure step warning: ${e?.message || e}</div>`;
        }

        try {
            const response = await fetch(`/api/ml/progressive/train?symbol=${symbol}&model_types=${selectedModels.join(',')}&mode=${mode}`, {
                method: 'POST'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // New async training returns job_id immediately
            if (data.status === 'training_started' && data.job_id) {
                // Show progress bar
                showTrainingProgress(data.job_id, symbol);
                
                // Start polling for updates
                if (trainingPollingInterval) {
                    clearInterval(trainingPollingInterval);
                }
                
                trainingPollingInterval = setInterval(async () => {
                    await pollTrainingProgress(data.job_id, symbol);
                }, 2000); // Poll every 2 seconds
                
            } else if (data.status === 'training_completed') {
                // Old synchronous response (backward compatibility)
                displayTrainingResults(data, symbol);
            } else {
                resultsDiv.innerHTML = '<div style="color: #ef4444;">❌ Training failed or status unknown</div>';
            }
        } catch (error) {
            console.error('Error starting progressive training:', error);
            resultsDiv.innerHTML = `<div style="color: #ef4444;">❌ Error: ${error.message}</div>`;
        }
    }

    // Helper to render ensure summary panel
    function renderEnsureSummary(ensureJson, symbol) {
        try {
            const ok = ensureJson && ensureJson.status === 'success' && ensureJson.summary;
            const s = ok ? ensureJson.summary : null;
            if (!s) {
                return `<div style="background:#ef44441a;border:1px solid #ef444455;color:#fecaca;padding:8px;border-radius:6px;">❌ Ensure failed for ${symbol}: ${ensureJson?.detail || ensureJson?.message || 'Unknown error'}</div>`;
            }
            const counts = {
                created: Object.values(s.created || {}).filter(Boolean).length,
                updated: Object.values(s.updated || {}).filter(Boolean).length,
                skipped: Object.values(s.skipped || {}).filter(Boolean).length,
                errors: Object.values(s.errors || {}).filter(Boolean).length,
            };
            const errorLines = Object.entries(s.errors || {})
                .filter(([,v]) => v)
                .map(([k,v]) => `<div>• ${k}: ${v}</div>`)?.join('') || '';
            return `
                <div style="background:#111827;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="font-weight:600;color:#fbbf24;">📦 Data Ensure for ${symbol}</div>
                        <div style="font-size:0.85em;color:#9ca3af;">dir: <span style="color:#93c5fd;">${s.stock_dir}</span></div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;margin-top:8px;">
                        <div style="background:#16a34a22;border:1px solid #16a34a55;border-radius:6px;padding:6px;text-align:center;">✅ Created: <strong>${counts.created}</strong></div>
                        <div style="background:#3b82f622;border:1px solid #3b82f655;border-radius:6px;padding:6px;text-align:center;">🔄 Updated: <strong>${counts.updated}</strong></div>
                        <div style="background:#6b728022;border:1px solid #6b728055;border-radius:6px;padding:6px;text-align:center;">⏭️ Skipped: <strong>${counts.skipped}</strong></div>
                        <div style="background:#ef444422;border:1px solid #ef444455;border-radius:6px;padding:6px;text-align:center;">⚠️ Errors: <strong>${counts.errors}</strong></div>
                    </div>
                    ${counts.errors ? `<div style="margin-top:8px;color:#fecaca;font-size:0.85em;">${errorLines}</div>` : ''}
                </div>
            `;
        } catch (e) {
            return '';
        }
    }

    function showTrainingProgress(jobId, symbol) {
        const resultsDiv = document.getElementById('progressive-training-results');
        resultsDiv.innerHTML = `
            <div style="padding: 15px;">
                <div style="color: #10b981; font-size: 1.1em; margin-bottom: 10px;">
                    <strong>🧠 Training ${symbol}</strong>
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 0.9em; color: #9ca3af;" id="training-current-step">Initializing...</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 8px;">
                    <div id="training-progress-bar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85em; font-weight: bold;">
                        0%
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #9ca3af;">
                    <span id="training-progress-text">Progress: 0%</span>
                    <span id="training-eta-text">Calculating ETA...</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.8em; color: #6b7280;">
                    Job ID: <code style="background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 3px;">${jobId}</code>
                </div>
            </div>
        `;
    }

    async function pollTrainingProgress(jobId, symbol) {
        try {
            const response = await fetch(`/api/ml/progressive/training/status/${jobId}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update progress bar
            const progressBar = document.getElementById('training-progress-bar');
            const progressText = document.getElementById('training-progress-text');
            const etaText = document.getElementById('training-eta-text');
            const currentStepText = document.getElementById('training-current-step');
            
            if (progressBar && data.progress !== undefined) {
                const progress = Math.round(data.progress);
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                progressText.textContent = `Progress: ${progress}%`;
            }
            
            if (currentStepText && data.current_step) {
                currentStepText.textContent = data.current_step;
            }
            
            if (etaText && data.eta_seconds !== null && data.eta_seconds !== undefined) {
                const minutes = Math.floor(data.eta_seconds / 60);
                const seconds = Math.round(data.eta_seconds % 60);
                if (minutes > 0) {
                    etaText.textContent = `ETA: ${minutes}m ${seconds}s`;
                } else {
                    etaText.textContent = `ETA: ${seconds}s`;
                }
            } else if (etaText) {
                etaText.textContent = 'Calculating ETA...';
            }
            
            // Check if completed or failed
            if (data.status === 'completed') {
                clearInterval(trainingPollingInterval);
                trainingPollingInterval = null;
                displayTrainingResults(data, symbol);
                await loadProgressiveTrainingStatus();
            } else if (data.status === 'failed') {
                clearInterval(trainingPollingInterval);
                trainingPollingInterval = null;
                const resultsDiv = document.getElementById('progressive-training-results');
                resultsDiv.innerHTML = `<div style="color: #ef4444;">❌ Training failed: ${data.error || 'Unknown error'}</div>`;
            }
            
        } catch (error) {
            console.error('Error polling training progress:', error);
            // Don't stop polling on temporary errors
        }
    }

    function displayTrainingResults(data, symbol) {
        const resultsDiv = document.getElementById('progressive-training-results');
        let html = `<div style="color: #10b981;"><strong>✅ Training Completed for ${symbol}</strong></div>`;
        
        html += `<div style="margin: 10px 0; font-size: 0.9em;">`;
        if (data.mode) html += `📊 Mode: ${data.mode}<br>`;
        if (data.model_types) html += `🧠 Models: ${data.model_types.join(', ')}<br>`;
        if (data.end_time) html += `⏰ Completed: ${new Date(data.end_time).toLocaleString()}<br>`;
        html += `</div>`;
        
        const result = data.result || data.training_result;
        if (result) {
            html += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                <strong>📈 Training Results:</strong><br>
                <pre style="font-size: 0.8em; overflow-x: auto; max-height: 300px;">${JSON.stringify(result, null, 2)}</pre>
            </div>`;
        }
        
        resultsDiv.innerHTML = html;
    }

    // ============================================
    // Advanced Backtesting Functions
    // ============================================

    // Update accuracy slider display
    document.addEventListener('DOMContentLoaded', function() {
        const accuracySlider = document.getElementById('backtest-target-accuracy');
        if (accuracySlider) {
            accuracySlider.addEventListener('input', (e) => {
                document.getElementById('accuracy-display').textContent = e.target.value + '%';
            });
        }
    });

    let backtestPollingInterval = null;
    let currentBacktestJobId = null;
    let backtestChart = null;

    async function startBacktesting() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const startDate = document.getElementById('backtest-start-date').value;
        const endDate = document.getElementById('backtest-end-date').value;
        const testPeriod = parseInt(document.getElementById('backtest-test-period').value);
        const maxIterations = parseInt(document.getElementById('backtest-max-iterations').value);
        const targetAccuracy = parseFloat(document.getElementById('backtest-target-accuracy').value) / 100;
        const autoStop = document.getElementById('backtest-auto-stop').checked;
        const modelSelect = document.getElementById('progressive-model-types');
        const selectedModels = Array.from(modelSelect.selectedOptions).map(option => option.value);

        // Enhanced validation with debug info
        console.log('Backtest parameters:', {
            symbol, startDate, endDate, testPeriod, maxIterations, 
            targetAccuracy, autoStop, selectedModels
        });

        if (!symbol || symbol.trim() === '') {
            alert('Please enter a stock symbol');
            return;
        }

        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        if (new Date(startDate) >= new Date(endDate)) {
            alert('Start date must be before end date');
            return;
        }

        if (isNaN(testPeriod) || testPeriod < 1 || testPeriod > 365) {
            alert('Test period must be between 1 and 365 days');
            return;
        }

        if (isNaN(maxIterations) || maxIterations < 1 || maxIterations > 50) {
            alert('Max iterations must be between 1 and 50');
            return;
        }

        if (isNaN(targetAccuracy) || targetAccuracy < 0.1 || targetAccuracy > 1.0) {
            alert('Target accuracy must be between 10% and 100%');
            return;
        }

        if (selectedModels.length === 0) {
            alert('Please select at least one model type');
            return;
        }

        // Show progress
        document.getElementById('backtest-progress').style.display = 'block';
        document.getElementById('backtest-results-container').style.display = 'none';
        document.getElementById('backtest-chart-container').style.display = 'none';
        document.getElementById('backtest-status-text').textContent = 'Starting backtest...';
        document.getElementById('backtest-progress-fill').style.width = '0%';

        // Collect indicator params (optional)
        const ind = {
            rsi_period: parseInt(document.getElementById('ind-rsi-period')?.value || '14'),
            macd_fast: parseInt(document.getElementById('ind-macd-fast')?.value || '12'),
            macd_slow: parseInt(document.getElementById('ind-macd-slow')?.value || '26'),
            macd_signal: parseInt(document.getElementById('ind-macd-signal')?.value || '9'),
            sma_periods: document.getElementById('ind-sma-periods')?.value || '5,10,20,50',
            ema_periods: document.getElementById('ind-ema-periods')?.value || '5,10,20,50',
            bb_period: parseInt(document.getElementById('ind-bb-period')?.value || '20'),
            bb_std: parseFloat(document.getElementById('ind-bb-std')?.value || '2')
        };

        // Create request payload
        const requestPayload = {
            symbol: symbol,
            train_start_date: startDate,
            train_end_date: endDate,
            test_period_days: testPeriod,
            max_iterations: maxIterations,
            target_accuracy: targetAccuracy,
            auto_stop: autoStop,
            model_types: selectedModels,
            indicator_params: ind
        };

        console.log('Sending backtest request:', requestPayload);
        const bodyString = JSON.stringify(requestPayload);
        console.log('Request body string:', bodyString);

        try {
            // Use relative URL to avoid any proxy/origin redirect that can drop POST bodies
            const apiUrl = `/api/ml/progressive/backtest`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: bodyString,
                // credentials intentionally omitted to reduce CORS complexity
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Backtest API Error:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();

            // New async path with job id
            if (data.status === 'backtest_started' && data.job_id) {
                if (data.preflight || data.plan || data.adjusted) {
                    displayPlanAndPreflight(data);
                }
                // Begin polling status
                if (backtestPollingInterval) {
                    clearInterval(backtestPollingInterval);
                }
                currentBacktestJobId = data.job_id;
                backtestPollingInterval = setInterval(async () => {
                    await pollBacktestProgress(data.job_id);
                }, 1500);
                document.getElementById('backtest-status-text').textContent = 'Backtest started...';
            } else if (data.status === 'success') {
                // Backward compatibility: immediate results
                displayBacktestResults(data.backtest_results);
            } else {
                document.getElementById('backtest-status-text').textContent = 'Backtest failed';
                alert('Backtesting failed: ' + (data.error || 'Unknown error'));
            }

        } catch (error) {
            console.error('Error starting backtest:', error);
            document.getElementById('backtest-status-text').textContent = 'Error: ' + error.message;
            alert('Error starting backtest: ' + error.message);
        }
    }

    async function startAutoBacktesting() {
        const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
        const modelSelect = document.getElementById('progressive-model-types');
        const selectedModels = Array.from(modelSelect.selectedOptions).map(option => option.value);
        if (!symbol) { alert('Please enter a stock symbol'); return; }
        if (selectedModels.length === 0) { alert('Select at least one model'); return; }

        document.getElementById('backtest-progress').style.display = 'block';
        document.getElementById('backtest-results-container').style.display = 'none';
        document.getElementById('backtest-chart-container').style.display = 'none';
        document.getElementById('backtest-plan-card').style.display = 'none';
        document.getElementById('backtest-champion-card').style.display = 'none';
        document.getElementById('backtest-status-text').textContent = 'Planning & starting…';
        document.getElementById('backtest-progress-fill').style.width = '0%';

        const ind = {
            rsi_period: parseInt(document.getElementById('ind-rsi-period')?.value || '14'),
            macd_fast: parseInt(document.getElementById('ind-macd-fast')?.value || '12'),
            macd_slow: parseInt(document.getElementById('ind-macd-slow')?.value || '26'),
            macd_signal: parseInt(document.getElementById('ind-macd-signal')?.value || '9'),
            sma_periods: document.getElementById('ind-sma-periods')?.value || '5,10,20,50',
            ema_periods: document.getElementById('ind-ema-periods')?.value || '5,10,20,50',
            bb_period: parseInt(document.getElementById('ind-bb-period')?.value || '20'),
            bb_std: parseFloat(document.getElementById('ind-bb-std')?.value || '2')
        };

        const payload = {
            symbol,
            auto_plan: true,
            deep_mode: true,
            ensure_fresh_data: true,
            auto_adjust_iterations: true,
            desired_iterations: 10,
            desired_test_period_days: 14,
            model_types: selectedModels,
            indicator_params: ind,
            train_start_date: '2000-01-01',
            train_end_date: '2099-12-31',
            test_period_days: 14,
            max_iterations: 10,
            target_accuracy: 0.85,
            auto_stop: true
        };

        try {
            // Use relative URL to avoid any proxy/origin redirect that can drop POST bodies
            const apiUrl = `/api/ml/progressive/backtest`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(typeof data?.detail === 'string' ? data.detail : JSON.stringify(data));
            }
            if (data.preflight || data.plan || data.adjusted) {
                displayPlanAndPreflight(data);
            }
            if (data.status === 'backtest_started' && data.job_id) {
                if (backtestPollingInterval) clearInterval(backtestPollingInterval);
                currentBacktestJobId = data.job_id;
                backtestPollingInterval = setInterval(async () => { await pollBacktestProgress(data.job_id); }, 1500);
                document.getElementById('backtest-status-text').textContent = 'Backtest started...';
            } else {
                document.getElementById('backtest-status-text').textContent = 'Backtest failed to start';
            }
        } catch (e) {
            console.error('Auto backtest failed:', e);
            alert('Auto backtest failed: ' + e.message);
            document.getElementById('backtest-progress').style.display = 'none';
        }
    }

    async function stopBacktesting() {
        try {
            if (backtestPollingInterval) {
                clearInterval(backtestPollingInterval);
                backtestPollingInterval = null;
            }
            if (currentBacktestJobId) {
                await fetch(`/api/ml/progressive/backtest/cancel/${currentBacktestJobId}`, { method: 'POST' });
            }
            document.getElementById('backtest-status-text').textContent = 'Cancelling...';
        } catch (e) {
            console.error('Stop backtest error:', e);
            document.getElementById('backtest-status-text').textContent = 'Stop requested';
        }
    }

    async function pollBacktestProgress(jobId) {
        try {
            const resp = await fetch(`/api/ml/progressive/backtest/status/${jobId}`);
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            const st = await resp.json();

            // Update progress UI
            const fill = document.getElementById('backtest-progress-fill');
            const statusText = document.getElementById('backtest-status-text');
            const pct = Math.max(0, Math.min(100, Math.round(st.progress || 0)));
            if (fill) fill.style.width = pct + '%';

            // ETA formatting
            let etaStr = '';
            if (st.eta_seconds !== null && st.eta_seconds !== undefined) {
                const m = Math.floor(st.eta_seconds / 60);
                const s = Math.round(st.eta_seconds % 60);
                etaStr = m > 0 ? ` • ETA: ${m}m ${s}s` : ` • ETA: ${s}s`;
            }
            if (statusText) statusText.textContent = `${st.current_step || 'Running...'} • ${pct}%${etaStr}`;

            if (st.preflight || st.plan || st.adjusted || st.note) {
                displayPlanAndPreflight(st);
            }
            if (st.champion) {
                displayChampion(st.champion);
            }
            // Auto-render current predictions from champion if available
            if (st.current_predictions && st.current_predictions.predictions) {
                try {
                    const cp = st.current_predictions;
                    const box = document.getElementById('backtest-current-preds');
                    if (box) {
                        const h = ['1d','7d','30d'].map(hk => {
                            const p = cp.predictions[hk];
                            if (!p) return null;
                            const sig = p.signal || (p.direction || '-');
                            const conf = typeof p.confidence === 'number' ? Math.round(p.confidence*100) + '%' : '—';
                            const pct = typeof p.price_change_pct === 'number' ? ((p.price_change_pct>=0?'+':'') + (p.price_change_pct*100).toFixed(1) + '%') : '—';
                            return `${hk.toUpperCase()}: ${sig} • Conf ${conf} • ${pct}`;
                        }).filter(Boolean).join(' | ');
                        // Build risk lines per horizon if available
                        const riskLines = ['1d','7d','30d'].map(hk => {
                            const p = cp.predictions[hk];
                            if (!p || !p.risk) return null;
                            const r = p.risk;
                            const slp = typeof r.stop_loss_pct === 'number' ? (r.stop_loss_pct*100).toFixed(1)+'%' : '—';
                            const tpp = typeof r.take_profit_pct === 'number' ? (r.take_profit_pct*100).toFixed(1)+'%' : '—';
                            const sl = typeof r.stop_loss === 'number' ? '$'+Number(r.stop_loss).toFixed(2) : '—';
                            const tp = typeof r.take_profit === 'number' ? '$'+Number(r.take_profit).toFixed(2) : '—';
                            const basis = r.basis ? ` • basis: ${r.basis}` : '';
                            const rr = r.rr ? ` • RR: 1:${r.rr}` : '';
                            return `${hk.toUpperCase()}: SL ${sl} (${slp}) • TP ${tp} (${tpp})${rr}${basis}`;
                        }).filter(Boolean).join('\n');
                        const tipParts = [
                            'Explanation:',
                            '• BUY/SELL/HOLD = Action signal from expected move magnitude (regression), resolved with direction probability.',
                            '• Conf = Blended confidence (model agreement + distance from 50% direction probability).',
                            '• %+ = Expected price change vs current price (capped per horizon to avoid outliers).',
                            'Caps: 1D ±10%, 7D ±20%, 30D ±40%.'
                        ];
                        // If any horizon is capped, annotate in tooltip
                        const cappedHorizons = ['1d','7d','30d'].filter(hk => cp.predictions[hk]?.capped).map(hk => hk.toUpperCase());
                        if (cappedHorizons.length) {
                            tipParts.push(`Capped: ${cappedHorizons.join(', ')}`);
                        }
                        if (riskLines) {
                            tipParts.push('', 'Risk (per horizon):', riskLines);
                        }
                        const tip = tipParts.join('\n');
                        // Compact inline SL/TP line
                        const compactRisk = ['1d','7d','30d'].map(hk => {
                            const p = cp.predictions[hk];
                            if (!p || !p.risk) return null;
                            const r = p.risk;
                            const sl = typeof r.stop_loss === 'number' ? '$'+Number(r.stop_loss).toFixed(2) : '—';
                            const tp = typeof r.take_profit === 'number' ? '$'+Number(r.take_profit).toFixed(2) : '—';
                            return `${hk.toUpperCase()}: ${sl}/${tp}`;
                        }).filter(Boolean).join(' | ');
                        box.innerHTML = h ? `<div><span title="${tip}">Current predictions → ${h}</span>${compactRisk ? `<div style='opacity:0.75; font-size:0.85em; margin-top:2px;'>SL/TP → ${compactRisk}</div>` : ''}</div>` : '';
                        document.getElementById('backtest-champion-card').style.display = 'block';
                    }
                } catch (e) { console.warn('render current preds failed', e); }
            }
            if (st.status === 'completed') {
                clearInterval(backtestPollingInterval);
                backtestPollingInterval = null;
                if (st.result) {
                    await displayBacktestResults(st.result);
                    if (st.champion) { displayChampion(st.champion); }
                    // Keep current predictions visible post-completion
                    if (st.current_predictions && st.current_predictions.predictions) {
                        try {
                            const cp = st.current_predictions;
                            const box = document.getElementById('backtest-current-preds');
                            if (box) {
                                const h = ['1d','7d','30d'].map(hk => {
                                    const p = cp.predictions[hk];
                                    if (!p) return null;
                                    const sig = p.signal || (p.direction || '-');
                                    const conf = typeof p.confidence === 'number' ? Math.round(p.confidence*100) + '%' : '—';
                                    const pct = typeof p.price_change_pct === 'number' ? ((p.price_change_pct>=0?'+':'') + (p.price_change_pct*100).toFixed(1) + '%') : '—';
                                    return `${hk.toUpperCase()}: ${sig} • Conf ${conf} • ${pct}`;
                                }).filter(Boolean).join(' | ');
                                const riskLines = ['1d','7d','30d'].map(hk => {
                                    const p = cp.predictions[hk];
                                    if (!p || !p.risk) return null;
                                    const r = p.risk;
                                    const slp = typeof r.stop_loss_pct === 'number' ? (r.stop_loss_pct*100).toFixed(1)+'%' : '—';
                                    const tpp = typeof r.take_profit_pct === 'number' ? (r.take_profit_pct*100).toFixed(1)+'%' : '—';
                                    const sl = typeof r.stop_loss === 'number' ? '$'+Number(r.stop_loss).toFixed(2) : '—';
                                    const tp = typeof r.take_profit === 'number' ? '$'+Number(r.take_profit).toFixed(2) : '—';
                                    const basis = r.basis ? ` • basis: ${r.basis}` : '';
                                    const rr = r.rr ? ` • RR: 1:${r.rr}` : '';
                                    return `${hk.toUpperCase()}: SL ${sl} (${slp}) • TP ${tp} (${tpp})${rr}${basis}`;
                                }).filter(Boolean).join('\n');
                                const tipParts = [
                                    'Explanation:',
                                    '• BUY/SELL/HOLD = Action signal from expected move magnitude (regression), resolved with direction probability.',
                                    '• Conf = Blended confidence (model agreement + distance from 50% direction probability).',
                                    '• %+ = Expected price change vs current price (capped per horizon to avoid outliers).',
                                    'Caps: 1D ±10%, 7D ±20%, 30D ±40%.'
                                ];
                                const cappedHorizons = ['1d','7d','30d'].filter(hk => cp.predictions[hk]?.capped).map(hk => hk.toUpperCase());
                                if (cappedHorizons.length) {
                                    tipParts.push(`Capped: ${cappedHorizons.join(', ')}`);
                                }
                                if (riskLines) {
                                    tipParts.push('', 'Risk (per horizon):', riskLines);
                                }
                                const tip = tipParts.join('\n');
                                const compactRisk = ['1d','7d','30d'].map(hk => {
                                    const p = cp.predictions[hk];
                                    if (!p || !p.risk) return null;
                                    const r = p.risk;
                                    const sl = typeof r.stop_loss === 'number' ? '$'+Number(r.stop_loss).toFixed(2) : '—';
                                    const tp = typeof r.take_profit === 'number' ? '$'+Number(r.take_profit).toFixed(2) : '—';
                                    return `${hk.toUpperCase()}: ${sl}/${tp}`;
                                }).filter(Boolean).join(' | ');
                                box.innerHTML = h ? `<div><span title="${tip}">Current predictions → ${h}</span>${compactRisk ? `<div style='opacity:0.75; font-size:0.85em; margin-top:2px;'>SL/TP → ${compactRisk}</div>` : ''}</div>` : '';
                                document.getElementById('backtest-champion-card').style.display = 'block';
                            }
                        } catch (e) {}
                    }
                } else {
                    document.getElementById('backtest-progress').style.display = 'none';
                    document.getElementById('backtest-results-container').style.display = 'none';
                    document.getElementById('backtest-chart-container').style.display = 'none';
                    alert('Backtest completed but no result received');
                }
            } else if (st.status === 'failed') {
                clearInterval(backtestPollingInterval);
                backtestPollingInterval = null;
                if (statusText) statusText.textContent = `Failed: ${st.error || 'Unknown error'}`;
                alert(`Backtest failed: ${st.error || 'Unknown error'}`);
            } else if (st.status === 'cancelled') {
                clearInterval(backtestPollingInterval);
                backtestPollingInterval = null;
                if (statusText) statusText.textContent = '⏹ Backtest cancelled';
                // Hide progress, don't render results
                document.getElementById('backtest-progress').style.display = 'none';
            } else if (st.status === 'cancelling') {
                // keep polling until we see final cancelled
            }
        } catch (err) {
            console.error('Error polling backtest progress:', err);
            // keep polling; transient errors are okay
        }
    }

    async function displayBacktestResults(results) {
        // Normalize and validate results structure
        if (!results || (!results.all_iterations && !results.iterations)) {
            // Try to fetch the latest saved results from the server as a fallback
            try {
                const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
                const fallbackResp = await fetch(`/api/ml/progressive/backtest/results/${symbol}`);
                if (fallbackResp.ok) {
                    const fallbackData = await fallbackResp.json();
                    if (fallbackData.status === 'success' && fallbackData.results) {
                        results = fallbackData.results;
                    }
                }
            } catch (e) {
                console.warn('Backtest fallback fetch failed:', e);
            }
        }

        // If still no iterations present, show a friendly error with details if available
        if (!results || (!results.all_iterations && !results.iterations)) {
            const msg = results && results.error ? `Backtest error: ${results.error}` : 'No results to display';
            alert(msg);
            document.getElementById('backtest-progress').style.display = 'none';
            document.getElementById('backtest-results-container').style.display = 'none';
            document.getElementById('backtest-chart-container').style.display = 'none';
            return;
        }

        // Map legacy saved format { iterations: [...] } to expected { all_iterations: [...] }
        if (!results.all_iterations && results.iterations) {
            // Compute best_iteration if missing
            try {
                const best = results.iterations.reduce((acc, it) => {
                    if (typeof it.accuracy === 'number' && it.accuracy > (acc.accuracy ?? -1)) return it;
                    return acc;
                }, {});
                results.all_iterations = results.iterations;
                if (!results.best_iteration && best && typeof best.iteration === 'number') {
                    results.best_iteration = best.iteration;
                }
            } catch (e) {
                console.warn('Failed to normalize legacy backtest results:', e);
                results.all_iterations = results.iterations;
            }
        }

        // Forward metrics are rendered during polling when available
        // Hide progress, show results
        document.getElementById('backtest-progress').style.display = 'none';
        document.getElementById('backtest-results-container').style.display = 'block';
        document.getElementById('backtest-chart-container').style.display = 'block';

        // Populate table and add tooltips on header
        // Forward metrics are rendered earlier and preserved in champion card
        const tbody = document.getElementById('backtest-results-tbody');
        tbody.innerHTML = '';

        // Add helpful tooltips to header cells if table exists
        try {
            const ths = document.querySelectorAll('#backtest-results-table thead th');
            if (ths && ths.length >= 6) {
                ths[0].title = 'Iteration number in the expanding-window backtest';
                ths[1].title = 'Last date included in training for this iteration';
                ths[2].title = 'Direction accuracy over the test window for this iteration';
                ths[3].title = 'Validation loss of the model during training (lower is better)';
                ths[4].title = 'Training duration for this iteration (seconds)';
                ths[5].title = 'Best iteration across all based on accuracy';
            }
        } catch (e) {
            // Safe to ignore
        }

        results.all_iterations.forEach((iter, index) => {
            const row = tbody.insertRow();
            const isBest = (iter.iteration === results.best_iteration);
            
            row.innerHTML = `
                <td style="padding: 8px;">${iter.iteration}</td>
                <td style="padding: 8px;">${iter.train_until}</td>
                <td style="padding: 8px; color: ${typeof iter.accuracy === 'number' && iter.accuracy >= 0.85 ? '#10b981' : '#f59e0b'};">${typeof iter.accuracy === 'number' ? (iter.accuracy * 100).toFixed(1) + '%' : 'N/A'}</td>
                <td style="padding: 8px;">${typeof iter.val_loss === 'number' ? iter.val_loss.toFixed(4) : 'N/A'}</td>
                <td style="padding: 8px;">${typeof iter.training_time === 'number' ? iter.training_time.toFixed(1) + 's' : 'N/A'}</td>
                <td style="padding: 8px;">${isBest ? '✅ Best' : ''}</td>
            `;
        });

        // Create chart
        createBacktestChart(results);
    }

    async function loadBacktestHistory() {
        try {
            const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
            if (!symbol) return;
            const resp = await fetch(`/api/ml/progressive/backtest/history/${symbol}`);
            const data = await resp.json();
            const listDiv = document.getElementById('backtest-history-list');
            if (!data || data.status !== 'success' || !Array.isArray(data.items) || data.items.length === 0) {
                listDiv.innerHTML = '<div style="opacity:0.7;">No history found</div>';
                return;
            }
            listDiv.innerHTML = data.items.map(item => {
                const acc = (typeof item.best_accuracy === 'number') ? (item.best_accuracy * 100).toFixed(1) + '%' : 'N/A';
                return `
                    <div style="display:flex; justify-content: space-between; align-items:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.08);">
                        <div>
                            <div style="font-size:0.9em;">${item.file}</div>
                            <small style="opacity:0.7;">${new Date(item.modified).toLocaleString()} • Best: ${acc} • Iters: ${item.iterations ?? '—'}</small>
                        </div>
                        <button onclick="loadBacktestResultFile('${symbol}', '${item.file}')" style="background:#2563eb; border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:0.8em;">Load</button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error('Failed to load history:', e);
        }
    }

    async function loadBacktestResultFile(symbol, file) {
        try {
            const resp = await fetch(`/api/ml/progressive/backtest/result_by_file/${symbol}/${file}`);
            if (!resp.ok) return;
            const data = await resp.json();
            if (data && data.status === 'success' && data.results) {
                await displayBacktestResults(data.results);
            }
        } catch (e) {
            console.error('Failed to load result file:', e);
        }
    }

    function openBacktestExplainer() {
        const modal = document.getElementById('backtest-explainer-modal');
        if (modal) modal.style.display = 'block';
    }
    function closeBacktestExplainer() {
        const modal = document.getElementById('backtest-explainer-modal');
        if (modal) modal.style.display = 'none';
    }

    function createBacktestChart(results) {
        const ctx = document.getElementById('backtest-chart').getContext('2d');

        // Destroy existing chart if any
        if (backtestChart) {
            backtestChart.destroy();
        }

    const iterations = results.all_iterations.map(iter => `Iter ${iter.iteration ?? '?'}`);
    const accuracies = results.all_iterations.map(iter => typeof iter.accuracy === 'number' ? iter.accuracy * 100 : 0);
    const losses = results.all_iterations.map(iter => typeof iter.val_loss === 'number' ? iter.val_loss : 0);

        backtestChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: iterations,
                datasets: [
                    {
                        label: 'Accuracy (%)',
                        data: accuracies,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y',
                        tension: 0.3
                    },
                    {
                        label: 'Loss',
                        data: losses,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Backtest Performance Over Iterations',
                        color: '#e2e8f0'
                    },
                    legend: {
                        labels: {
                            color: '#e2e8f0'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#e2e8f0' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Accuracy (%)',
                            color: '#e2e8f0'
                        },
                        ticks: { color: '#e2e8f0' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Loss',
                            color: '#e2e8f0'
                        },
                        ticks: { color: '#e2e8f0' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function displayPlanAndPreflight(obj) {
        try {
            const card = document.getElementById('backtest-plan-card');
            const badge = document.getElementById('backtest-preflight-badge');
            const content = document.getElementById('backtest-plan-content');
            if (!card || !content) return;
            const pf = obj.preflight || {};
            const plan = obj.plan || pf.plan || {};
            const adjusted = obj.adjusted ? 'Yes' : 'No';
            const last = pf.last_data_date || '-';
            const tpd = pf.test_period_days || plan.test_period_days || '-';
            const req = pf.requested_max_iterations || plan.requested_iterations || '-';
            const feasible = pf.feasible_max_iterations !== undefined ? pf.feasible_max_iterations : '-';
            const lines = [
                plan.train_start_date ? `Train: ${plan.train_start_date} → ${plan.train_end_date}` : (obj.train_start_date && obj.train_end_date ? `Train: ${obj.train_start_date} → ${obj.train_end_date}` : ''),
                `Test window: ${tpd} days • Requested iters: ${req} • Feasible: ${feasible}`,
                `Last data: ${last}`,
                obj.note ? obj.note : ''
            ].filter(Boolean);

            // Render brief scout info if available
            try {
                const scout = obj.scout || (obj.result && obj.result.scout) || null;
                if (scout && scout.chosen) {
                    const ch = scout.chosen;
                    lines.push(`Chosen config → Window ${ch.window_days}d • Seq ${ch.sequence_length} • Profile ${ch.profile} • Fwd Acc ${(ch.accuracy*100).toFixed(1)}% • N=${ch.predictions}`);
                }
            } catch (e) {}

            content.innerHTML = lines.join('<br>');
            badge.textContent = 'Planned';
            card.style.display = 'block';
        } catch (e) { console.warn('displayPlanAndPreflight failed', e); }
    }

    function displayChampion(champion) {
        try {
            const card = document.getElementById('backtest-champion-card');
            const content = document.getElementById('backtest-champion-content');
            if (!card || !content) return;
            const meta = champion.meta || {};
            const bestIter = meta.best_iteration || '-';
            const acc = meta.summary?.best_accuracy !== undefined ? (meta.summary.best_accuracy * 100).toFixed(1) + '%' : 'N/A';
            const dir = champion.dir || champion.path || champion;
            content.innerHTML = `Best Iteration: <strong>${bestIter}</strong> • Best Accuracy: <strong>${acc}</strong><br>Path: <code style="font-size:0.85em;">${dir}</code>`;
            card.style.display = 'block';
        } catch (e) { console.warn('displayChampion failed', e); }
    }

    async function runChampionForwardTest() {
        try {
            const symbol = document.getElementById('progressive-symbol').value.toUpperCase();
            const resp = await fetch(`/api/ml/progressive/champion/forward_test/${symbol}`, { method: 'POST' });
            const data = await resp.json();
            if (!resp.ok) throw new Error(typeof data?.detail === 'string' ? data.detail : JSON.stringify(data));
            const box = document.getElementById('backtest-forward-results');
            const m = data.metrics || {};
            const acc = typeof m.direction_accuracy === 'number' ? (m.direction_accuracy * 100).toFixed(1) + '%' : (typeof m.accuracy === 'number' ? (m.accuracy * 100).toFixed(1) + '%' : 'N/A');
            const mae = m.mae !== undefined && m.mae !== null ? m.mae.toFixed(4) : 'N/A';
            const rmse = m.rmse !== undefined && m.rmse !== null ? m.rmse.toFixed(4) : 'N/A';
            const mape = m.mape !== undefined && m.mape !== null ? m.mape.toFixed(2) + '%' : 'N/A';
            const n = m.predictions_made ?? m.test_samples ?? '-';
            box.innerHTML = `Forward ${data.forward_start} → ${data.forward_end}: Accuracy ${acc}, MAE ${mae}, RMSE ${rmse}, MAPE ${mape}, N=${n}`;
            document.getElementById('backtest-champion-card').style.display = 'block';
        } catch (e) {
            alert('Forward test failed: ' + e.message);
        }
    }

    // ============================================
    // Settings Manager
    // ============================================
    
    class SettingsManager {
        constructor() {
            this.storageKey = 'marketpulse_settings';
            this.defaults = {
                // Update Settings
                updateInterval: 30,
                autoRefresh: true,
                enableWebSocket: true,
                
                // Display Settings
                darkMode: true,
                compactView: false,
                showCharts: true,
                
                // AI & ML Settings
                enableMLPredictions: true,
                keywordThreshold: 0.3,
                highScoreThreshold: 0.7,
                
                // Hot Stocks Scanner
                hotStocksReturnThreshold: 1.0,
                hotStocksConfidenceThreshold: 0.55,
                hotStocksLimit: 5,
                hotStocksAutoRefresh: true,
                
                // Progressive ML Training
                trainingEpochs: 100,
                trainingBatchSize: 32,
                trainingSequenceLength: 60,
                trainingLearningRate: 0.001,
                
                // Notification Settings
                enableNotifications: false,
                maxArticles: 50,
                
                // Debug
                debugMode: false
            };
            
            this.settings = this.loadSettings();
        }
        
        loadSettings() {
            try {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    return { ...this.defaults, ...JSON.parse(stored) };
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            return { ...this.defaults };
        }
        
        saveSettings() {
            try {
                // Collect all settings from form
                const settings = {};
                
                for (const key in this.defaults) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            settings[key] = element.checked;
                        } else if (element.type === 'number') {
                            settings[key] = parseFloat(element.value);
                        } else {
                            settings[key] = element.value;
                        }
                    }
                }
                
                this.settings = settings;
                localStorage.setItem(this.storageKey, JSON.stringify(settings));
                
                alert('✅ Settings saved successfully!');
                console.log('💾 Settings saved:', settings);
                
                // Apply settings immediately
                this.applySettings();
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('❌ Error saving settings');
            }
        }
        
        resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                this.settings = { ...this.defaults };
                localStorage.removeItem(this.storageKey);
                this.applySettingsToForm();
                alert('✅ Settings reset to defaults');
                console.log('🔄 Settings reset');
            }
        }
        
        applySettingsToForm() {
            for (const key in this.settings) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = this.settings[key];
                    } else {
                        element.value = this.settings[key];
                    }
                }
            }
        }
        
        applySettings() {
            // Apply auto-refresh interval
            if (window.marketDataManager && this.settings.autoRefresh) {
                window.marketDataManager.startPeriodicUpdates(this.settings.updateInterval * 1000);
            }
            
            // Apply other settings as needed
            console.log('⚙️ Settings applied');
        }
        
        exportSettings() {
            const dataStr = JSON.stringify(this.settings, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'marketpulse_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('📥 Settings exported');
        }
        
        getSetting(key) {
            return this.settings[key] !== undefined ? this.settings[key] : this.defaults[key];
        }
    }
    
    // Settings import handler (replaces legacy main.js handler)
    function handleSettingsImport(input) {
        try {
            const file = input && input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    // Persist and apply
                    localStorage.setItem('marketpulse_settings', JSON.stringify(settings));
                    if (window.settingsManager && typeof window.settingsManager.applySettingsToForm === 'function') {
                        window.settingsManager.settings = settings;
                        window.settingsManager.applySettingsToForm();
                    }
                    alert('✅ Settings imported successfully');
                } catch (err) {
                    console.error('Error importing settings:', err);
                    alert('❌ Invalid settings file');
                }
            };
            reader.readAsText(file);
        } catch (err) {
            console.error('Error handling settings import:', err);
        }
    }

    // Initialize settings manager
    window.settingsManager = new SettingsManager();

    // Initialize Market Data Manager
    let marketDataManager;
    
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Initializing Market Data Manager...');
        
        // Apply settings to form
        window.settingsManager.applySettingsToForm();
        
        if (typeof MarketDataManager !== 'undefined') {
            marketDataManager = new MarketDataManager();
            window.marketDataManager = marketDataManager; // Make it globally accessible
            await marketDataManager.init();
            
            // Update market intelligence
            await marketDataManager.updateMarketIntelligence();
            await marketDataManager.updateGeopoliticalRisks();
            
            // Start periodic updates (using settings)
            const interval = window.settingsManager.getSetting('updateInterval') * 1000;
            if (window.settingsManager.getSetting('autoRefresh')) {
                marketDataManager.startPeriodicUpdates(interval);
            }
            
            console.log('✅ Market Data Manager ready and running');
        } else {
            console.error('❌ MarketDataManager not loaded - check market-data.js');
        }
    });

    // Realtime WebSocket controls and status
    (function setupWebSocketControls() {
        // Ensure WebSocketClient is available
        if (typeof WebSocketClient === 'undefined') {
            console.warn('⚠️ WebSocketClient not loaded');
            return;
        }

        // Create client instance (not connected by default)
        const ws = new WebSocketClient();
        ws.init();
        window.wsClient = ws;

        const btn = document.getElementById('realtime-btn');
        const badge = document.getElementById('ws-status-badge');
        const stockInput = document.getElementById('ai-stock-input');

        function currentSymbol() {
            const v = (stockInput?.value || '').trim().toUpperCase();
            return v || 'AAPL';
        }

        function updateButton(isOn) {
            if (!btn) return;
            if (isOn) {
                btn.textContent = '🔴 Live Streaming ON';
                btn.classList.add('on');
            } else {
                btn.textContent = '⚪ Enable Real-time';
                btn.classList.remove('on');
            }
        }

        function updateBadge() {
            if (!badge) return;
            const s = ws.getStatus();
            const parts = [];
            if (s.alerts) parts.push('Alerts ✓'); else parts.push('Alerts —');
            if (s.market) parts.push(`Market ${s.currentSymbol}${s.market ? ' ✓' : ' —'}`);
            // aiAnalysis is disabled

            badge.classList.remove('ws-off','ws-warn','ws-on');
            if (s.connected && s.alerts && s.market) {
                badge.classList.add('ws-on');
            } else if (s.connected && (s.alerts || s.market)) {
                badge.classList.add('ws-warn');
            } else {
                badge.classList.add('ws-off');
            }
            badge.textContent = s.connected ? `WS: ${parts.join(' · ')}` : 'WS: OFF';
        }

        if (btn) {
            btn.addEventListener('click', () => {
                if (ws.isConnected) {
                    ws.disconnect();
                    updateButton(false);
                    updateBadge();
                } else {
                    ws.connect(currentSymbol());
                    updateButton(true);
                    // Allow a brief delay for sockets to open before reflecting
                    setTimeout(updateBadge, 500);
                }
            });
        }

        // When user changes the stock symbol, update WS subscription (if connected)
        if (stockInput) {
            stockInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && ws.isConnected) {
                    ws.changeSymbol(currentSymbol());
                    setTimeout(updateBadge, 250);
                }
            });
            stockInput.addEventListener('blur', () => {
                if (ws.isConnected) {
                    ws.changeSymbol(currentSymbol());
                    setTimeout(updateBadge, 250);
                }
            });
        }

        // Periodically refresh badge
        setInterval(updateBadge, 1500);
        // Initial paint
        updateButton(false);
        updateBadge();
    })();

    </script>
</body>
</html>